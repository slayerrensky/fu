{"url":"https://api.github.com/repos/owncloud/core/issues/6553","labels_url":"https://api.github.com/repos/owncloud/core/issues/6553/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/6553/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/6553/events","html_url":"https://github.com/owncloud/core/issues/6553","id":24685352,"number":6553,"title":"owncloud uses statements in oc_file_map with like that are slow as hell","user":{"login":"windaishi","id":6232639,"avatar_url":"https://gravatar.com/avatar/fa29e534948f57127f39d7462d8eaeaf?d=https%3a%2f%2fidenticons.github.com%2f09237aef47c831d7ea09114195c20969.png&r=x","gravatar_id":"fa29e534948f57127f39d7462d8eaeaf","url":"https://api.github.com/users/windaishi","html_url":"https://github.com/windaishi","followers_url":"https://api.github.com/users/windaishi/followers","following_url":"https://api.github.com/users/windaishi/following{/other_user}","gists_url":"https://api.github.com/users/windaishi/gists{/gist_id}","starred_url":"https://api.github.com/users/windaishi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/windaishi/subscriptions","organizations_url":"https://api.github.com/users/windaishi/orgs","repos_url":"https://api.github.com/users/windaishi/repos","events_url":"https://api.github.com/users/windaishi/events{/privacy}","received_events_url":"https://api.github.com/users/windaishi/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"open","assignee":null,"milestone":null,"comments":3,"created_at":"2013-12-22t18:25:04z","updated_at":"2013-12-23t12:28:11z","closed_at":null,"pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### circumstances\r\ni synced about 178 gb of data in 58,015 files in 5,170 directories.\r\nthe client tries to sync some file (actually some files that are synced already) but the speed is terribly slow. 11 files in about 1h.\r\n\r\noc_file_map has about 270,000 entries\r\n\r\n### actual behaviour\r\nwhen my client is syncing, owncloud executes queries that look like that:\r\n\r\n```\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/mask/music from the lord of the rings- the trilogy disc 3/folder.jpg%';\r\n```\r\n\r\nthey are slow as all, this query took about 45 seconds. see the log for more examples.\r\n\r\n### server configuration\r\noperating system: windows server 2003\r\n\r\nweb server: apache/2.2.26\r\n\r\ndatabase: mysql 5.5.25\r\n\r\nphp version: 5.4.22\r\n\r\nowncloud version: owncloud 6.0.0a (stable)\r\n\r\nupdated from an older owncloud or fresh install: fresh install\r\n\r\nlist of activated app:\r\nactivity\r\ncalendar\r\ncontacts\r\ndeleted files\r\ndocuments\r\nfirst run wizard\r\nfull text search\r\nowncloud dependencies info\r\npdf viewer\r\npictures\r\nshare files\r\ntext editor\r\nupdater\r\nversions\r\n\r\n\r\nthe content of config/config.php: (without the database password and passwordsalt)\r\n\r\nare you using external storage, if yes which one: no\r\n\r\n### client configuration\r\nbrowser: n/a\r\n\r\noperating system: windows 7 x64\r\n\r\nsync client: 1.5\r\n\r\n### logs\r\n\r\n#### mysql slow query log:\r\n```\r\nc:\\programme\\mysql\\mysql server 5.5\\bin\\mysqld, version: 5.5.25-log (mysql community server (gpl)). started with:\r\ntcp port: 3306, named pipe: (null)\r\ntime                 id command    argument\r\n# time: 131222 18:58:36\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 49.562500  lock_time: 0.000000 rows_sent: 0  rows_examined: 255456\r\nuse owncloud;\r\nset timestamp=1387735116;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/mask/music from the lord of the rings- the trilogy disc 3/folder.jpg%';\r\n# time: 131222 18:59:24\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 47.937500  lock_time: 0.000000 rows_sent: 0  rows_examined: 255456\r\nset timestamp=1387735164;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/mask/music from the lord of the rings- the trilogy disc 3/folder.jpg.part%';\r\n# time: 131222 19:00:14\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 50.187500  lock_time: 0.000000 rows_sent: 0  rows_examined: 255456\r\nset timestamp=1387735214;\r\ndelete from `oc_file_map` where `physic_path` like 'e:\\\\owncloud/admin/files/musik/mask/music-from-the-lord-of-the-rings-the-trilogy-disc-3/folder.jpg.part%';\r\n# time: 131222 19:01:11\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 49.984375  lock_time: 0.000000 rows_sent: 0  rows_examined: 255462\r\nset timestamp=1387735271;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/snoop dogg/ego trippin\\'/albumartsmall.jpg%';\r\n# time: 131222 19:01:59\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 47.515625  lock_time: 0.000000 rows_sent: 0  rows_examined: 255462\r\nset timestamp=1387735319;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/snoop dogg/ego trippin\\'/albumartsmall.jpg.part%';\r\n# time: 131222 19:02:47\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 48.546875  lock_time: 0.000000 rows_sent: 0  rows_examined: 255462\r\nset timestamp=1387735367;\r\ndelete from `oc_file_map` where `physic_path` like 'e:\\\\owncloud/admin/files/musik/snoop-dogg/ego-trippin/albumartsmall.jpg.part%';\r\n# time: 131222 19:03:43\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 49.562500  lock_time: 0.000000 rows_sent: 0  rows_examined: 255468\r\nset timestamp=1387735423;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/bullet for my valentine/the poison digipak/folder.jpg%';\r\n# time: 131222 19:04:31\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 47.640625  lock_time: 0.000000 rows_sent: 0  rows_examined: 255468\r\nset timestamp=1387735471;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/bullet for my valentine/the poison digipak/folder.jpg.part%';\r\n# time: 131222 19:05:20\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 48.593750  lock_time: 0.015625 rows_sent: 0  rows_examined: 255468\r\nset timestamp=1387735520;\r\ndelete from `oc_file_map` where `physic_path` like 'e:\\\\owncloud/admin/files/musik/bullet-for-my-valentine/the-poison-digipak/folder.jpg.part%';\r\n# time: 131222 19:06:18\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 51.328125  lock_time: 0.000000 rows_sent: 0  rows_examined: 255474\r\nset timestamp=1387735578;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/j.b.o/rosa armee fraktion/albumartsmall.jpg%';\r\n# time: 131222 19:07:06\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 48.156250  lock_time: 0.000000 rows_sent: 0  rows_examined: 255474\r\nset timestamp=1387735626;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/j.b.o/rosa armee fraktion/albumartsmall.jpg.part%';\r\n# time: 131222 19:07:55\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 48.484375  lock_time: 0.000000 rows_sent: 0  rows_examined: 255474\r\nset timestamp=1387735675;\r\ndelete from `oc_file_map` where `physic_path` like 'e:\\\\owncloud/admin/files/musik/j.b.o/rosa-armee-fraktion/albumartsmall.jpg.part%';\r\n# time: 131222 19:08:51\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 4.656250  lock_time: 0.000000 rows_sent: 0  rows_examined: 61774\r\nset timestamp=1387735731;\r\nselect `path` from `oc_filecache` where `storage` = '1' and `size` = -1 order by `fileid` desc limit 1;\r\n# time: 131222 19:09:14\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 72.421875  lock_time: 0.000000 rows_sent: 0  rows_examined: 255480\r\nset timestamp=1387735754;\r\nselect * from `oc_file_map` where `logic_path` like 'e:\\\\owncloud/admin/files/musik/bad religion/no substance/albumartsmall.jpg%';\r\n# time: 131222 19:10:03\r\n# user@host: oc_admin[oc_admin] @ localhost [127.0.0.1]\r\n# query_time: 48.921875  lock_time: 0.000000 rows_sent: 0  rows_examined: 255496\r\n```","closed_by":null}