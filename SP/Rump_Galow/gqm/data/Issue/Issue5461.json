{"url":"https://api.github.com/repos/owncloud/core/issues/5461","labels_url":"https://api.github.com/repos/owncloud/core/issues/5461/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5461/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5461/events","html_url":"https://github.com/owncloud/core/issues/5461","id":21353285,"number":5461,"title":"picture / gallery app infinite loop upon file sync","user":{"login":"jimc-leones","id":5742035,"avatar_url":"https://gravatar.com/avatar/bd585d6e48aea444cdc517003e57388a?d=https%3a%2f%2fidenticons.github.com%2f9f7f12be6887ba110ce4e14578ec6c76.png&r=x","gravatar_id":"bd585d6e48aea444cdc517003e57388a","url":"https://api.github.com/users/jimc-leones","html_url":"https://github.com/jimc-leones","followers_url":"https://api.github.com/users/jimc-leones/followers","following_url":"https://api.github.com/users/jimc-leones/following{/other_user}","gists_url":"https://api.github.com/users/jimc-leones/gists{/gist_id}","starred_url":"https://api.github.com/users/jimc-leones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimc-leones/subscriptions","organizations_url":"https://api.github.com/users/jimc-leones/orgs","repos_url":"https://api.github.com/users/jimc-leones/repos","events_url":"https://api.github.com/users/jimc-leones/events{/privacy}","received_events_url":"https://api.github.com/users/jimc-leones/received_events","type":"user","site_admin":false},"labels":[],"state":"closed","assignee":null,"milestone":null,"comments":4,"created_at":"2013-10-22t00:03:49z","updated_at":"2013-11-10t10:55:13z","closed_at":"2013-11-08t15:53:25z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"versions:\r\nowncloud 5.0.12_20131017 from obs://build.opensuse.org/isv:owncloud \r\n    built 2013-10-16 09:47:12 -0700, \r\n    suse package owncloud-5.0.12_20131017-1.8.noarch\r\nwith linux desktop client owncloud-client-1.4.0-3.1.x86_64\r\nhosted by apache2-2.2.22-10.8.1.x86_64 (prefork)\r\n    apache2-mod_php5-5.3.17-3.4.1.x86_64\r\nkernel-desktop-3.7.10-1.16.1.x86_64\r\nopensuse 12.3\r\nthe client and the server happen to be on the same host (x86_64) although\r\n    the client refers to the server by its wild-side name (not localhost).  \r\n\r\nsymptom: the desktop client is running.  there is a file in the user's \r\n~/owncloud directory which the client syncs.  the user writes on the file\r\n(with an editor), altering it.  within seconds the desktop client shows\r\nits \"sync in progress\" icon in the notification area.  many times the \r\nsync occurs normally and the file arrives byte for byte identical on the\r\nserver with the same name as on the client, and old versions are saved\r\nas documented.  with normal log levels, nothing is logged at either end.  \r\n\r\nsometimes (more than 10%, less than 50%) one of the httpd (apache) threads\r\nuses 100% of one core for a considerable time.  /proc/$pid/fd reveals that\r\nit has /home/owncloud/owncloud.db open.  strace shows what it's doing: \r\nlet $j = /home/owncloud/jimc and $o = /home/owncloud .\r\n\tstat $j/gallery/. (enoent) and $j/gallery/..square (enoent)\r\n\taccess $o/owncloud.db-journal (enoent)\r\n\tseek in fd 34, read something binary.  likely $o/owncloud.db\r\n\taccess $o/owncloud.db-wal (enoent)\r\n\tfcntl 34, rdlck and unlck (didn't read in between these fcntls)\r\n\taccess $o/owncloud.db-journal (enoent) again.  \r\n\t\"sort -u\" shows no other activity beyond this, except it does \"brk\"\r\n\trepeatedly indicating that it is filling up memory and will\r\n\teventually die when it runs out.  confirmed, $o/owncloud.log says\r\n\t{\"app\":\"php\",\"message\":\"allowed memory size of 536870912 bytes \r\n\texhausted (tried to allocate 523800 bytes) at \r\n\t\\/srv\\/www\\/htdocs\\/owncloud\\/lib\\/db.php#412\",\"level\":4,\r\n\t\"time\":\"2013-10-19t04:36:21+00:00\"}\r\n\r\ni will attach a generous subset of the 80737 line strace output if the tracker ui will let me attach text/plain as an \"image\".\r\n\r\nif i let it run until it exceeds its memory limit, the client reports\r\n\"sync failed, unknown error\" and a similar message is logged in \r\n$o/owncloud.log .  if i kill the apache thread right away, all the times\r\ni tried that, the client reported syncing successfully and the new payload\r\narrived undamaged.  (i don't have enough repetitions to claim that it is\r\nalways successful.)  \r\n\r\nthe client logs nothing at all in --logfile/--logdir  when it syncs and claims to have succeeded.  i changed the server log level to debug.  when i provoked the bug, nothing at all (really!) was written to owncloud.log, though seemingly irrelevent messages were written two minutes earlier unrelated to a sync operation.  i'll also try to include the log file;it's short.\r\n\r\nsince my package appears to be based on git only four days ago, i did not try\r\nto learn how to use git and download an up to the minute version of the software.\r\n\r\ninterventions:  my storage had no photos.  i uploaded one (jpeg), and it was \r\nindexed in the pictures (gallery) tab of the web gui.  the very next time i \r\naltered the test file, it set off the infinite loop.  \r\n\r\nso i disabled the pictures app.  again, beating on the syncer.  24 times i \r\nappended a line to the test file, it synced, reporting success, and the content\r\non the server was byte for byte identical to the local copy.  the infinite loop\r\nnever appeared.  so that's a workaround, in the sense that amputating\r\nsomeone's head is a workaround for brain cancer.\r\n\r\n","closed_by":{"login":"pvince81","id":277525,"avatar_url":"https://gravatar.com/avatar/e446b529679416eb70eafb4ca4da5bbe?d=https%3a%2f%2fidenticons.github.com%2f89d7c394e6dcdf87a91c75ac3b2ccbe8.png&r=x","gravatar_id":"e446b529679416eb70eafb4ca4da5bbe","url":"https://api.github.com/users/pvince81","html_url":"https://github.com/pvince81","followers_url":"https://api.github.com/users/pvince81/followers","following_url":"https://api.github.com/users/pvince81/following{/other_user}","gists_url":"https://api.github.com/users/pvince81/gists{/gist_id}","starred_url":"https://api.github.com/users/pvince81/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pvince81/subscriptions","organizations_url":"https://api.github.com/users/pvince81/orgs","repos_url":"https://api.github.com/users/pvince81/repos","events_url":"https://api.github.com/users/pvince81/events{/privacy}","received_events_url":"https://api.github.com/users/pvince81/received_events","type":"user","site_admin":false}}