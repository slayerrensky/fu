{"url":"https://api.github.com/repos/owncloud/core/issues/3369","labels_url":"https://api.github.com/repos/owncloud/core/issues/3369/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/3369/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/3369/events","html_url":"https://github.com/owncloud/core/issues/3369","id":14357274,"number":3369,"title":"fixed: duplicate db entries in filecache table when renaming folder in webui","user":{"login":"roha4000","id":3509963,"avatar_url":"https://gravatar.com/avatar/95b8e2447ddfb0836c2c4ad8489b9ab2?d=https%3a%2f%2fidenticons.github.com%2f8c94cd35b69d168f0351fdb3c2eae3d7.png&r=x","gravatar_id":"95b8e2447ddfb0836c2c4ad8489b9ab2","url":"https://api.github.com/users/roha4000","html_url":"https://github.com/roha4000","followers_url":"https://api.github.com/users/roha4000/followers","following_url":"https://api.github.com/users/roha4000/following{/other_user}","gists_url":"https://api.github.com/users/roha4000/gists{/gist_id}","starred_url":"https://api.github.com/users/roha4000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roha4000/subscriptions","organizations_url":"https://api.github.com/users/roha4000/orgs","repos_url":"https://api.github.com/users/roha4000/repos","events_url":"https://api.github.com/users/roha4000/events{/privacy}","received_events_url":"https://api.github.com/users/roha4000/received_events","type":"user","site_admin":false},"labels":[],"state":"closed","assignee":null,"milestone":null,"comments":1,"created_at":"2013-05-15t13:03:20z","updated_at":"2013-05-15t13:06:58z","closed_at":"2013-05-15t13:06:58z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"we noticed several duplicated entries in the webinterfaces for a lot of our users while there was only one folder in the filesystem. i investigated the filecache table and noticed, that there where a lot of entries with a false path.\r\n\r\nhere an example: the first row is the correct entry and the second has a wrong path component foo which does not exist in this users storage path.\r\n```\r\n*************************** 1. row ***************************\r\n  fileid: 8098951\r\n  storage: 75\r\n  path: files/clientsync/test/test.txt\r\n  path_hash: 4c0c2d21adb3e3cd929adf2eac0cff80\r\n  parent: 8096041\r\n  name: test.txt\r\n  mimetype: 22\r\n  mimepart: 14\r\n  size: 28636\r\n  mtime: 1368025446\r\n  encrypted: 0\r\n  etag: 5190ab7b19a2c\r\n\r\n*************************** 2. row ***************************\r\n   fileid: 1892546\r\n   storage: 75\r\n   path: files/foo/test/test.txt\r\n   path_hash: db5194196cd61b1c0b9d20e192c9c8e7\r\n   parent: 1892541\r\n   name: test.txt\r\n   mimetype: 22\r\n   mimepart: 14\r\n   size: 28636\r\n   mtime: 1368025446\r\n   encrypted: 0\r\n   etag: 518a6969a9434 \r\n```\r\n\r\neventually i could reproduce the duplicates when renaming a folder via the webinterface and found the bug in the code. the failure was obviously the missing storage id. to reproduce the bug you need two users having the same folder structure. the folders must contain at least one file. now rename one folder and all filecache entries with the same path will be updated with the new folder name ... regardless of the storage id.\r\n\r\n\r\nbelow a git patch which resolves the problem. \r\n```\r\nfrom ca8fa71f4c222a75c28fd27f3c57bb6654ed3cc5 mon sep 17 00:00:00 2001\r\nfrom: roland hager <roland.hager@tu-berlin.de>\r\ndate: wed, 15 may 2013 11:20:40 +0200\r\nsubject: [patch] modified:   lib/files/cache/cache.php\r\n\r\nfixing update error in filecache table when renaming files. add storage id to the where clause to avoid updating entries of other users.\r\n---\r\n lib/files/cache/cache.php |    4 ++--\r\n 1 file changed, 2 insertions(+), 2 deletions(-)\r\n\r\ndiff --git a/lib/files/cache/cache.php b/lib/files/cache/cache.php\r\nindex d30c5cd..8d45ec0 100644\r\n--- a/lib/files/cache/cache.php\r\n+++ b/lib/files/cache/cache.php\r\n@@ -334,8 +334,8 @@ class cache {\r\n\r\n                if ($sourcedata['mimetype'] === 'httpd/unix-directory') {\r\n                        //find all child entries\r\n-                       $query = \\oc_db::prepare('select `path`, `fileid` from `*prefix*filecache` where `path` like ?');\r\n-                       $result = $query->execute(array($source . '/%'));\r\n+                       $query = \\oc_db::prepare('select `path`, `fileid` from `*prefix*filecache` where `storage` = ? `path` like ?');\r\n+                       $result = $query->execute(array($this->numericid, $source . '/%'));\r\n                        $childentries = $result->fetchall();\r\n                        $sourcelength = strlen($source);\r\n                        $query = \\oc_db::prepare('update `*prefix*filecache` set `path` = ?, `path_hash` = ? where `fileid` = ?');\r\n-- \r\n1.7.9.5\r\n```","closed_by":{"login":"mtgap","id":1097106,"avatar_url":"https://gravatar.com/avatar/454a73ee5feeb428d0c163a48903332c?d=https%3a%2f%2fidenticons.github.com%2f52d29a66f285a1d61125dd69ac0766b2.png&r=x","gravatar_id":"454a73ee5feeb428d0c163a48903332c","url":"https://api.github.com/users/mtgap","html_url":"https://github.com/mtgap","followers_url":"https://api.github.com/users/mtgap/followers","following_url":"https://api.github.com/users/mtgap/following{/other_user}","gists_url":"https://api.github.com/users/mtgap/gists{/gist_id}","starred_url":"https://api.github.com/users/mtgap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mtgap/subscriptions","organizations_url":"https://api.github.com/users/mtgap/orgs","repos_url":"https://api.github.com/users/mtgap/repos","events_url":"https://api.github.com/users/mtgap/events{/privacy}","received_events_url":"https://api.github.com/users/mtgap/received_events","type":"user","site_admin":false}}