{"url":"https://api.github.com/repos/owncloud/core/issues/3345","labels_url":"https://api.github.com/repos/owncloud/core/issues/3345/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/3345/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/3345/events","html_url":"https://github.com/owncloud/core/issues/3345","id":14309154,"number":3345,"title":"file versions not available","user":{"login":"pjt33","id":1963067,"avatar_url":"https://gravatar.com/avatar/ca859527602d213a4478848566868e1e?d=https%3a%2f%2fidenticons.github.com%2f60483823016eb3283d7ea6e20df28882.png&r=x","gravatar_id":"ca859527602d213a4478848566868e1e","url":"https://api.github.com/users/pjt33","html_url":"https://github.com/pjt33","followers_url":"https://api.github.com/users/pjt33/followers","following_url":"https://api.github.com/users/pjt33/following{/other_user}","gists_url":"https://api.github.com/users/pjt33/gists{/gist_id}","starred_url":"https://api.github.com/users/pjt33/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pjt33/subscriptions","organizations_url":"https://api.github.com/users/pjt33/orgs","repos_url":"https://api.github.com/users/pjt33/repos","events_url":"https://api.github.com/users/pjt33/events{/privacy}","received_events_url":"https://api.github.com/users/pjt33/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/app%3afiles_versions","name":"app:files_versions","color":"02d7e1"}],"state":"closed","assignee":null,"milestone":null,"comments":16,"created_at":"2013-05-14t13:20:51z","updated_at":"2013-06-17t13:42:07z","closed_at":"2013-06-17t13:35:48z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\nwhen i have more than one version of a file, i expect to be able to access different versions.\r\n\r\n### actual behaviour\r\nthe versions dropdown always shows \"no other versions available\", even though the data folder contains the old versions.\r\n\r\n### steps to reproduce\r\n1. add a file to a synchronised folder\r\n2. wait a couple of minutes to ensure that version compression doesn't interfere\r\n3. edit the file and wait for it to synchronise\r\n4. open the folder in the web ui, hover over the file, and click on \"versions\" to bring up the dropdown.\r\n\r\n### server configuration\r\noperating system: windows (observed with win server 2008 and win 7), although at least one of the causes appears to be platform-independent\r\nowncloud version: 5.0.3, still present in current master (2b84da9793)\r\n\r\n\r\n### conclusions from debugging\r\n\r\nthe problem is in `apps/files_versions/lib/versions.php` method `getversions`.\r\n\r\n\t\t\t$versions_fileview = new \\oc\\files\\view('/' . $uid . '/files_versions');\r\n\t\t\t$versionsname = $versions_fileview->getlocalfile($filename);\r\n\r\n\t\t\t$versions = array();\r\n\t\t\t// fetch for old versions\r\n\t\t\t$matches = glob(preg_quote($versionsname).'.v*' );\r\n\r\n\t\t\tif ( !$matches ) {\r\n\t\t\t\treturn $versions;\r\n\t\t\t}\r\n\r\nthe first problem appears to be platform-independent: if `$filename` has an extension, `$versionsname` will have that extension; but the files in `files_versions` have been slugged, so if `$filename` is `example.txt` then the files we need the glob to return have names like `example-txt.v1368525034` and don't match the pattern `example.txt.v*`.\r\n\r\nthe second problem may be windows-only: `preg_quote` breaks the pattern, because [glob patterns are not regexes](http://cowburn.info/2010/04/30/glob-patterns/). compare `glob(preg_quote(\"c:\"))` with `glob(\"c:\")` on a windows machine with a c drive: the first returns an empty array, and the second finds `c:`. the correct way to escape is to escape only the characters relevant for globs.\r\n\r\nthis leads to the following patch as a hacky workaround:\r\n\r\n\t@@ -223,11 +223,11 @@ class storage {\r\n\t\tpublic static function getversions($uid, $filename, $count = 0 ) {\r\n\t\t\tif( \\ocp\\config::getsystemvalue('files_versions', storage::defaultenabled)=='true' ) {\r\n\t\t\t\t$versions_fileview = new \\oc\\files\\view('/' . $uid . '/files_versions');\r\n\t-\t\t\t$versionsname = $versions_fileview->getlocalfile($filename);\r\n\t+\t\t\t$versionsname = $versions_fileview->getlocalfile($filename.'.v');\r\n\t\t\t\t\r\n\t\t\t\t$versions = array();\r\n\t\t\t\t// fetch for old versions\r\n\t-\t\t\t$matches = glob(preg_quote($versionsname).'.v*' );\r\n\t+\t\t\t$matches = glob(preg_replace('/[*?{[]/', '[$1]', $versionsname).'*', glob_noescape);\r\n\t \r\n\t\t\t\tif ( !$matches ) {\r\n\t\t\t\t\treturn $versions;\r\n\r\nhowever, i'm not convinced it's a good fix. it seems to me that the proper way to fix this would be to extend the `search` method of `storage` to support hierarchical patterns and then to replace the glob entirely with something along the lines of\r\n\r\n\tlist($storage,) = \\oc\\files\\filesystem::resolvepath('/' . $uid . '/files_versions');\r\n\t$matches = $storage->search('files_versions/'.$filename.'.v');\r\n","closed_by":{"login":"schiesbn","id":1589737,"avatar_url":"https://gravatar.com/avatar/8912b598c7b32dd25b87fd168e0b06b2?d=https%3a%2f%2fidenticons.github.com%2f0a323047dbe8329db30eae8dbe96e55e.png&r=x","gravatar_id":"8912b598c7b32dd25b87fd168e0b06b2","url":"https://api.github.com/users/schiesbn","html_url":"https://github.com/schiesbn","followers_url":"https://api.github.com/users/schiesbn/followers","following_url":"https://api.github.com/users/schiesbn/following{/other_user}","gists_url":"https://api.github.com/users/schiesbn/gists{/gist_id}","starred_url":"https://api.github.com/users/schiesbn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/schiesbn/subscriptions","organizations_url":"https://api.github.com/users/schiesbn/orgs","repos_url":"https://api.github.com/users/schiesbn/repos","events_url":"https://api.github.com/users/schiesbn/events{/privacy}","received_events_url":"https://api.github.com/users/schiesbn/received_events","type":"user","site_admin":false}}