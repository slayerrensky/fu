{"url":"https://api.github.com/repos/owncloud/core/issues/5189","labels_url":"https://api.github.com/repos/owncloud/core/issues/5189/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5189/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5189/events","html_url":"https://github.com/owncloud/core/issues/5189","id":20637950,"number":5189,"title":"syncing files results in 100% cpu apaches processes","user":{"login":"sezuan","id":202755,"avatar_url":"https://gravatar.com/avatar/4c8d5a06caa8d56702901233333273cc?d=https%3a%2f%2fidenticons.github.com%2fd5b808467be0ff49e27d78775a8e7ba5.png&r=x","gravatar_id":"4c8d5a06caa8d56702901233333273cc","url":"https://api.github.com/users/sezuan","html_url":"https://github.com/sezuan","followers_url":"https://api.github.com/users/sezuan/followers","following_url":"https://api.github.com/users/sezuan/following{/other_user}","gists_url":"https://api.github.com/users/sezuan/gists{/gist_id}","starred_url":"https://api.github.com/users/sezuan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sezuan/subscriptions","organizations_url":"https://api.github.com/users/sezuan/orgs","repos_url":"https://api.github.com/users/sezuan/repos","events_url":"https://api.github.com/users/sezuan/events{/privacy}","received_events_url":"https://api.github.com/users/sezuan/received_events","type":"user","site_admin":false},"labels":[],"state":"closed","assignee":null,"milestone":null,"comments":1,"created_at":"2013-10-07t20:46:36z","updated_at":"2013-10-08t20:14:54z","closed_at":"2013-10-08t20:14:28z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\nfiles should be synced with moderate cpu load and it should not fail after upload.\r\n\r\n### actual behaviour\r\nsync fails quite often with high cpu load (server) and the sync fails after the upload.\r\n\r\n### steps to reproduce\r\n1. sync files with owncloud sync client 1.4\r\n\r\ni notices that behaviour the first time after the update to 5.0.12. i'm wondering why it try to access the user table and the ldap cache file few thousand times... till the memory is exhausted :-)\r\n\r\n### some findings\r\n\r\n1. disabling \"versioning\" solves the issue\r\n2. about every second sync fails\r\n3. evertime when it creates the following entries in the queue table:\r\n\r\n\r\n| 7569 | search_lucene | oca\\search_lucene\\hooks | dodeletefile | {\"run\":true,\"path\":\"_versions\\/documents\\/ayd\\/task\\/pending.data.v1381182469\",\"user\":\"<ldap uuid>\"} |\r\n\r\n| 7570 | search_lucene | oca\\search_lucene\\hooks | dodeletefile | {\"run\":true,\"path\":\"_versions\\/documents\\/ayd\\/task\\/undo.data.v1381182469\",\"user\":\"<ldap uuid>\"}    |\r\n\r\n\r\n### server configuration\r\noperating system: ubuntu 12.04.3\r\n\r\nweb server: 2.2.22-1ubuntu1.4\r\n\r\ndatabase: 5.5.32-0ubuntu0.12.04.1\r\n\r\nphp version: 5.3.10-1ubuntu3.8\r\n\r\nowncloud version: 5.0.12\r\n\r\n### client configuration\r\nbrowser: firefox 24\r\n\r\noperating system: ubuntu 12.04.3\r\n\r\n### logs\r\n#### web server error log\r\n```\r\n10.42.0.1 - matthias [07/oct/2013:22:36:44 +0200] \"get /status.php http/1.1\" 200 728 \"-\" \"mozilla/5.0 (linux) mirall/1.4.1\"  \r\n10.42.0.1 - - [07/oct/2013:22:36:44 +0200] \"propfind /remote.php/webdav/documents/ayd http/1.1\" 401 736 \"-\" \"mozilla/5.0 (linux) csyncoc/0.90.2 neon/0.29.6\"  \r\n10.42.0.1 - matthias [07/oct/2013:22:36:44 +0200] \"propfind /remote.php/webdav// http/1.1\" 207 1082 \"-\" \"mozilla/5.0 (linux) mirall/1.4.1\"  \r\n10.42.0.1 - matthias [07/oct/2013:22:36:44 +0200] \"propfind /remote.php/webdav/documents/ayd http/1.1\" 207 2650 \"-\" \"mozilla/5.0 (linux) csyncoc/0.90.2 neon/0.29.6\"  \r\n10.42.0.1 - matthias [07/oct/2013:22:36:45 +0200] \"propfind /remote.php/webdav/documents/ayd/task http/1.1\" 207 2776 \"-\" \"mozilla/5.0 (linux) csyncoc/0.90.2 neon/0.29.6\" \r\n```\r\n```\r\n[mon oct 07 22:36:34 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:37:37 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:38:24 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:39:30 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:40:14 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:41:17 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:42:00 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:42:59 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:46:23 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n[mon oct 07 22:47:07 2013] [error] [client 10.42.0.1] php fatal error:  allowed memory size of 536870912 bytes exhausted (tried to allocate 523800 bytes) in /var/www/lib/db.php on line 366\r\n```\r\n#### owncloud log (data/owncloud.log)\r\n```\r\n<empty>\r\n```\r\n#### strace of insane apache process (thousands of entries.\r\n```\r\nstat(\"/tmp/owncloud-517cd134108f7/\", {st_mode=s_ifdir|0755, st_size=4096, ...}) = 0\r\nstat(\"/tmp/owncloud-517cd134108f7/ldap-user_ldap--c264b86f90dfe892be5b8a343ac325af\", {st_mode=s_ifreg|0644, st_size=8, ...}) = 0\r\ngetcwd(\"/var/www\", 4096)                = 9\r\nlstat(\"/var/www/lib/base.php\", {st_mode=s_ifreg|0644, st_size=28153, ...}) = 0\r\nlstat(\"/var/www/lib\", {st_mode=s_ifdir|0755, st_size=4096, ...}) = 0\r\nlstat(\"/var/www\", {st_mode=s_ifdir|0755, st_size=4096, ...}) = 0\r\nlstat(\"/var\", {st_mode=s_ifdir|0755, st_size=4096, ...}) = 0\r\nopen(\"/var/www/lib/base.php/oquuqt\", o_rdwr|o_creat|o_excl, 0600) = -1 enotdir (not a directory)\r\ngetcwd(\"/var/www\", 4096)                = 9\r\nlstat(\"/tmp\", {st_mode=s_ifdir|s_isvtx|0777, st_size=4096, ...}) = 0\r\nopen(\"/tmp/ajhukh\", o_rdwr|o_creat|o_excl, 0600) = 15\r\nclose(15)                               = 0\r\naccess(\"/tmp/ajhukh\", f_ok)             = 0\r\nunlink(\"/tmp/ajhukh\")                   = 0\r\nstat(\"/tmp/owncloud-517cd134108f7/\", {st_mode=s_ifdir|0755, st_size=4096, ...}) = 0\r\nstat(\"/tmp/owncloud-517cd134108f7/ldap-user_ldap--c264b86f90dfe892be5b8a343ac325af\", {st_mode=s_ifreg|0644, st_size=8, ...}) = 0\r\ngetcwd(\"/var/www\", 4096)                = 9\r\nlstat(\"/var/www/lib/base.php\", {st_mode=s_ifreg|0644, st_size=28153, ...}) = 0\r\n```\r\n\r\n#### loging of the queries in db.php\r\n```\r\noct  7 22:44:33 oc apache2: query: select count(*) from `oc_users` where lower(`uid`) = lower(?) limit 3\r\noct  7 22:44:33  apache2: last message repeated 158 times\r\noct  7 22:44:33 oc rsyslogd-2177: imuxsock begins to drop messages from pid 5252 due to rate-limiting\r\noct  7 22:44:35 oc rsyslogd-2177: imuxsock lost 6672 messages from pid 5285 due to rate-limiting\r\noct  7 22:44:35 oc apache2: query: select count(*) from `oc_users` where lower(`uid`) = lower(?) limit 3\r\noct  7 22:44:35  apache2: last message repeated 199 times\r\n```","closed_by":{"login":"sezuan","id":202755,"avatar_url":"https://gravatar.com/avatar/4c8d5a06caa8d56702901233333273cc?d=https%3a%2f%2fidenticons.github.com%2fd5b808467be0ff49e27d78775a8e7ba5.png&r=x","gravatar_id":"4c8d5a06caa8d56702901233333273cc","url":"https://api.github.com/users/sezuan","html_url":"https://github.com/sezuan","followers_url":"https://api.github.com/users/sezuan/followers","following_url":"https://api.github.com/users/sezuan/following{/other_user}","gists_url":"https://api.github.com/users/sezuan/gists{/gist_id}","starred_url":"https://api.github.com/users/sezuan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sezuan/subscriptions","organizations_url":"https://api.github.com/users/sezuan/orgs","repos_url":"https://api.github.com/users/sezuan/repos","events_url":"https://api.github.com/users/sezuan/events{/privacy}","received_events_url":"https://api.github.com/users/sezuan/received_events","type":"user","site_admin":false}}