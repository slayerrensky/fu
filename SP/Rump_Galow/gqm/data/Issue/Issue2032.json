{"url":"https://api.github.com/repos/owncloud/core/issues/2032","labels_url":"https://api.github.com/repos/owncloud/core/issues/2032/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/2032/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/2032/events","html_url":"https://github.com/owncloud/core/issues/2032","id":11577247,"number":2032,"title":"bad calculation of $quota in apps/files_versions/lib/versions.php","user":{"login":"piezoid","id":3748582,"avatar_url":"https://gravatar.com/avatar/987a6f66cecd92cc801597fb019199de?d=https%3a%2f%2fidenticons.github.com%2f0d22a8fd41653f0a8f1132f2c73e468f.png&r=x","gravatar_id":"987a6f66cecd92cc801597fb019199de","url":"https://api.github.com/users/piezoid","html_url":"https://github.com/piezoid","followers_url":"https://api.github.com/users/piezoid/followers","following_url":"https://api.github.com/users/piezoid/following{/other_user}","gists_url":"https://api.github.com/users/piezoid/gists{/gist_id}","starred_url":"https://api.github.com/users/piezoid/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/piezoid/subscriptions","organizations_url":"https://api.github.com/users/piezoid/orgs","repos_url":"https://api.github.com/users/piezoid/repos","events_url":"https://api.github.com/users/piezoid/events{/privacy}","received_events_url":"https://api.github.com/users/piezoid/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"closed","assignee":null,"milestone":null,"comments":8,"created_at":"2013-03-02t15:15:14z","updated_at":"2013-03-04t16:26:08z","closed_at":"2013-03-04t11:34:20z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\nstop expiring versionned files when \"free\" space > 0.\r\n\r\n### actual behaviour\r\nin `expire()`, `$quota` is miscalculated because the `files` `default_quota` config is `'none'` instead of `null` (as expected by versions.php) in absence of quota. ( it should be an api for that ? )\r\nthen the function loop for ever due to another error in the break condition.\r\n\r\n### steps to reproduce\r\n1. disable quota\r\n2. create a new file\r\n3. modify it twice\r\n\r\n### server configuration\r\nowncloud version:\r\ngit  d3e88e6\r\n\r\n### proposed patch\r\n    diff --git a/apps/files_versions/lib/versions.php b/apps/files_versions/lib/versions.php\r\n    old mode 100644\r\n    new mode 100755\r\n    index 6ee307c..ab7ec12\r\n    --- a/apps/files_versions/lib/versions.php\r\n    +++ b/apps/files_versions/lib/versions.php\r\n    @@ -352,10 +352,10 @@ class storage {\r\n\r\n\t\t\t    // get available disk space for user\r\n\t\t\t    $quota = \\oc_preferences::getvalue($uid, 'files', 'quota');\r\n    -                       if ( $quota === null ) {\r\n    +                       if ( $quota === 'none' ) {\r\n\t\t\t\t    $quota = \\oc_appconfig::getvalue('files', 'default_quota');\r\n\t\t\t    }\r\n    -                       if ( $quota === null ) {\r\n    +                       if ( $quota === 'none' ) {\r\n\t\t\t\t    $quota = \\oc\\files\\filesystem::free_space('/') / count(\\ocp\\user::getusers());\r\n\t\t\t    } else {\r\n\t\t\t\t    $quota = \\ocp\\util::computerfilesize($quota);\r\n","closed_by":{"login":"schiesbn","id":1589737,"avatar_url":"https://gravatar.com/avatar/8912b598c7b32dd25b87fd168e0b06b2?d=https%3a%2f%2fidenticons.github.com%2f0a323047dbe8329db30eae8dbe96e55e.png&r=x","gravatar_id":"8912b598c7b32dd25b87fd168e0b06b2","url":"https://api.github.com/users/schiesbn","html_url":"https://github.com/schiesbn","followers_url":"https://api.github.com/users/schiesbn/followers","following_url":"https://api.github.com/users/schiesbn/following{/other_user}","gists_url":"https://api.github.com/users/schiesbn/gists{/gist_id}","starred_url":"https://api.github.com/users/schiesbn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/schiesbn/subscriptions","organizations_url":"https://api.github.com/users/schiesbn/orgs","repos_url":"https://api.github.com/users/schiesbn/repos","events_url":"https://api.github.com/users/schiesbn/events{/privacy}","received_events_url":"https://api.github.com/users/schiesbn/received_events","type":"user","site_admin":false}}