{"url":"https://api.github.com/repos/owncloud/core/issues/4242","labels_url":"https://api.github.com/repos/owncloud/core/issues/4242/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/4242/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/4242/events","html_url":"https://github.com/owncloud/core/issues/4242","id":17396470,"number":4242,"title":"cron produces a very inefficient db query","user":{"login":"torbennehmer","id":2812067,"avatar_url":"https://gravatar.com/avatar/c573d69cca60fa58d65784f639e9fa17?d=https%3a%2f%2fidenticons.github.com%2f38a3aa5ba58f8c6f512bbdac60a6943a.png&r=x","gravatar_id":"c573d69cca60fa58d65784f639e9fa17","url":"https://api.github.com/users/torbennehmer","html_url":"https://github.com/torbennehmer","followers_url":"https://api.github.com/users/torbennehmer/followers","following_url":"https://api.github.com/users/torbennehmer/following{/other_user}","gists_url":"https://api.github.com/users/torbennehmer/gists{/gist_id}","starred_url":"https://api.github.com/users/torbennehmer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/torbennehmer/subscriptions","organizations_url":"https://api.github.com/users/torbennehmer/orgs","repos_url":"https://api.github.com/users/torbennehmer/repos","events_url":"https://api.github.com/users/torbennehmer/events{/privacy}","received_events_url":"https://api.github.com/users/torbennehmer/received_events","type":"user","site_admin":false},"labels":[],"state":"closed","assignee":null,"milestone":null,"comments":5,"created_at":"2013-07-30t13:45:02z","updated_at":"2013-07-31t09:21:16z","closed_at":"2013-07-31t09:21:16z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"calling the cron job in my current installation takes over 30 seconds to complete, putting mysql under high load. the main reason for it is a single query, which takes up almost all of the time elapsed:\r\n\r\n# time: 130730 15:31:55\r\n# user@host: c1owncloud[c1owncloud] @ localhost []\r\n# query_time: 30.736351  lock_time: 0.000093 rows_sent: 5  rows_examined: 69946225\r\nselect `oc_filecache`.`fileid`, `path`, `oc_storages`.`id` from `oc_filecache` left join `oc_files_antivirus` on `oc_files_antivirus`.`fileid` = `oc_filecache`.`fileid` join `oc_storages` on `oc_storages`.`numeric_id` = `oc_filecache`.`storage` where `mimetype` != '1' and `oc_storages`.`id` like 'local::%' and (`oc_files_antivirus`.`fileid` is null or `mtime` > `check_time`) limit 5;\r\n\r\ni have reduced the cron intervals down to an hour instead of a minute to compensate for the moment.\r\n\r\nnote, that running the cron job seems to leave the files in my temp directory intact. especially a zip file in oc-noclean resulting from a download of a directory in my installation i did one or two days ago. in addition, there are a couple of zips with oc plugins i installed today or yesterday (not sure), which are also still lying around.\r\n\r\nbest regards\r\ntorben nehmer\r\n","closed_by":{"login":"torbennehmer","id":2812067,"avatar_url":"https://gravatar.com/avatar/c573d69cca60fa58d65784f639e9fa17?d=https%3a%2f%2fidenticons.github.com%2f38a3aa5ba58f8c6f512bbdac60a6943a.png&r=x","gravatar_id":"c573d69cca60fa58d65784f639e9fa17","url":"https://api.github.com/users/torbennehmer","html_url":"https://github.com/torbennehmer","followers_url":"https://api.github.com/users/torbennehmer/followers","following_url":"https://api.github.com/users/torbennehmer/following{/other_user}","gists_url":"https://api.github.com/users/torbennehmer/gists{/gist_id}","starred_url":"https://api.github.com/users/torbennehmer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/torbennehmer/subscriptions","organizations_url":"https://api.github.com/users/torbennehmer/orgs","repos_url":"https://api.github.com/users/torbennehmer/repos","events_url":"https://api.github.com/users/torbennehmer/events{/privacy}","received_events_url":"https://api.github.com/users/torbennehmer/received_events","type":"user","site_admin":false}}