{"url":"https://api.github.com/repos/owncloud/core/issues/4809","labels_url":"https://api.github.com/repos/owncloud/core/issues/4809/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/4809/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/4809/events","html_url":"https://github.com/owncloud/core/issues/4809","id":19334552,"number":4809,"title":"upgrade to 5.0.11 failed to update database structure","user":{"login":"strangenoises","id":1295001,"avatar_url":"https://gravatar.com/avatar/a5d6612a9a7da64e0e878d1b3bc04d8a?d=https%3a%2f%2fidenticons.github.com%2f3d85d3be1f7025aa7ef230d575c85d82.png&r=x","gravatar_id":"a5d6612a9a7da64e0e878d1b3bc04d8a","url":"https://api.github.com/users/strangenoises","html_url":"https://github.com/strangenoises","followers_url":"https://api.github.com/users/strangenoises/followers","following_url":"https://api.github.com/users/strangenoises/following{/other_user}","gists_url":"https://api.github.com/users/strangenoises/gists{/gist_id}","starred_url":"https://api.github.com/users/strangenoises/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/strangenoises/subscriptions","organizations_url":"https://api.github.com/users/strangenoises/orgs","repos_url":"https://api.github.com/users/strangenoises/repos","events_url":"https://api.github.com/users/strangenoises/events{/privacy}","received_events_url":"https://api.github.com/users/strangenoises/received_events","type":"user","site_admin":false},"labels":[],"state":"closed","assignee":null,"milestone":null,"comments":4,"created_at":"2013-09-11t17:39:02z","updated_at":"2013-11-29t16:21:35z","closed_at":"2013-11-29t14:05:02z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"reposted but according to bug-reporting template. missed that before, maybe is why being ignored. ;-)\r\n\r\n### expected behaviour\r\nupgrade from 5.0.10 to 5.0.11 should proceed without a hitch.\r\n\r\n### actual behaviour\r\nupgrade fails on updating database structure. on viewing page, i see:\r\n\r\n```\r\nfailed to update database structure (mdb2 error: unknown error, _doquery: [error\r\nmessage: could not execute statement] [last executed query: alter table\r\n`oc_locks` change `id` `id` int unsigned not null auto_increment\r\nprimary key, change `timeout` `timeout` int unsigned default 0,\r\nchange `created` `created` bigint default 0, change `scope` `scope`\r\ntinyint default 0, change `depth` `depth` tinyint default 0] [native code:\r\n1068] [native message: multiple primary key defined] )\r\n```\r\n\r\n### steps to reproduce\r\n1. start with working 5.0.10 setup on ubuntu using mysql as migrated to following this guide religiously: http://fabianpeter.de/cloud/owncloud-migrating-from-sqlite-to-mysql/\r\n2. attempt to upgrade to 5.0.11 (using apt-get upgrade)\r\n3. wonder why the client doesn't reconnect. visit site to see error message.\r\n\r\n### server configuration\r\noperating system: ubuntu 12.04.3 lts\r\n\r\nweb server: apache 2.2.22-1ubuntu1.4 (from ubuntu repo, 'apache2')\r\n\r\ndatabase: mysql 5.5.32-0ubuntu-.12.04.1 (from ubuntu repo, 'mysql-server')\r\n\r\nphp version: 5.3.10-1ubuntu3.8 (from ubunu repo, 'php5')\r\n\r\nowncloud version: problem occurs on upgrade. both versions (taken after reverting back to 5.0.10 to get back a working system)\r\n\r\n```\r\n$ apt-cache-policy owncloud\r\nowncloud:\r\n  installed: 5.0.10-1\r\n  candidate: 5.0.11-0\r\n  version table:\r\n     5.0.11-0 0\r\n        500 http://download.opensuse.org/repositories/isv:owncloud:community/xubuntu_12.04/  packages\r\n *** 5.0.10-1 0\r\n        100 /var/lib/dpkg/status\r\n     3.0.0-0ubuntu1 0\r\n        500 http://de.archive.ubuntu.com/ubuntu/ precise/universe amd64 packages\r\n```\r\n\r\n### client configuration\r\nbrowser: firefox 23.0.1\r\n\r\noperating system: mac os x 10.8.4 and ubuntu linux 13.04\r\n\r\nclient version: 1.4.0\r\n\r\nnone of which i expect is relevant. :-) not a client or web interface problem.\r\n\r\n### logs\r\n#### web server error log\r\ndoubt this is relevant, but here you go:\r\n\r\n```\r\n[sun sep 08 06:35:38 2013] [notice] apache/2.2.22 (ubuntu) php/5.3.10-1ubuntu3.7 with suhosin-patch mod_ssl/2.2.22 openssl/1.0.1 configured -- resuming normal operations\r\n[sun sep 08 08:34:25 2013] [error] [client 5.10.83.34] file does not exist: /var/www/robots.txt\r\n[sun sep 08 09:50:58 2013] [error] [client 68.118.248.62] invalid method in request \\x80w\\x01\\x03\\x01\r\n[sun sep 08 09:50:58 2013] [error] [client 68.118.248.62] file does not exist: /var/www/hnap1, referer: http://88.198.45.142/\r\n[sun sep 08 12:36:03 2013] [error] [client 54.225.209.54] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[sun sep 08 14:52:06 2013] [notice] graceful restart requested, doing restart\r\n[sun sep 08 14:52:07 2013] [notice] apache/2.2.22 (ubuntu) php/5.3.10-1ubuntu3.8 with suhosin-patch mod_ssl/2.2.22 openssl/1.0.1 configured -- resuming normal operations\r\n[sun sep 08 14:53:06 2013] [notice] caught sigterm, shutting down\r\n[sun sep 08 14:55:08 2013] [notice] apache/2.2.22 (ubuntu) php/5.3.10-1ubuntu3.8 with suhosin-patch mod_ssl/2.2.22 openssl/1.0.1 configured -- resuming normal operations\r\n[sun sep 08 14:55:34 2013] [error] [client 85.190.0.3] file does not exist: /var/www/freenode-proxy-checker.txt\r\n[sun sep 08 14:55:34 2013] [error] [client 85.190.0.3] file does not exist: /var/www/freenode-proxy-checker.txt\r\n[sun sep 08 16:25:08 2013] [error] [client 202.190.203.223] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[sun sep 08 16:27:45 2013] [error] [client 8.26.191.44] file does not exist: /var/www/user\r\n[sun sep 08 17:43:40 2013] [error] [client 173.212.201.132] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.dfind:)\r\n[sun sep 08 18:44:14 2013] [error] [client 213.132.75.90] file does not exist: /var/www/admin\r\n[sun sep 08 20:07:24 2013] [error] [client 54.225.209.54] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[mon sep 09 01:53:20 2013] [error] [client 202.190.203.223] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[mon sep 09 02:24:36 2013] [error] [client 111.248.57.84] file does not exist: /var/www/intl\r\n[mon sep 09 03:19:03 2013] [error] [client 54.225.209.54] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[mon sep 09 03:38:13 2013] [error] [client 60.199.197.5] file does not exist: /var/www/w00tw00t.at.blackhats.romanian.anti-sec:)\r\n[mon sep 09 03:38:14 2013] [error] [client 60.199.197.5] file does not exist: /var/www/phpmyadmin\r\n[mon sep 09 03:38:14 2013] [error] [client 60.199.197.5] file does not exist: /var/www/phpmyadmin\r\n[mon sep 09 03:38:15 2013] [error] [client 60.199.197.5] file does not exist: /var/www/pma\r\n[mon sep 09 03:38:15 2013] [error] [client 60.199.197.5] file does not exist: /var/www/myadmin\r\n[mon sep 09 03:38:16 2013] [error] [client 60.199.197.5] file does not exist: /var/www/myadmin\r\n[mon sep 09 11:04:53 2013] [error] [client 54.225.209.54] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[mon sep 09 11:37:00 2013] [error] [client 202.190.203.223] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[mon sep 09 11:52:47 2013] [error] [client 66.249.73.29] file does not exist: /var/www/robots.txt\r\n[mon sep 09 13:56:35 2013] [error] [client 87.197.147.65] file does not exist: /var/www/favicon.ico\r\n[mon sep 09 14:46:09 2013] [error] [client 86.105.36.246] file does not exist: /var/www/admin\r\n[mon sep 09 15:05:37 2013] [error] [client 83.65.190.162] file does not exist: /var/www/favicon.ico\r\n[mon sep 09 15:41:50 2013] [error] [client 66.249.73.175] file does not exist: /var/www/robots.txt\r\n[mon sep 09 18:12:18 2013] [error] [client 85.110.217.104] file does not exist: /var/www/favicon.ico\r\n[mon sep 09 18:32:40 2013] [error] [client 54.225.209.54] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[mon sep 09 19:29:25 2013] [error] [client 142.9.1.100] file does not exist: /var/www/favicon.ico\r\n[mon sep 09 20:51:15 2013] [error] [client 202.190.203.223] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[tue sep 10 01:50:36 2013] [error] [client 54.225.209.54] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[tue sep 10 04:30:20 2013] [error] [client 49.212.200.146] file does not exist: /var/www/phppath\r\n[tue sep 10 06:22:03 2013] [error] [client 146.255.32.95] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.dfind:)\r\n[tue sep 10 06:35:22 2013] [error] [client 202.190.203.223] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[tue sep 10 09:32:20 2013] [error] [client 54.225.209.54] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[tue sep 10 14:36:45 2013] [error] [client 61.228.88.232] file does not exist: /var/www/intl\r\n[tue sep 10 14:49:04 2013] [error] [client 178.115.129.252] file does not exist: /var/www/favicon.ico\r\n[tue sep 10 14:49:04 2013] [error] [client 178.115.129.252] file does not exist: /var/www/apple-touch-icon-precomposed.png\r\n[tue sep 10 14:49:04 2013] [error] [client 178.115.129.252] file does not exist: /var/www/apple-touch-icon.png\r\n[tue sep 10 15:15:18 2013] [error] [client 192.126.136.250] request failed: error reading the headers\r\n[tue sep 10 16:38:59 2013] [error] [client 202.190.203.223] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[tue sep 10 17:32:17 2013] [error] [client 88.198.45.142] client denied by server configuration: /var/www/owncloud/data/htaccesstest.txt\r\n[tue sep 10 17:32:17 2013] [error] [client 88.198.45.142] file does not exist: /var/www/core\r\n[tue sep 10 17:38:03 2013] [error] [client 88.198.45.142] client denied by server configuration: /var/www/owncloud/data/htaccesstest.txt\r\n[tue sep 10 17:38:03 2013] [error] [client 88.198.45.142] file does not exist: /var/www/core\r\n[tue sep 10 17:53:38 2013] [error] [client 88.198.45.142] client denied by server configuration: /var/www/owncloud/data/htaccesstest.txt\r\n[tue sep 10 17:53:38 2013] [error] [client 88.198.45.142] file does not exist: /var/www/core\r\n[tue sep 10 18:00:34 2013] [error] [client 88.198.45.142] client denied by server configuration: /var/www/owncloud/data/htaccesstest.txt\r\n[tue sep 10 18:00:34 2013] [error] [client 88.198.45.142] file does not exist: /var/www/core\r\n[tue sep 10 20:27:48 2013] [error] [client 54.226.13.150] file does not exist: /var/www/spicons\r\n[tue sep 10 21:30:52 2013] [notice] caught sigterm, shutting down\r\n[tue sep 10 21:30:54 2013] [notice] apache/2.2.22 (ubuntu) php/5.3.10-1ubuntu3.8 with suhosin-patch mod_ssl/2.2.22 openssl/1.0.1 configured -- resuming normal operations\r\n[tue sep 10 21:31:50 2013] [error] [client 85.190.0.3] file does not exist: /var/www/freenode-proxy-checker.txt\r\n[tue sep 10 21:31:50 2013] [error] [client 85.190.0.3] file does not exist: /var/www/freenode-proxy-checker.txt\r\n[wed sep 11 00:39:23 2013] [error] [client 190.64.4.194] file does not exist: /var/www/phppath\r\n[wed sep 11 02:16:12 2013] [error] [client 202.190.203.223] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[wed sep 11 08:11:34 2013] [error] [client 66.249.73.29] file does not exist: /var/www/robots.txt\r\n[wed sep 11 11:40:24 2013] [error] [client 78.186.179.34] file does not exist: /var/www/favicon.ico\r\n[wed sep 11 12:16:28 2013] [error] [client 202.190.203.223] client sent http/1.1 request without hostname (see rfc2616 section 14.23): /w00tw00t.at.isc.sans.win32:)\r\n[wed sep 11 14:02:17 2013] [error] [client 46.220.116.34] file does not exist: /var/www/favicon.ico\r\n[wed sep 11 14:03:03 2013] [error] [client 46.220.116.34] file does not exist: /var/www/favicon.ico\r\n[wed sep 11 15:14:42 2013] [error] [client 157.55.33.23] file does not exist: /var/www/robots.txt\r\n[wed sep 11 16:01:28 2013] [error] [client 66.249.73.8] file does not exist: /var/www/robots.txt\r\n```\r\n\r\n#### owncloud log (data/owncloud.log)\r\nthe full log is large, and contains filenames of files *in* my owncloud i'd rather keep private, which is why we like owncloud of course ;-). what i paste starts from when i start the upgrade and continues to the end of the log as it stands. the last four lines are from after i reverted to 5.0.10. btw i note the upgrade versions it mentions (5.0.17 to 5.0.20) bear only a passing relation to the version of the actual application!\r\n\r\n```\r\n{\"app\":\"core\",\"message\":\"starting upgrade from 5.0.17 to 5.0.20\",\"level\":2,\"time\":\"2013-09-10t20:31:46+00:00\"}\r\n{\"app\":\"core\",\"message\":\"failed to update database structure (mdb2 error: unknown error, _doquery: [error message: could not execute statement]\\n[last executed query: alter table `oc_locks` change `id` `id` int unsigned not null auto_increment primary key, change `timeout` `timeout` int unsigned default 0, change `created` `created` bigint default 0, change `scope` `scope` tinyint default 0, change `depth` `depth` tinyint default 0]\\n[native code: 1068]\\n[native message: multiple primary key defined]\\n)\",\"level\":4,\"time\":\"2013-09-10t20:31:47+00:00\"}\r\n{\"app\":\"php\",\"message\":\"filesize(): stat failed for \\/var\\/www\\/owncloud\\/data\\/rachel\\/files\\/mlp comics\\/yp-pdf-mscomic08.pdf at \\/var\\/www\\/owncloud\\/lib\\/files\\/storage\\/local.php#74\",\"level\":2,\"time\":\"2013-09-11t07:22:33+00:00\"}\r\n{\"app\":\"php\",\"message\":\"filesize(): stat failed for \\/var\\/www\\/owncloud\\/data\\/rachel\\/files\\/mlp comics\\/yp-pdf-mscomic08.pdf at \\/var\\/www\\/owncloud\\/lib\\/files\\/storage\\/local.php#74\",\"level\":2,\"time\":\"2013-09-11t07:22:33+00:00\"}\r\n{\"app\":\"php\",\"message\":\"only variables should be passed by reference at \\/var\\/www\\/owncloud\\/apps\\/search_lucene\\/lib\\/indexer.php#163\",\"level\":2,\"time\":\"2013-09-11t07:23:01+00:00\"}\r\n{\"app\":\"php\",\"message\":\"cross-reference streams are not supported yet. at \\/var\\/www\\/owncloud\\/apps\\/search_lucene\\/3rdparty\\/zend\\/pdf\\/parser.php#318\",\"level\":4,\"time\":\"2013-09-11t07:23:02+00:00\"}\r\n```\r\n\r\n#### browser log\r\nthis is a server upgrade issue. no browser issues to report, no relevant log to upload. (web interface working fine.)\r\n\r\n#### additional information\r\n\r\n```\r\nmysql> show create table oc_locks gives one row (formatting rules omitted)\r\n| table    | create table\r\noc_locks | create table `oc_locks` (\r\n  `id` int(11) not null auto_increment,\r\n  `userid` varchar(64) default null,\r\n  `owner` varchar(100) default null,\r\n  `timeout` int(10) unsigned default '0',\r\n  `created` bigint(20) default '0',\r\n  `token` varchar(100) default null,\r\n  `scope` smallint(6) default '0',\r\n  `depth` smallint(6) default '0',\r\n  `uri` longtext,\r\n  primary key (`id`)\r\n) engine=innodb default charset=latin1\r\n```","closed_by":{"login":"karlitschek","id":867445,"avatar_url":"https://gravatar.com/avatar/87ce2b4531ee1a0c32b50e0d8f049224?d=https%3a%2f%2fidenticons.github.com%2f06e7098636caebfc9c30c9f52eb905df.png&r=x","gravatar_id":"87ce2b4531ee1a0c32b50e0d8f049224","url":"https://api.github.com/users/karlitschek","html_url":"https://github.com/karlitschek","followers_url":"https://api.github.com/users/karlitschek/followers","following_url":"https://api.github.com/users/karlitschek/following{/other_user}","gists_url":"https://api.github.com/users/karlitschek/gists{/gist_id}","starred_url":"https://api.github.com/users/karlitschek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/karlitschek/subscriptions","organizations_url":"https://api.github.com/users/karlitschek/orgs","repos_url":"https://api.github.com/users/karlitschek/repos","events_url":"https://api.github.com/users/karlitschek/events{/privacy}","received_events_url":"https://api.github.com/users/karlitschek/received_events","type":"user","site_admin":false}}