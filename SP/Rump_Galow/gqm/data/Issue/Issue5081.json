{"url":"https://api.github.com/repos/owncloud/core/issues/5081","labels_url":"https://api.github.com/repos/owncloud/core/issues/5081/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5081/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5081/events","html_url":"https://github.com/owncloud/core/issues/5081","id":20391528,"number":5081,"title":"users can not login using ldap backend under certain circumstances","user":{"login":"sfyang","id":5391250,"avatar_url":"https://gravatar.com/avatar/d4d659d7dcd1109775498e370f6c1b08?d=https%3a%2f%2fidenticons.github.com%2fdfba3418eb43bc6878ee5f9615d5209b.png&r=x","gravatar_id":"d4d659d7dcd1109775498e370f6c1b08","url":"https://api.github.com/users/sfyang","html_url":"https://github.com/sfyang","followers_url":"https://api.github.com/users/sfyang/followers","following_url":"https://api.github.com/users/sfyang/following{/other_user}","gists_url":"https://api.github.com/users/sfyang/gists{/gist_id}","starred_url":"https://api.github.com/users/sfyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfyang/subscriptions","organizations_url":"https://api.github.com/users/sfyang/orgs","repos_url":"https://api.github.com/users/sfyang/repos","events_url":"https://api.github.com/users/sfyang/events{/privacy}","received_events_url":"https://api.github.com/users/sfyang/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/app%3auser_ldap","name":"app:user_ldap","color":"02d7e1"},{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"},{"url":"https://api.github.com/repos/owncloud/core/labels/v5.x","name":"v5.x","color":"ededed"}],"state":"closed","assignee":null,"milestone":null,"comments":3,"created_at":"2013-10-02t12:43:37z","updated_at":"2013-10-18t12:56:13z","closed_at":"2013-10-18t12:56:13z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\nwhen the ldap/ad is configured correctly, users should be able to login with the corresponding credentials.\r\n\r\n### actual behaviour\r\nunder certain system configurations, the login procedure always fails even if the credential is valid.\r\n\r\n### steps to reproduce\r\n0. assume one of the ldap/ad record has a dn as following: <b>dn: cn=sfyang,ou=<i>æÿ?å…¬å?¸</i>,ou=<i>å?°ç?£å?€</i>,dc=example,dc=com,dc=tw</b>\r\n1. activate the ldap backend under settingsâ†’apps.\r\n2. fill in and test the ldap configuration under settingsâ†’admin with the following base dn: <b>ou=<i>æÿ?å…¬å?¸</i>,ou=<i>å?°ç?£å?€</i>,dc=example,dc=com,dc=tw</b>\r\n3. switch to settingsâ†’user to trigger the user list pulling procedure.\r\n4. log out and than log in with the valid credential of \"sfyang\", and the login process always fails.\r\n\r\nthe failing of the login process happens when the dns contain multi-byte characters. this is caused by the missing optional \"encoding\" parameter of one of the <i>mb_strlen()</i> function call in the method implementation of  <b>access::isdnpartofbase()</b> in apps/user_ldap/lib/access.php, which makes the method call incorrectly returning false even if the uid is valid.\r\n\r\n### server configuration\r\noperating system:\r\nubuntu linux 12.04 lts 64bit\r\n\r\nweb server: \r\napache 2.2.22\r\n\r\ndatabase:\r\nmysql 5.5.32\r\n\r\nphp version:\r\nphp 5.3.10\r\n\r\nowncloud version:\r\nowncloud 5.0.11\r\n\r\n### client configuration\r\nbrowser:\r\nfirefox 24.0\r\nsrware iron 29.0.1600\r\n\r\noperating system:\r\nubuntu linux 12.04 lts 64bit\r\n\r\n### logs\r\n#### web server error log\r\nn/a (nothing relevant when login process is failing.)\r\n\r\n#### owncloud log (data/owncloud.log)\r\nn/a (nothing relevant.)\r\n\r\n#### browser log\r\nn/a\r\n\r\n#### possible fix\r\nthe following patch to apps/user_ldap/lib/access.php should fix the problem:\r\n```php\r\n--- access.php.orig     2013-10-02 18:07:15.696064171 +0800\r\n+++ access.php  2013-10-02 18:08:10.716634271 +0800\r\n@@ -1004,7 +1004,7 @@ private function isdnpartofbase($dn, $ba\r\n                $bases = $this->sanitizedn($bases);\r\n                foreach($bases as $base) {\r\n                        $belongstobase = true;\r\n-                       if(mb_strripos($dn, $base, 0, 'utf-8') !== (mb_strlen($dn, 'utf-8')-mb_strlen($base))) {\r\n+                       if(mb_strripos($dn, $base, 0, 'utf-8') !== (mb_strlen($dn, 'utf-8')-mb_strlen($base, 'utf-8'))) {\r\n                                $belongstobase = false;\r\n                        }\r\n                        if($belongstobase) {\r\n```","closed_by":{"login":"sfyang","id":5391250,"avatar_url":"https://gravatar.com/avatar/d4d659d7dcd1109775498e370f6c1b08?d=https%3a%2f%2fidenticons.github.com%2fdfba3418eb43bc6878ee5f9615d5209b.png&r=x","gravatar_id":"d4d659d7dcd1109775498e370f6c1b08","url":"https://api.github.com/users/sfyang","html_url":"https://github.com/sfyang","followers_url":"https://api.github.com/users/sfyang/followers","following_url":"https://api.github.com/users/sfyang/following{/other_user}","gists_url":"https://api.github.com/users/sfyang/gists{/gist_id}","starred_url":"https://api.github.com/users/sfyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfyang/subscriptions","organizations_url":"https://api.github.com/users/sfyang/orgs","repos_url":"https://api.github.com/users/sfyang/repos","events_url":"https://api.github.com/users/sfyang/events{/privacy}","received_events_url":"https://api.github.com/users/sfyang/received_events","type":"user","site_admin":false}}