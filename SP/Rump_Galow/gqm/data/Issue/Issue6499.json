{"url":"https://api.github.com/repos/owncloud/core/issues/6499","labels_url":"https://api.github.com/repos/owncloud/core/issues/6499/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/6499/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/6499/events","html_url":"https://github.com/owncloud/core/issues/6499","id":24507263,"number":6499,"title":"update fails with ms sql server","user":{"login":"uka-support","id":6216577,"avatar_url":"https://gravatar.com/avatar/470418ef62d72845e58db388c5a92b07?d=https%3a%2f%2fidenticons.github.com%2ffd8f0e07ecb6d2c839d8732e4edef14d.png&r=x","gravatar_id":"470418ef62d72845e58db388c5a92b07","url":"https://api.github.com/users/uka-support","html_url":"https://github.com/uka-support","followers_url":"https://api.github.com/users/uka-support/followers","following_url":"https://api.github.com/users/uka-support/following{/other_user}","gists_url":"https://api.github.com/users/uka-support/gists{/gist_id}","starred_url":"https://api.github.com/users/uka-support/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uka-support/subscriptions","organizations_url":"https://api.github.com/users/uka-support/orgs","repos_url":"https://api.github.com/users/uka-support/repos","events_url":"https://api.github.com/users/uka-support/events{/privacy}","received_events_url":"https://api.github.com/users/uka-support/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"},{"url":"https://api.github.com/repos/owncloud/core/labels/db%3amssql","name":"db:mssql","color":"000000"}],"state":"open","assignee":null,"milestone":null,"comments":2,"created_at":"2013-12-18t18:02:08z","updated_at":"2013-12-19t11:51:49z","closed_at":null,"pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"the upgrade fails with the following message (tested with 5.x->6.0 as well as 6.0.0 -> 6.0.0a):\r\n\r\n```\r\nexception occurred while executing 'create table [oc_appconfig] ([appid] nvarchar(32) default '' not null, [configkey] nvarchar(64) default '' not null, [configvalue] varchar(max) null, primary key ([appid], [configkey]))': sqlstate[42s01]: [microsoft][sql server native client 11.0][sql server]in der datenbank ist bereits ein objekt mit dem namen 'oc_appconfig' vorhanden.\r\n```\r\n\r\nthe log says:\r\n\r\n```\r\n{\"app\":\"core\",\"message\":\"failed to update database structure (exception 'pdoexception' with message 'sqlstate[42s01]: [microsoft][sql server native client 11.0][sql server]in der datenbank ist bereits ein objekt mit dem namen 'oc_appconfig' vorhanden.' in c:\\\\inetpub\\\\owncloud\\\\3rdparty\\\\doctrine\\\\dbal\\\\lib\\\\doctrine\\\\dbal\\\\connection.php:742\r\nstack trace:\r\n#0 [internal function]: pdo->query('create table [o...')\r\n#1 c:\\\\inetpub\\\\owncloud\\\\3rdparty\\\\doctrine\\\\dbal\\\\lib\\\\doctrine\\\\dbal\\\\connection.php(742): call_user_func_array(array, array)\r\n#2 c:\\\\inetpub\\\\owncloud\\\\lib\\\\private\\\\db\\\\mdb2schemamanager.php(152): doctrine\\\\dbal\\\\connection->query('create table [o...')\r\n#3 c:\\\\inetpub\\\\owncloud\\\\lib\\\\private\\\\db\\\\mdb2schemamanager.php(91): oc\\\\db\\\\mdb2schemamanager->executeschemachange(object(doctrine\\\\dbal\\\\schema\\\\schemadiff))\r\n#4 c:\\\\inetpub\\\\owncloud\\\\lib\\\\private\\\\db.php(376): oc\\\\db\\\\mdb2schemamanager->updatedbfromstructure('c:\\/inetpub\\/ownc...')\r\n#5 c:\\\\inetpub\\\\owncloud\\\\lib\\\\private\\\\updater.php(106): oc_db::updatedbfromstructure('c:\\/inetpub\\/ownc...')\r\n#6 c:\\\\inetpub\\\\owncloud\\\\core\\\\ajax\\\\update.php(34): oc\\\\updater->upgrade()\r\n#7 {main}\r\n\r\nnext exception 'doctrine\\\\dbal\\\\dbalexception' with message 'an exception occurred while executing 'create table [oc_appconfig] ([appid] nvarchar(32) default '' not null, [configkey] nvarchar(64) default '' not null, [configvalue] varchar(max) null, primary key ([appid], [configkey]))':\r\n\r\nsqlstate[42s01]: [microsoft][sql server native client 11.0][sql server]in der datenbank ist bereits ein objekt mit dem namen 'oc_appconfig' vorhanden.' in c:\\\\inetpub\\\\owncloud\\\\3rdparty\\\\doctrine\\\\dbal\\\\lib\\\\doctrine\\\\dbal\\\\dbalexception.php:47\r\nstack trace:\r\n#0 c:\\\\inetpub\\\\owncloud\\\\3rdparty\\\\doctrine\\\\dbal\\\\lib\\\\doctrine\\\\dbal\\\\connection.php(744): doctrine\\\\dbal\\\\dbalexception::driverexceptionduringquery(object(pdoexception), 'create table [o...')\r\n#1 c:\\\\inetpub\\\\owncloud\\\\lib\\\\private\\\\db\\\\mdb2schemamanager.php(152): doctrine\\\\dbal\\\\connection->query('create table [o...')\r\n#2 c:\\\\inetpub\\\\owncloud\\\\lib\\\\private\\\\db\\\\mdb2schemamanager.php(91): oc\\\\db\\\\mdb2schemamanager->executeschemachange(object(doctrine\\\\dbal\\\\schema\\\\schemadiff))\r\n#3 c:\\\\inetpub\\\\owncloud\\\\lib\\\\private\\\\db.php(376): oc\\\\db\\\\mdb2schemamanager->updatedbfromstructure('c:\\/inetpub\\/ownc...')\r\n#4 c:\\\\inetpub\\\\owncloud\\\\lib\\\\private\\\\updater.php(106): oc_db::updatedbfromstructure('c:\\/inetpub\\/ownc...')\r\n#5 c:\\\\inetpub\\\\owncloud\\\\core\\\\ajax\\\\update.php(34): oc\\\\updater->upgrade()\r\n#6 {main})\",\"level\":4,\"time\":\"2013-12-18t08:26:37+00:00\"}\r\n```\r\n\r\ndebugging the issue, i found that the schema comparison fails because the current schema is read without quoting table names and the destination schema is created with quoting table names, identifiers etc.\r\n\r\nworkaround: editing mdb2schemareader.php and commenting all lines similar to\r\n\r\n```php\r\n$name = $this->platform->quoteidentifier($name);\r\n```\r\n\r\nresolved the issue.","closed_by":null}