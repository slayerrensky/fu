{"url":"https://api.github.com/repos/owncloud/core/issues/6556","labels_url":"https://api.github.com/repos/owncloud/core/issues/6556/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/6556/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/6556/events","html_url":"https://github.com/owncloud/core/issues/6556","id":24695082,"number":6556,"title":"failed migration from 5.0.14a to 6.0.0a, multiple database migration errors","user":{"login":"adamwill","id":916551,"avatar_url":"https://gravatar.com/avatar/2349ebc0d1880a1cf832937321438f41?d=https%3a%2f%2fidenticons.github.com%2f3507983385fd7f96d765e1bb9275fe77.png&r=x","gravatar_id":"2349ebc0d1880a1cf832937321438f41","url":"https://api.github.com/users/adamwill","html_url":"https://github.com/adamwill","followers_url":"https://api.github.com/users/adamwill/followers","following_url":"https://api.github.com/users/adamwill/following{/other_user}","gists_url":"https://api.github.com/users/adamwill/gists{/gist_id}","starred_url":"https://api.github.com/users/adamwill/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adamwill/subscriptions","organizations_url":"https://api.github.com/users/adamwill/orgs","repos_url":"https://api.github.com/users/adamwill/repos","events_url":"https://api.github.com/users/adamwill/events{/privacy}","received_events_url":"https://api.github.com/users/adamwill/received_events","type":"user","site_admin":false},"labels":[],"state":"open","assignee":null,"milestone":null,"comments":3,"created_at":"2013-12-23t05:45:37z","updated_at":"2013-12-23t07:16:10z","closed_at":null,"pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"i have a working install of owncloud 5.0.14a from fedora packages on fedora 20; it has been migrated from oc 4 (and maybe earlier, i forget what version i initially installed) and upgraded across multiple fedora releases.\r\n\r\non trying to upgrade to owncloud 6.0.0a (which we've just packaged and are now testing), i hit multiple migration issues. this is a direct migration from 5.0.14a to 6.0.0a, there is no 6.0.0 step involved (i've read that's known to cause issues).\r\n\r\ndec 22 21:29:34 www.happyassassin.net yum[1235]: updated: owncloud-httpd-6.0.0a-1.fc20.noarch\r\ndec 22 21:29:34 www.happyassassin.net yum[1235]: updated: owncloud-mysql-6.0.0a-1.fc20.noarch\r\ndec 22 21:29:44 www.happyassassin.net yum[1235]: updated: owncloud-6.0.0a-1.fc20.noarch\r\ndec 22 21:30:37 www.happyassassin.net systemd[1]: stopping the apache http server...\r\ndec 22 21:30:38 www.happyassassin.net systemd[1]: starting the apache http server...\r\ndec 22 21:30:38 www.happyassassin.net httpd[1327]: [sun dec 22 21:30:38.262456 2013] [alias:warn] [pid 1327] ah00671: the alias directive in /etc/httpd/conf.d/roundcubemail.conf at line 6 will probably never match because it overlaps an earlier alias.\r\ndec 22 21:30:38 www.happyassassin.net systemd[1]: started the apache http server.\r\ndec 22 21:31:45 www.happyassassin.net owncloud[1337]: {contacts} starting app upgrade from 0.2.5 to 0.3\r\ndec 22 21:31:45 www.happyassassin.net owncloud[1337]: {core} adding default user backend pwauth.\r\ndec 22 21:31:45 www.happyassassin.net owncloud[1337]: {hook} error while running hook (\\oc\\files\\storage\\shared::setup): an exception occurred while executing 'select `oc_share`.`id`, `item_type`, `item_source`, `item_target`,\r\n                                                                                                              `oc_share`.`parent`, `share_type`, `share_with`, `uid_owner`,\r\n                                                                                                              `file_source`, `path`, `file_target`, `permissions`, `stime`, `expiration`, `token`, `storage`, `mail_send` from `oc_share` inner join `oc_filecache` on `file_source` = `oc_filecache`.`fileid` where `file_target` is not null and `share_type` in (?,?,?) and `share_with` in (?,?) and `uid_owner` != ?':\r\n                                                      \r\n                                                      sqlstate[42s22]: column not found: 1054 unknown column 'mail_send' in 'field list'\r\ndec 22 21:32:07 www.happyassassin.net owncloud[1339]: {core} adding default user backend pwauth.\r\ndec 22 21:32:07 www.happyassassin.net owncloud[1339]: {hook} error while running hook (\\oc\\files\\storage\\shared::setup): an exception occurred while executing 'select `oc_share`.`id`, `item_type`, `item_source`, `item_target`,\r\n                                                                                                              `oc_share`.`parent`, `share_type`, `share_with`, `uid_owner`,\r\n                                                                                                              `file_source`, `path`, `file_target`, `permissions`, `stime`, `expiration`, `token`, `storage`, `mail_send` from `oc_share` inner join `oc_filecache` on `file_source` = `oc_filecache`.`fileid` where `file_target` is not null and `share_type` in (?,?,?) and `share_with` in (?,?) and `uid_owner` != ?':\r\n                                                      \r\n                                                      sqlstate[42s22]: column not found: 1054 unknown column 'mail_send' in 'field list'\r\ndec 22 21:32:16 www.happyassassin.net owncloud[1356]: {core} adding default user backend pwauth.\r\ndec 22 21:32:16 www.happyassassin.net owncloud[1354]: {core} starting upgrade from 5.0.28 to 6.0.0.14\r\ndec 22 21:32:16 www.happyassassin.net owncloud[1354]: {core} failed to update database structure (exception 'pdoexception' with message 'sqlstate[42000]: syntax error or access violation: 1091 can't drop 'primary'; check that column/key exists' in /usr/share/pear/doctrine/dbal/connection.php:742\r\n                                                      stack trace:\r\n                                                      #0 [internal function]: pdo->query('alter table `oc...')\r\n                                                      #1 /usr/share/pear/doctrine/dbal/connection.php(742): call_user_func_array(array, array)\r\n                                                      #2 /usr/share/owncloud/lib/private/db/mdb2schemamanager.php(152): doctrine\\dbal\\connection->query('alter table `oc...')\r\n                                                      #3 /usr/share/owncloud/lib/private/db/mdb2schemamanager.php(91): oc\\db\\mdb2schemamanager->executeschemachange(object(doctrine\\dbal\\schema\\schemadiff))\r\n                                                      #4 /usr/share/owncloud/lib/private/db.php(376): oc\\db\\mdb2schemamanager->updatedbfromstructure('/usr/share/ownc...')\r\n                                                      #5 /usr/share/owncloud/lib/private/updater.php(106): oc_db::updatedbfromstructure('/usr/share/ownc...')\r\n                                                      #6 /usr/share/owncloud/core/ajax/update.php(34): oc\\updater->upgrade()\r\n                                                      #7 {main}\r\n                                                      \r\n                                                      next exception 'doctrine\\dbal\\dbalexception' with message 'an exception occurred while executing 'alter table `oc_appconfig` drop primary key':\r\n                                                      \r\n                                                      sqlstate[42000]: syntax error or access violation: 1091 can't drop 'primary'; check that column/key exists' in /usr/share/pear/doctrine/dbal/dbalexception.php:47\r\n                                                      stack trace:\r\n                                                      #0 /usr/share/pear/doctrine/dbal/connection.php(744): doctrine\\dbal\\dbalexception::driverexceptionduringquery(object(pdoexception), 'alter table `oc...')\r\n                                                      #1 /usr/share/owncloud/lib/private/db/mdb2schemamanager.php(152): doctrine\\dbal\\connection->query('alter table `oc...')\r\n                                                      #2 /usr/share/owncloud/lib/private/db/mdb2schemamanager.php(91): oc\\db\\mdb2schemamanager->executeschemachange(object(doctrine\\dbal\\schema\\schemadiff))\r\n                                                      #3 /usr/share/owncloud/lib/private/db.php(376): oc\\db\\mdb2schemamanager->updatedbfromstructure('/usr/share/ownc...')\r\n                                                      #4 /usr/share/owncloud/lib/private/updater.php(106): oc_db::updatedbfromstructure('/usr/share/ownc...')\r\n                                                      #5 /usr/share/owncloud/core/ajax/update.php(34): oc\\updater->upgrade()\r\n                                                      #6 {main})\r\ndec 22 21:32:16 www.happyassassin.net owncloud[1354]: {core} adding default user backend pwauth.\r\ndec 22 21:32:16 www.happyassassin.net owncloud[1375]: {core} adding default user backend pwauth.\r\ndec 22 21:32:33 www.happyassassin.net owncloud[1383]: {core} adding default user backend pwauth.\r\ndec 22 21:32:33 www.happyassassin.net owncloud[1381]: {core} adding default user backend pwauth.\r\ndec 22 21:32:33 www.happyassassin.net owncloud[1378]: {core} adding default user backend pwauth.\r\ndec 22 21:32:33 www.happyassassin.net owncloud[1377]: {core} adding default user backend pwauth.\r\ndec 22 21:32:34 www.happyassassin.net owncloud[1381]: {core} adding default user backend pwauth.\r\ndec 22 21:32:34 www.happyassassin.net owncloud[1378]: {core} adding default user backend pwauth.\r\ndec 22 21:32:39 www.happyassassin.net owncloud[1339]: {core} adding default user backend pwauth.\r\ndec 22 21:32:39 www.happyassassin.net owncloud[1339]: {core} adding default user backend pwauth.\r\ndec 22 21:32:42 www.happyassassin.net owncloud[1361]: {core} adding default user backend pwauth.\r\ndec 22 21:32:42 www.happyassassin.net owncloud[1375]: {core} adding default user backend pwauth.\r\ndec 22 21:32:42 www.happyassassin.net owncloud[1337]: {core} adding default user backend pwauth.\r\ndec 22 21:32:42 www.happyassassin.net owncloud[1361]: {core} adding default user backend pwauth.\r\ndec 22 21:32:42 www.happyassassin.net owncloud[1375]: {core} adding default user backend pwauth.\r\ndec 22 21:32:42 www.happyassassin.net owncloud[1337]: {core} adding default user backend pwauth.\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1375]: {core} adding default user backend pwauth.\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1375]: {core} redirecttodefaultpage: https://www.happyassassin.net/owncloud/index.php/apps/files\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1375]: {core} adding default user backend pwauth.\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1375]: {hook} error while running hook (\\oc\\files\\storage\\shared::setup): an exception occurred while executing 'select `oc_share`.`id`, `item_type`, `item_source`, `item_target`,\r\n                                                                                                              `oc_share`.`parent`, `share_type`, `share_with`, `uid_owner`,\r\n                                                                                                              `file_source`, `path`, `file_target`, `permissions`, `stime`, `expiration`, `token`, `storage`, `mail_send` from `oc_share` inner join `oc_filecache` on `file_source` = `oc_filecache`.`fileid` where `file_target` is not null and `share_type` in (?,?,?) and `share_with` in (?,?) and `uid_owner` != ?':\r\n                                                      \r\n                                                      sqlstate[42s22]: column not found: 1054 unknown column 'mail_send' in 'field list'\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1375]: {index} exception: an exception occurred while executing 'select `fileid`, `storage`, `path`, `parent`, `name`, `mimetype`, `mimepart`, `size`, `mtime`,\r\n                                                                                                 `storage_mtime`, `encrypted`, `unencrypted_size`, `etag`\r\n                                                                                      from `oc_filecache` where `storage` = ? and `path_hash` = ?':\r\n                                                      \r\n                                                      sqlstate[42s22]: column not found: 1054 unknown column 'storage_mtime' in 'field list'\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1356]: {core} adding default user backend pwauth.\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1337]: {core} adding default user backend pwauth.\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1361]: {core} adding default user backend pwauth.\r\ndec 22 21:32:45 www.happyassassin.net owncloud[1394]: {core} adding default user backend pwauth.\r\ndec 22 21:32:46 www.happyassassin.net owncloud[1356]: {core} adding default user backend pwauth.\r\ndec 22 21:32:46 www.happyassassin.net owncloud[1356]: {core} adding default user backend pwauth.","closed_by":null}