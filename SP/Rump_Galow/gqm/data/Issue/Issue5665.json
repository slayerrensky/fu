{"url":"https://api.github.com/repos/owncloud/core/issues/5665","labels_url":"https://api.github.com/repos/owncloud/core/issues/5665/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5665/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5665/events","html_url":"https://github.com/owncloud/core/issues/5665","id":21977571,"number":5665,"title":"put times out / .part file does not get renamed to actual file name","user":{"login":"sfabel","id":1530330,"avatar_url":"https://gravatar.com/avatar/40a6d5aa649ded33f1f9ccecbfd64176?d=https%3a%2f%2fidenticons.github.com%2f19c51f11e8447ea7e3ee7dbac00f7be3.png&r=x","gravatar_id":"40a6d5aa649ded33f1f9ccecbfd64176","url":"https://api.github.com/users/sfabel","html_url":"https://github.com/sfabel","followers_url":"https://api.github.com/users/sfabel/followers","following_url":"https://api.github.com/users/sfabel/following{/other_user}","gists_url":"https://api.github.com/users/sfabel/gists{/gist_id}","starred_url":"https://api.github.com/users/sfabel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfabel/subscriptions","organizations_url":"https://api.github.com/users/sfabel/orgs","repos_url":"https://api.github.com/users/sfabel/repos","events_url":"https://api.github.com/users/sfabel/events{/privacy}","received_events_url":"https://api.github.com/users/sfabel/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"open","assignee":null,"milestone":null,"comments":9,"created_at":"2013-11-01t19:21:23z","updated_at":"2013-11-26t08:57:39z","closed_at":null,"pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\nwebdav / sync client upload uploads files in chunks; then reassembles them into .part files, finally renaming them to the actual file while saving that as a previous version.\r\n\r\n### actual behaviour\r\nput times out, resulting in \"unknown error\" on sync client side. sync client keeps trying, with the same behavior. if i rename the file manually, the sync stabilizes (until the next update to the file, that is).\r\n\r\n### steps to reproduce\r\n1. change a file locally that gets chunked in upload\r\n2. run the sync client or optionally just use webdav, same behavior\r\n\r\n### server configuration\r\noperating system: ubuntu 12.0.4\r\n\r\nreverse proxy: pound 2.5-1.1\r\n\r\nweb server: apache2 2.2.22-1ubuntu1.4\r\n\r\ndatabase: postgresql 9.1.9-0ubuntu12.04\r\n\r\nphp version: 5.3  5.3.10-1ubuntu3.8\r\n\r\nowncloud version:  5.0.12 enterprise w/ patch https://github.com/owncloud/core/pull/5613.patch\r\n\r\ndata directory: nfsv4 mount\r\n\r\n### client configuration\r\nbrowser: chrome\r\n\r\noperating system:  kubuntu 13.04\r\n\r\n### logs\r\n#### mitmproxy\r\n```\r\n>> get https://server/status.php\r\n       â†? 200 text/html 86b 29.13kb/s\r\n   get https://server/status.php\r\n       â†? 200 text/html 86b 20.31kb/s\r\n   get https://server/status.php\r\n       â†? 200 text/html 86b 58.54kb/s\r\n   get https://server/status.php\r\n       â†? 200 text/html 86b 41.15kb/s\r\n   propfind https://server/remote.php/webdav//\r\n            â†? 207 application/xml 410b 198.64kb/s\r\n   propfind https://server/remote.php/webdav//\r\n            â†? 207 application/xml 410b 201.15kb/s\r\n   propfind https://server/remote.php/webdav//\r\n            â†? 207 application/xml 410b 789.01kb/s\r\n   propfind https://server/remote.php/webdav\r\n            â†? 401 application/xml 291b 784.5kb/s\r\n   propfind https://server/remote.php/webdav\r\n            â†? 207 application/xml 8.96kb 538.82kb/s\r\n   propfind https://server/remote.php/webdav/shared\r\n            â†? 207 application/xml 3.99kb 991.01kb/s\r\n   propfind https://server/remote.php/webdav/path\r\n            â†? 207 application/xml 40.39kb 2.03mb/s\r\n   propfind https://server/remote.php/webdav/path/to/\r\n            â†? 207 application/xml 1.34kb 406.15kb/s\r\n   propfind https://server/remote.php/webdav/path/to/file\r\n            â†? 207 application/xml 4.24kb 1mb/s\r\n   put https://server/remote.php/webdav/path/to/file/file.txt\r\n```\r\n(then time out, then the propfinds start again)\r\n\r\n#### sync client (1.4.2)\r\n```\r\n11-01 09:12:59:698     * csync thread started \r\n11-01 09:12:59:698 folder in overallstatus message:  mirall::folder(0xa70d60)  with name  \"owncloud\" \r\n11-01 09:12:59:701 sync state changed for folder  \"owncloud\" :  \"sync running\" \r\n11-01 09:12:57:971 _csync_push_file: continuation: 0 -135014403\r\n11-01 09:12:57:971 _csync_push_file: remote repository atomar push enabled for ownclouds://server/remote.php/webdav/path/to/file/file.txt (0).\r\n11-01 09:12:57:971 oc_module: => open called for ownclouds://server/remote.php/webdav/path/to/file/file.txt\r\n11-01 09:12:57:971 oc_module: stating directory ownclouds://server/remote.php/webdav/path/to/file\r\n11-01 09:12:57:971 oc_module: owncloud_stat ownclouds://server/remote.php/webdav/path/to/file called\r\n11-01 09:12:57:971 oc_module: => errno after fetch resource list for ownclouds://server/remote.php/webdav/path/to/file: 0\r\n11-01 09:12:57:971 oc_module: working on file to\r\n11-01 09:12:57:971 oc_module: stat result from propfind: to, mtime: 1383266281\r\n11-01 09:12:57:971 oc_module: directory of file to open exists.\r\n11-01 09:12:57:971 oc_module: put request on /remote.php/webdav/path/to/file/file.txt!\r\n11-01 09:12:57:971 oc_module: sendfile handling request type put. fd 29\r\n11-01 09:12:57:971 hbf_splitlist: hbf_splitlist: block_size: 10485760 threshold: 10485760 st_size: 322666\r\n\r\n11-01 09:12:57:971 hbf_splitlist: hbf_splitlist: num_blocks: 1 rmainder: 322666 blk_size: 10485760\r\n\r\n11-01 09:12:57:971 hbf_splitlist: hbf_splitlist: created block 0   (start: 0  size: 322666)\r\n11-01 09:12:57:971 oc_module: about to send 1 block\r\n11-01 09:12:57:971 oc_module: existing chunk info 0 -135014403 \r\n11-01 09:12:57:971 _hbf_dav_request: hbf: block: 0 , start: 0 and size: 322666\r\n11-01 09:12:58:866 oc_module: chunk upload completed for 'ownclouds://server/remote.php/webdav/path/to/file/file.txt' (322666 bytes out of 322666)\r\n11-01 09:17:17:933 check status.php from statusdialog. \r\n11-01 09:17:17:934 get request to   qurl( \"https://server/status.php\" )  \r\n11-01 09:17:17:935 setting up host header:  \"server\" \r\n11-01 09:17:17:941 check status.php from statusdialog. \r\n11-01 09:17:17:942 get request to   qurl( \"https://server/status.php\" )  \r\n11-01 09:17:17:943 setting up host header:  \"server\" \r\n11-01 09:17:18:073 status.php returns:  \"{\"installed\":\"true\",\"version\":\"5.0.22\",\"versionstring\":\"5.0.12\",\"edition\":\"enterprise\"}\"   0  reply:  qnetworkreplyimpl(0xb2fa20) \r\n11-01 09:17:18:073 #-------# oc found on  \"https://server\" \r\n11-01 09:17:18:086 status.php returns:  \"{\"installed\":\"true\",\"version\":\"5.0.22\",\"versionstring\":\"5.0.12\",\"edition\":\"enterprise\"}\"   0  reply:  qnetworkreplyimpl(0x140d930) \r\n11-01 09:17:58:971 _csync_push_file: file: /home/stephan/owncloud/path/to/file/file.txt, command: sendfile, error: unknown error. from errno 5\r\n11-01 09:17:58:971 _csync_push_file: remember chunk: 0  (transfer id -135014403 )\r\n11-01 09:17:58:971 _csync_report_parent_error: mark parent directoy `path/to/file` as an error\r\n11-01 09:17:58:971 _csync_report_parent_error: mark parent directoy `path/to` as an error\r\n11-01 09:17:58:971 _csync_report_parent_error: mark parent directoy `path` as an error\r\n11-01 09:17:58:972 csync_propagate: propagation for local replica took 301.00 seconds visiting 3804 files.\r\n11-01 09:17:58:973 csync_propagate: propagation for remote replica took 0.00 seconds visiting 3775 files.\r\n11-01 09:17:58:978 [progress] progressed  322666  bytes in  1  files  in msec  299276 \r\n11-01 09:17:58:984 void mirall::csyncthread::startsync() sync finished \r\n11-01 09:17:58:985 _merge_file_trees_visitor: pre updated shared: 5273fd33bff8a\r\n11-01 09:17:58:985 _merge_file_trees_visitor: file: /home/stephan/owncloud/shared, instruction: updated (5273fd33bff8a)\r\n11-01 09:17:59:017 \u001b[31muint dbusmenuexporterdbus::getlayout(int, int, const qstringlist&, dbusmenulayoutitem&)\u001b[0m: condition failed: menu \r\n\r\n[...]\r\n\r\n1-01 09:18:00:548 csync_statedb_close: successfully moved tmp db to original db.\r\n11-01 09:18:00:557 csync run took  310765  milliseconds \r\n11-01 09:18:00:656 -> csync finished slot for \"owncloud\" with error false \r\n11-01 09:18:00:656 sync is enabled - starting the polltimer again. \r\n11-01 09:18:00:656 starting event logging again in  2000  milliseconds \r\n11-01 09:18:00:657 oo folder slotsyncfinished: result:  3 \r\n11-01 09:18:00:657   ** error strings:  (\"file path/to/file/file.txt: unknown error.\") \r\n11-01 09:18:00:657     * owncloud csync thread finished with error \r\n11-01 09:18:00:660 check status.php from statusdialog. \r\n11-01 09:18:00:661 get request to   qurl( \"https://server/status.php\" )  \r\n11-01 09:18:00:661 setting up host header:  \"server\" \r\n11-01 09:18:00:661 folder in overallstatus message:  mirall::folder(0xa70d60)  with name  \"owncloud\" \r\n11-01 09:18:00:662 sync state changed for folder  \"owncloud\" :  \"error\" \r\n11-01 09:18:00:662 setting up host header:  \"server\" \r\n11-01 09:18:00:662 <===================================== sync finished for  \"owncloud\" \r\n11-01 09:18:00:677 toggle enabled/disabled folder alias  \"owncloud\"  - current state:  true \r\n11-01 09:18:00:678 application: enable folder with alias  \"owncloud\" \r\n11-01 09:18:00:678     * event notification  disabled \r\n11-01 09:18:00:678 * \"owncloud\" sync skipped, user disabled! \r\n11-01 09:18:00:688 check status.php from statusdialog. \r\n11-01 09:18:00:688 get request to   qurl( \"https://server/status.php\" )  \r\n```","closed_by":null}