{"url":"https://api.github.com/repos/owncloud/core/issues/19","labels_url":"https://api.github.com/repos/owncloud/core/issues/19/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/19/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/19/events","html_url":"https://github.com/owncloud/core/pull/19","id":7216539,"number":19,"title":"reimplementation of csrf protection strategy","user":{"login":"arkascha","id":2156237,"avatar_url":"https://gravatar.com/avatar/9f792aed86f70eaed1b29e2f0398a881?d=https%3a%2f%2fidenticons.github.com%2fdb1707d51d6171a42a29fe8985cb531d.png&r=x","gravatar_id":"9f792aed86f70eaed1b29e2f0398a881","url":"https://api.github.com/users/arkascha","html_url":"https://github.com/arkascha","followers_url":"https://api.github.com/users/arkascha/followers","following_url":"https://api.github.com/users/arkascha/following{/other_user}","gists_url":"https://api.github.com/users/arkascha/gists{/gist_id}","starred_url":"https://api.github.com/users/arkascha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arkascha/subscriptions","organizations_url":"https://api.github.com/users/arkascha/orgs","repos_url":"https://api.github.com/users/arkascha/repos","events_url":"https://api.github.com/users/arkascha/events{/privacy}","received_events_url":"https://api.github.com/users/arkascha/received_events","type":"user","site_admin":false},"labels":[],"state":"closed","assignee":{"login":"lukasreschke","id":878997,"avatar_url":"https://gravatar.com/avatar/f080e75d370a4d8e550983a4898bcf3b?d=https%3a%2f%2fidenticons.github.com%2ff12e47d5bb5359a9f58e8217413be790.png&r=x","gravatar_id":"f080e75d370a4d8e550983a4898bcf3b","url":"https://api.github.com/users/lukasreschke","html_url":"https://github.com/lukasreschke","followers_url":"https://api.github.com/users/lukasreschke/followers","following_url":"https://api.github.com/users/lukasreschke/following{/other_user}","gists_url":"https://api.github.com/users/lukasreschke/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasreschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasreschke/subscriptions","organizations_url":"https://api.github.com/users/lukasreschke/orgs","repos_url":"https://api.github.com/users/lukasreschke/repos","events_url":"https://api.github.com/users/lukasreschke/events{/privacy}","received_events_url":"https://api.github.com/users/lukasreschke/received_events","type":"user","site_admin":false},"milestone":{"url":"https://api.github.com/repos/owncloud/core/milestones/1","labels_url":"https://api.github.com/repos/owncloud/core/milestones/1/labels","id":182808,"number":1,"title":"owncloud 4.5","description":"","creator":{"login":"karlitschek","id":867445,"avatar_url":"https://gravatar.com/avatar/87ce2b4531ee1a0c32b50e0d8f049224?d=https%3a%2f%2fidenticons.github.com%2f06e7098636caebfc9c30c9f52eb905df.png&r=x","gravatar_id":"87ce2b4531ee1a0c32b50e0d8f049224","url":"https://api.github.com/users/karlitschek","html_url":"https://github.com/karlitschek","followers_url":"https://api.github.com/users/karlitschek/followers","following_url":"https://api.github.com/users/karlitschek/following{/other_user}","gists_url":"https://api.github.com/users/karlitschek/gists{/gist_id}","starred_url":"https://api.github.com/users/karlitschek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/karlitschek/subscriptions","organizations_url":"https://api.github.com/users/karlitschek/orgs","repos_url":"https://api.github.com/users/karlitschek/repos","events_url":"https://api.github.com/users/karlitschek/events{/privacy}","received_events_url":"https://api.github.com/users/karlitschek/received_events","type":"user","site_admin":false},"open_issues":0,"closed_issues":4,"state":"closed","created_at":"2012-09-24t16:32:50z","updated_at":"2013-02-18t13:38:41z","due_on":"2012-10-03t07:00:00z"},"comments":1,"created_at":"2012-09-28t14:52:21z","updated_at":"2013-10-08t13:44:16z","closed_at":"2012-09-28t17:54:12z","pull_request":{"html_url":"https://github.com/owncloud/core/pull/19","diff_url":"https://github.com/owncloud/core/pull/19.diff","patch_url":"https://github.com/owncloud/core/pull/19.patch"},"body":"as discussed on the mailinglist i reimplemented the csrf protection code ( \"[owncloud] csrf behaviour is annoying\" )\n\nmotivation: \nthe current (static) strategy has an annoying side effect: since the token expires the user gets an error and is asked to \"reload\" when using an oc view older than 1 hour. this is fine for most things. this happens when leaving the client for a while (having lunch...) or using apps that do _not_ require a full page reload for every click (like the 'shorty' app for example). \nin the shorty app i implemented a refresh strategy to pull fresh tokens to prevent that annoying problem that strategy works and appears safe to me. i was asked to implement that strategy in oc core which i did. \n\ndetails: \ni tried to stick with the previous naming scheme where possible. i added two files and modified a few details. the new strategy: \n- pull a fresh token right before the current one expires (96%)\n- register that fresh token where required (currently ajax requests and eventsource)\n\nbugfix: \nthis commit also fixes bug oc-1593  -  race condition with csrf protection token initialization\n\nimplementation: \nthe (first) token is still generated whilst evaluating the layout.user template. alongside its lifespan is stored, that way that value is controlled from a single place in the code instead of being hard coded at various places. the new file core/js/requesttoken.js handles the token and its refreshing. it stores the token in the oc namespace and binds it to ajax requests. eventsource has been modified to use that token storage too. \na fresh token is pulled via an ajax call shortyl before the old one expire (96%). for this a new ajax backend has been implemented: core/ajax/requesttoken.php\n\nsecurity: \nthe new strategy allows autorefreshment of the token. in my eyes this is not a security thread, since a fresh token can be generated anyway at all times simply by loading and oc view. so complex implementations can work around that protection anyway. \nin the current state pulling a fresh token itself is _not_ protected by a token. also, in my eyes this is _not_ a security problem, same reason. though this can be argued about. pulling a fresh token obviously still requires being authenticated and having a valid session. \n\nconclusion: \nthe commit implements an advanced strategy offering two advantages \n1.) get rid of annoying error thrown into the users face\n2.) fix race condition (bug 1593)\n\nfor questions and discussions: i often hang around at irc #owncloud & #owncloud-dev, nick name 'arkascha'. ","closed_by":{"login":"lukasreschke","id":878997,"avatar_url":"https://gravatar.com/avatar/f080e75d370a4d8e550983a4898bcf3b?d=https%3a%2f%2fidenticons.github.com%2ff12e47d5bb5359a9f58e8217413be790.png&r=x","gravatar_id":"f080e75d370a4d8e550983a4898bcf3b","url":"https://api.github.com/users/lukasreschke","html_url":"https://github.com/lukasreschke","followers_url":"https://api.github.com/users/lukasreschke/followers","following_url":"https://api.github.com/users/lukasreschke/following{/other_user}","gists_url":"https://api.github.com/users/lukasreschke/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasreschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasreschke/subscriptions","organizations_url":"https://api.github.com/users/lukasreschke/orgs","repos_url":"https://api.github.com/users/lukasreschke/repos","events_url":"https://api.github.com/users/lukasreschke/events{/privacy}","received_events_url":"https://api.github.com/users/lukasreschke/received_events","type":"user","site_admin":false}}