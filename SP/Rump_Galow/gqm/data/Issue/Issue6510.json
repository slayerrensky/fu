{"url":"https://api.github.com/repos/owncloud/core/issues/6510","labels_url":"https://api.github.com/repos/owncloud/core/issues/6510/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/6510/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/6510/events","html_url":"https://github.com/owncloud/core/issues/6510","id":24552905,"number":6510,"title":"files corrupt due to encryption in shares when moving them","user":{"login":"bude132","id":5817710,"avatar_url":"https://gravatar.com/avatar/7c1e189248f0b8a20e432f8346eff7d0?d=https%3a%2f%2fidenticons.github.com%2f2c386a7ccfd8ecd340af163b913c26bc.png&r=x","gravatar_id":"7c1e189248f0b8a20e432f8346eff7d0","url":"https://api.github.com/users/bude132","html_url":"https://github.com/bude132","followers_url":"https://api.github.com/users/bude132/followers","following_url":"https://api.github.com/users/bude132/following{/other_user}","gists_url":"https://api.github.com/users/bude132/gists{/gist_id}","starred_url":"https://api.github.com/users/bude132/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bude132/subscriptions","organizations_url":"https://api.github.com/users/bude132/orgs","repos_url":"https://api.github.com/users/bude132/repos","events_url":"https://api.github.com/users/bude132/events{/privacy}","received_events_url":"https://api.github.com/users/bude132/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"closed","assignee":null,"milestone":null,"comments":2,"created_at":"2013-12-19t12:18:06z","updated_at":"2013-12-19t18:19:09z","closed_at":"2013-12-19t18:19:09z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\na file should decrypt properly when opening it in a shared folder after moving it with the user account of the invited user. ( not the user who created the share ) \r\n\r\n### actual behaviour\r\nthe file doesn't decrypt and corrupts rendering it useless. editing the file with notepad shows encrypted content.\r\n\r\n### steps to reproduce\r\n1. create a new test1 user.\r\n2. create a new test2 user.\r\n3. share a folder created by test1 with test2\r\n4. upload a file as test1 to the share\r\n5. create a folder within the share as test1\r\n6. move the file to the created folder as test2\r\n7. try to open it with any user.\r\n8. the file is now corrupted rendering it useless.\r\n\r\n### server configuration\r\noperating system: ubuntu 12.04.03 lts\r\n\r\nweb server: \r\napache/2.2.22 (ubuntu)\r\n\r\ndatabase:\r\nmysql 5.5.34-0ubuntu0.12.04.1 (ubuntu)\r\n\r\nphp version:\r\nphp 5.3.10-1ubuntu3.9 with suhosin-patch (cli) (built: dec 12 2013 04:27:25)\r\ncopyright (c) 1997-2012 the php group\r\nzend engine v2.3.0, copyright (c) 1998-2012 zend technologies\r\n\r\nowncloud version:\r\nowncloud 6.0.0a (stable)\r\n\r\nupdated from an older owncloud or fresh install:\r\nupdated from 6.0.0 to 6.0.0a\r\n\r\nlist of activated app:\r\nactivity\r\ncalendar\r\ncontacts\r\ndeleted files\r\ndocuments\r\nencryption\r\nfirst run wizard\r\nfull text search\r\npdf viewer\r\npictures\r\nshare files\r\ntext editor\r\nupdater\r\nversions\r\nvideo viewer\r\n\r\nthe content of config/config.php:\r\n<?php\r\n$config = array (\r\n  'instanceid' => 'ocea67a83830',\r\n  'datadirectory' => '/var/data',\r\n  'dbtype' => 'mysql',\r\n  'version' => '6.0.0.14',\r\n  'dbname' => 'owncloud',\r\n  'dbhost' => 'localhost',\r\n  'dbtableprefix' => 'oc_',\r\n  'dbuser' => 'oc_bude132',\r\n  'installed' => true,\r\n  'forcessl' => true,\r\n  'theme' => '',\r\n  'maintenance' => false,\r\n  'loglevel' => '0',\r\n);\r\n\r\nare you using external storage, if yes which one:\r\nno.\r\n\r\n### client configuration\r\nbrowser:\r\nchrome\r\nmobile client ios\r\ndesktop client 1.5\r\n\r\noperating system:\r\nwindows 7 64 bit pro\r\n### logs\r\n#### web server error log\r\n```\r\n[thu dec 19 10:02:59 2013] [error] [client 5.35.248.148] client denied by server configuration: /var/www/owncloud/data/htaccesstest.txt\r\n[thu dec 19 12:58:34 2013] [error] [client 92.50.101.170] file does not exist: /var/www/favicon.ico\r\n[thu dec 19 12:59:50 2013] [error] [client 92.50.101.170] file does not exist: /var/www/favicon.ico\r\n[thu dec 19 13:03:46 2013] [error] [client 5.35.248.148] file does not exist: /var/www/owncloud/data\r\n[thu dec 19 13:03:46 2013] [error] [client 5.35.248.148] file does not exist: /var/www/core\r\n\r\n```\r\n\r\n#### owncloud log (data/owncloud.log)\r\n```\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for \\/var\\/data\\/bude132\\/files_encryption\\/keyfiles\\/photos\\/squirrel.jpg.key at \\/var\\/www\\/owncloud\\/lib\\/private\\/files\\/storage\\/local.php#127\",\"level\":2,\"time\":\"2013-12-19t08:54:55+00:00\"}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for \\/var\\/data\\/bude132\\/files_encryption\\/keyfiles\\/photos\\/paris.jpg.key at \\/var\\/www\\/owncloud\\/lib\\/private\\/files\\/storage\\/local.php#127\",\"level\":2,\"time\":\"2013-12-19t09:02:55+00:00\"}\r\n{\"app\":\"core\",\"message\":\"iswebdavworking: no - reason: [curl] error while making request: ssl: certificate subject name 'bude' does not match target host name '5.35.248.148' (error code: 51) (sabre_dav_exception)\",\"level\":2,\"time\":\"2013-12-19t09:02:59+00:00\"}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for \\/var\\/data\\/bude132\\/files_encryption\\/keyfiles\\/photos\\/san francisco.jpg.key at \\/var\\/www\\/owncloud\\/lib\\/private\\/files\\/storage\\/local.php#127\",\"level\":2,\"time\":\"2013-12-19t09:03:09+00:00\"}\r\n{\"app\":\"php\",\"message\":\"cannot modify header information - headers already sent by (output started at \\/var\\/www\\/owncloud\\/lib\\/private\\/eventsource.php:71) at \\/var\\/www\\/owncloud\\/lib\\/private\\/user\\/session.php#204\",\"level\":2,\"time\":\"2013-12-19t09:04:13+00:00\"}\r\n{\"app\":\"php\",\"message\":\"cannot modify header information - headers already sent by (output started at \\/var\\/www\\/owncloud\\/lib\\/private\\/eventsource.php:71) at \\/var\\/www\\/owncloud\\/lib\\/private\\/user\\/session.php#205\",\"level\":2,\"time\":\"2013-12-19t09:04:13+00:00\"}\r\n{\"app\":\"php\",\"message\":\"cannot modify header information - headers already sent by (output started at \\/var\\/www\\/owncloud\\/lib\\/private\\/eventsource.php:71) at \\/var\\/www\\/owncloud\\/lib\\/private\\/user\\/session.php#206\",\"level\":2,\"time\":\"2013-12-19t09:04:13+00:00\"}\r\n{\"app\":\"php\",\"message\":\"cannot modify header information - headers already sent by (output started at \\/var\\/www\\/owncloud\\/lib\\/private\\/eventsource.php:71) at \\/var\\/www\\/owncloud\\/lib\\/private\\/user\\/session.php#209\",\"level\":2,\"time\":\"2013-12-19t09:04:13+00:00\"}\r\n{\"app\":\"php\",\"message\":\"cannot modify header information - headers already sent by (output started at \\/var\\/www\\/owncloud\\/lib\\/private\\/eventsource.php:71) at \\/var\\/www\\/owncloud\\/lib\\/private\\/user\\/session.php#210\",\"level\":2,\"time\":\"2013-12-19t09:04:13+00:00\"}\r\n{\"app\":\"php\",\"message\":\"cannot modify header information - headers already sent by (output started at \\/var\\/www\\/owncloud\\/lib\\/private\\/eventsource.php:71) at \\/var\\/www\\/owncloud\\/lib\\/private\\/user\\/session.php#211\",\"level\":2,\"time\":\"2013-12-19t09:04:13+00:00\"}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for \\/var\\/data\\/bude132\\/files_encryption\\/keyfiles\\/music\\/projekteva-letitrain.mp3.key at \\/var\\/www\\/owncloud\\/lib\\/private\\/files\\/storage\\/local.php#127\",\"level\":2,\"time\":\"2013-12-19t09:04:24+00:00\"}\r\n{\"app\":\"core\",\"message\":\"iswebdavworking: no - reason: [curl] error while making request: ssl: certificate subject name 'bude' does not match target host name '5.35.248.148' (error code: 51) (sabre_dav_exception)\",\"level\":2,\"time\":\"2013-12-19t09:04:34+00:00\"}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for \\/var\\/data\\/bude132\\/files_encryption\\/keyfiles\\/documents\\/example.odt.key at \\/var\\/www\\/owncloud\\/lib\\/private\\/files\\/storage\\/local.php#127\",\"level\":2,\"time\":\"2013-12-19t09:04:34+00:00\"}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for \\/var\\/data\\/bude132\\/files_encryption\\/share-keys\\/owncloudusermanual.pdf.bude132.sharekey at \\/var\\/www\\/owncloud\\/lib\\/private\\/files\\/storage\\/local.php#127\",\"level\":2,\"time\":\"2013-12-19t09:05:43+00:00\"}\r\n{\"app\":\"core\",\"message\":\"iswebdavworking: no - reason: [curl] error while making request: ssl: certificate subject name 'bude' does not match target host name '5.35.248.148' (error code: 51) (sabre_dav_exception)\",\"level\":2,\"time\":\"2013-12-19t09:05:56+00:00\"}\r\n{\"app\":\"files_sharing\",\"message\":\"file source not found for: \\/files\\/test\\/test\",\"level\":3,\"time\":\"2013-12-19t12:00:16+00:00\"}\r\n{\"app\":\"files_sharing\",\"message\":\"file source not found for: \\/files\\/test\\/test\",\"level\":3,\"time\":\"2013-12-19t12:00:16+00:00\"}\r\n{\"app\":\"files_sharing\",\"message\":\"file source not found for: \\/files\\/test\\/test\",\"level\":3,\"time\":\"2013-12-19t12:03:17+00:00\"}\r\n{\"app\":\"files_sharing\",\"message\":\"file source not found for: \\/files\\/test\\/test\",\"level\":3,\"time\":\"2013-12-19t12:03:17+00:00\"}\r\n{\"app\":\"files_sharing\",\"message\":\"file source not found for: \\/files\\/test\\/weihnachtsbrief.pdf\",\"level\":3,\"time\":\"2013-12-19t12:03:18+00:00\"}\r\n{\"app\":\"files_sharing\",\"message\":\"file source not found for: \\/files\\/test\\/weihnachtsbrief.pdf\",\"level\":3,\"time\":\"2013-12-19t12:03:18+00:00\"}\r\n{\"app\":\"core\",\"message\":\"iswebdavworking: no - reason: [curl] error while making request: ssl: certificate subject name 'bude' does not match target host name '5.35.248.148' (error code: 51) (sabre_dav_exception)\",\"level\":2,\"time\":\"2013-12-19t12:03:47+00:00\"}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for \\/var\\/data\\/bude132\\/lucene_index\\/segments_2 at \\/var\\/www\\/owncloud\\/lib\\/private\\/files\\/storage\\/local.php#127\",\"level\":2,\"time\":\"2013-12-19t12:03:47+00:00\"}\r\n```\r\n","closed_by":{"login":"schiesbn","id":1589737,"avatar_url":"https://gravatar.com/avatar/8912b598c7b32dd25b87fd168e0b06b2?d=https%3a%2f%2fidenticons.github.com%2f0a323047dbe8329db30eae8dbe96e55e.png&r=x","gravatar_id":"8912b598c7b32dd25b87fd168e0b06b2","url":"https://api.github.com/users/schiesbn","html_url":"https://github.com/schiesbn","followers_url":"https://api.github.com/users/schiesbn/followers","following_url":"https://api.github.com/users/schiesbn/following{/other_user}","gists_url":"https://api.github.com/users/schiesbn/gists{/gist_id}","starred_url":"https://api.github.com/users/schiesbn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/schiesbn/subscriptions","organizations_url":"https://api.github.com/users/schiesbn/orgs","repos_url":"https://api.github.com/users/schiesbn/repos","events_url":"https://api.github.com/users/schiesbn/events{/privacy}","received_events_url":"https://api.github.com/users/schiesbn/received_events","type":"user","site_admin":false}}