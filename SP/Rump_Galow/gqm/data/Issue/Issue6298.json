{"url":"https://api.github.com/repos/owncloud/core/issues/6298","labels_url":"https://api.github.com/repos/owncloud/core/issues/6298/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/6298/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/6298/events","html_url":"https://github.com/owncloud/core/issues/6298","id":24052798,"number":6298,"title":"upgrade from 5.0.13 to 6.0rc4 fails with sql error","user":{"login":"torlasz","id":2997536,"avatar_url":"https://gravatar.com/avatar/d4184dba791f5d4ca7701cb4d40e21d2?d=https%3a%2f%2fidenticons.github.com%2fa0b69955c7185e378fc6dd2c04979570.png&r=x","gravatar_id":"d4184dba791f5d4ca7701cb4d40e21d2","url":"https://api.github.com/users/torlasz","html_url":"https://github.com/torlasz","followers_url":"https://api.github.com/users/torlasz/followers","following_url":"https://api.github.com/users/torlasz/following{/other_user}","gists_url":"https://api.github.com/users/torlasz/gists{/gist_id}","starred_url":"https://api.github.com/users/torlasz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/torlasz/subscriptions","organizations_url":"https://api.github.com/users/torlasz/orgs","repos_url":"https://api.github.com/users/torlasz/repos","events_url":"https://api.github.com/users/torlasz/events{/privacy}","received_events_url":"https://api.github.com/users/torlasz/received_events","type":"user","site_admin":false},"labels":[],"state":"open","assignee":null,"milestone":null,"comments":2,"created_at":"2013-12-10t17:48:48z","updated_at":"2013-12-11t13:24:32z","closed_at":null,"pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\n5.0.13 to 6.0 upgrade should be successful\r\n\r\n### actual behaviour\r\nupgrade fails with an sql error\r\n\r\n### steps to reproduce\r\n1. make a copy of an existing 5.0.13 service to a new area\r\n2. delete all folders except data and config\r\n3. copy 6.0rc4 folders over the install area\r\n4. make a copy of the 5.0.13 database\r\n5. set the database to the fresh copy\r\n6. point the browser to the proper url\r\n\r\n### server configuration\r\noperating system: rhel 6.4\r\n\r\nweb server: apache httpd-2.2.15-28.el6_4.x86_64\r\n\r\ndatabase: mysql  mysql-server-5.1.69-1.el6_4.x86_64\r\n\r\nphp version: php-5.3.3-22.el6.x86_64\r\n\r\nowncloud version: (see owncloud admin page) 6.0rc4\r\n\r\nupdated from an older owncloud or fresh install: 5.0.13\r\n\r\nlist of activated app:\r\n\r\nthe content of config/config.php: (without the database password and passwordsalt) \r\n<?php\r\n$config = array (\r\n  'instanceid' => '510275117436b',\r\n  'passwordsalt' => 'xxx',\r\n  'datadirectory' => '/var/www/oc2/data',\r\n  'dbtype' => 'mysql',\r\n  'version' => '6.0.0.12',\r\n  'dbname' => 'owncloud2',\r\n  'dbhost' => 'localhost',\r\n  'dbtableprefix' => 'oc_',\r\n  'dbuser' => 'owncloud',\r\n  'dbpassword' => 'xxx',\r\n  'installed' => true,\r\n  'ldapignorenamingrules' => false,\r\n  'loglevel' => '0',\r\n  'maintenance' => false,\r\n  'theme' => '',\r\n);\r\n\r\n\r\n\r\n### client configuration\r\nbrowser: mozilla firefox firefox-25.0-3.fc18.x86_64\r\n\r\noperating system: fedora 18\r\n\r\n### logs\r\n#### web server error log\r\nno errors\r\n\r\n#### owncloud log (data/owncloud.log)\r\n{\"app\":\"index\",\"message\":\"exception: an exception occurred while executing 'select `id` from `oc_jobs` where `class` = ? and `argument` = ?':\\n\\nsqlstate[42s\r\n02]: base table or view not found: 1146 table 'owncloud2.oc_jobs' doesn't exist\",\"level\":4,\"time\":\"2013-12-10t12:44:34+00:00\"}\r\n{\"app\":\"core\",\"message\":\"starting upgrade from 5.0.25 to 6.0.0.12\",\"level\":0,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"failed to update database structure (exception 'pdoexception' with message 'sqlstate[23000]: integrity constraint violation: 1062 du\r\nplicate entry 'torlasz-settings-email' for key 'primary'' in \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connection.php:742\\nstack trace:\r\n\\n#0 [internal function]: pdo->query('alter table `oc...')\\n#1 \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connection.php(742): call_user\r\n_func_array(array, array)\\n#2 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(152): doctrine\\\\dbal\\\\connection->query('alter table `oc...')\\n#3 \\/va\r\nr\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(91): oc\\\\db\\\\mdb2schemamanager->executeschemachange(object(doctrine\\\\dbal\\\\schema\\\\schemadiff))\\n#4 \\/va\r\nr\\/www\\/oc2\\/lib\\/private\\/db.php(373): oc\\\\db\\\\mdb2schemamanager->updatedbfromstructure('\\/var\\/www\\/oc2\\/db...')\\n#5 \\/var\\/www\\/oc2\\/lib\\/private\\/updater\r\n.php(106): oc_db::updatedbfromstructure('\\/var\\/www\\/oc2\\/db...')\\n#6 \\/var\\/www\\/oc2\\/core\\/ajax\\/update.php(34): oc\\\\updater->upgrade()\\n#7 {main}\\n\\nnext \r\nexception 'doctrine\\\\dbal\\\\dbalexception' with message 'an exception occurred while executing 'alter table `oc_preferences` add primary key (`userid`, `appid\r\n`, `configkey`)':\\n\\nsqlstate[23000]: integrity constraint violation: 1062 duplicate entry 'torlasz-settings-email' for key 'primary'' in \\/var\\/www\\/oc2\\/3r\r\ndparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/dbalexception.php:47\\nstack trace:\\n#0 \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connectio\r\nn.php(744): doctrine\\\\dbal\\\\dbalexception::driverexceptionduringquery(object(pdoexception), 'alter table `oc...')\\n#1 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2\r\nschemamanager.php(152): doctrine\\\\dbal\\\\connection->query('alter table `oc...')\\n#2 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(91): oc\\\\db\\\\mdb\r\n2schemamanager->executeschemachange(object(doctrine\\\\dbal\\\\schema\\\\schemadiff))\\n#3 \\/var\\/www\\/oc2\\/lib\\/private\\/db.php(373): oc\\\\db\\\\mdb2schemamanager->up\r\ndatedbfromstructure('\\/var\\/www\\/oc2\\/db...')\\n#4 \\/var\\/www\\/oc2\\/lib\\/private\\/updater.php(106): oc_db::updatedbfromstructure('\\/var\\/www\\/oc2\\/db...')\\n#5\r\n \\/var\\/www\\/oc2\\/core\\/ajax\\/update.php(34): oc\\\\updater->upgrade()\\n#6 {main})\",\"level\":4,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"app \\\"\\\" (user_migrate) can't be used because it is not compatible with this version of owncloud\",\"level\":3,\"time\":\"2013-12-10t12:44\r\n:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"can't remove app user_migrate. it is not installed.\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"app \\\"\\\" (admin_migrate) can't be used because it is not compatible with this version of owncloud\",\"level\":3,\"time\":\"2013-12-10t12:4\r\n4:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"can't remove app admin_migrate. it is not installed.\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"app \\\"\\\" (media) can't be used because it is not compatible with this version of owncloud\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:\r\n00\"}\r\n{\"app\":\"core\",\"message\":\"can't remove app media. it is not installed.\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"app \\\"\\\" (files_imageviewer) can't be used because it is not compatible with this version of owncloud\",\"level\":3,\"time\":\"2013-12-10t\r\n12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"can't remove app files_imageviewer. it is not installed.\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"app \\\"\\\" (files_odfviewer) can't be used because it is not compatible with this version of owncloud\",\"level\":3,\"time\":\"2013-12-10t12\r\n:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"can't remove app files_odfviewer. it is not installed.\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"app \\\"\\\" (user_saml) can't be used because it is not compatible with this version of owncloud\",\"level\":3,\"time\":\"2013-12-10t12:44:35\r\n+00:00\"}\r\n{\"app\":\"core\",\"message\":\"can't remove app user_saml. it is not installed.\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"app \\\"\\\" (mozilla_sync) can't be used because it is not compatible with this version of owncloud\",\"level\":3,\"time\":\"2013-12-10t12:44\r\n:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"can't remove app mozilla_sync. it is not installed.\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"app \\\"\\\" (files_epubviewer) can't be used because it is not compatible with this version of owncloud\",\"level\":3,\"time\":\"2013-12-10t1\r\n2:44:35+00:00\"}\r\n{\"app\":\"core\",\"message\":\"can't remove app files_epubviewer. it is not installed.\",\"level\":3,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"contacts\",\"message\":\"starting app upgrade from 0.2.5 to 0.3\",\"level\":0,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"gallery\",\"message\":\"starting app upgrade from 0.5.2 to 0.5.3\",\"level\":0,\"time\":\"2013-12-10t12:44:35+00:00\"}\r\n{\"app\":\"user_ldap\",\"message\":\"starting app upgrade from 0.4.0 to 0.4.1\",\"level\":0,\"time\":\"2013-12-10t12:44:36+00:00\"}\r\n{\"app\":\"search_lucene\",\"message\":\"starting app upgrade from 0.5.0 to 0.5.2\",\"level\":0,\"time\":\"2013-12-10t12:44:36+00:00\"}\r\n{\"app\":\"core\",\"message\":\"failed to update database structure (exception 'pdoexception' with message 'sqlstate[23000]: integrity constraint violation: 1062 du\r\nplicate entry '1050' for key 'primary'' in \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connection.php:742\\nstack trace:\\n#0 [internal fun\r\nction]: pdo->query('alter table `oc...')\\n#1 \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connection.php(742): call_user_func_array(array,\r\n array)\\n#2 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(152): doctrine\\\\dbal\\\\connection->query('alter table `oc...')\\n#3 \\/var\\/www\\/oc2\\/lib\\/\r\nprivate\\/db\\/mdb2schemamanager.php(91): oc\\\\db\\\\mdb2schemamanager->executeschemachange(object(doctrine\\\\dbal\\\\schema\\\\schemadiff))\\n#4 \\/var\\/www\\/oc2\\/lib\\/\r\nprivate\\/db.php(373): oc\\\\db\\\\mdb2schemamanager->updatedbfromstructure('\\/var\\/www\\/oc2\\/ap...')\\n#5 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(965): oc_db::upda\r\ntedbfromstructure('\\/var\\/www\\/oc2\\/ap...')\\n#6 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(867): oc_app::updateapp('search_lucene')\\n#7 \\/var\\/www\\/oc2\\/lib\\/pri\r\nvate\\/app.php(92): oc_app::checkupgrade('search_lucene')\\n#8 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(66): oc_app::loadapp('search_lucene')\\n#9 \\/var\\/www\\/oc2\r\n\\/lib\\/private\\/updater.php(118): oc_app::loadapps()\\n#10 \\/var\\/www\\/oc2\\/core\\/ajax\\/update.php(34): oc\\\\updater->upgrade()\\n#11 {main}\\n\\nnext exception '\r\ndoctrine\\\\dbal\\\\dbalexception' with message 'an exception occurred while executing 'alter table `oc_lucene_status` add primary key (`fileid`)':\\n\\nsqlstate[2\r\n3000]: integrity constraint violation: 1062 duplicate entry '1050' for key 'primary'' in \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/dbal\r\nexception.php:47\\nstack trace:\\n#0 \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connection.php(744): doctrine\\\\dbal\\\\dbalexception::driver\r\nexceptionduringquery(object(pdoexception), 'alter table `oc...')\\n#1 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(152): doctrine\\\\dbal\\\\connectio\r\nn->query('alter table `oc...')\\n#2 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(91): oc\\\\db\\\\mdb2schemamanager->executeschemachange(object(doctri\r\nne\\\\dbal\\\\schema\\\\schemadiff))\\n#3 \\/var\\/www\\/oc2\\/lib\\/private\\/db.php(373): oc\\\\db\\\\mdb2schemamanager->updatedbfromstructure('\\/var\\/www\\/oc2\\/ap...')\\n#4 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(965): oc_db::updatedbfromstructure('\\/var\\/www\\/oc2\\/ap...')\\n#5 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(867): oc_app::updateapp('search_lucene')\\n#6 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(92): oc_app::checkupgrade('search_lucene')\\n#7 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(66): oc_app::loadapp('search_lucene')\\n#8 \\/var\\/www\\/oc2\\/lib\\/private\\/updater.php(118): oc_app::loadapps()\\n#9 \\/var\\/www\\/oc2\\/core\\/ajax\\/update.php(34): oc\\\\updater->upgrade()\\n#10 {main})\",\"level\":4,\"time\":\"2013-12-10t12:44:36+00:00\"}\r\n{\"app\":\"php\",\"message\":\"failed to upgrade \\\"search_lucene\\\". at \\/var\\/www\\/oc2\\/lib\\/private\\/app.php#873\",\"level\":3,\"time\":\"2013-12-10t12:44:36+00:00\"}\r\n{\"app\":\"search_lucene\",\"message\":\"starting app upgrade from 0.5.0 to 0.5.2\",\"level\":0,\"time\":\"2013-12-10t12:44:36+00:00\"}\r\n{\"app\":\"core\",\"message\":\"failed to update database structure (exception 'pdoexception' with message 'sqlstate[23000]: integrity constraint violation: 1062 duplicate entry '1050' for key 'primary'' in \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connection.php:742\\nstack trace:\\n#0 [internal function]: pdo->query('alter table `oc...')\\n#1 \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connection.php(742): call_user_func_array(array, array)\\n#2 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(152): doctrine\\\\dbal\\\\connection->query('alter table `oc...')\\n#3 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(91): oc\\\\db\\\\mdb2schemamanager->executeschemachange(object(doctrine\\\\dbal\\\\schema\\\\schemadiff))\\n#4 \\/var\\/www\\/oc2\\/lib\\/private\\/db.php(373): oc\\\\db\\\\mdb2schemamanager->updatedbfromstructure('\\/var\\/www\\/oc2\\/ap...')\\n#5 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(965): oc_db::updatedbfromstructure('\\/var\\/www\\/oc2\\/ap...')\\n#6 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(867): oc_app::updateapp('search_lucene')\\n#7 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(92): oc_app::checkupgrade('search_lucene')\\n#8 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(66): oc_app::loadapp('search_lucene')\\n#9 \\/var\\/www\\/oc2\\/lib\\/base.php(689): oc_app::loadapps()\\n#10 \\/var\\/www\\/oc2\\/index.php(30): oc::handlerequest()\\n#11 {main}\\n\\nnext exception 'doctrine\\\\dbal\\\\dbalexception' with message 'an exception occurred while executing 'alter table `oc_lucene_status` add primary key (`fileid`)':\\n\\nsqlstate[23000]: integrity constraint violation: 1062 duplicate entry '1050' for key 'primary'' in \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/dbalexception.php:47\\nstack trace:\\n#0 \\/var\\/www\\/oc2\\/3rdparty\\/doctrine\\/dbal\\/lib\\/doctrine\\/dbal\\/connection.php(744): doctrine\\\\dbal\\\\dbalexception::driverexceptionduringquery(object(pdoexception), 'alter table `oc...')\\n#1 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(152): doctrine\\\\dbal\\\\connection->query('alter table `oc...')\\n#2 \\/var\\/www\\/oc2\\/lib\\/private\\/db\\/mdb2schemamanager.php(91): oc\\\\db\\\\mdb2schemamanager->executeschemachange(object(doctrine\\\\dbal\\\\schema\\\\schemadiff))\\n#3 \\/var\\/www\\/oc2\\/lib\\/private\\/db.php(373): oc\\\\db\\\\mdb2schemamanager->updatedbfromstructure('\\/var\\/www\\/oc2\\/ap...')\\n#4 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(965): oc_db::updatedbfromstructure('\\/var\\/www\\/oc2\\/ap...')\\n#5 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(867): oc_app::updateapp('search_lucene')\\n#6 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(92): oc_app::checkupgrade('search_lucene')\\n#7 \\/var\\/www\\/oc2\\/lib\\/private\\/app.php(66): oc_app::loadapp('search_lucene')\\n#8 \\/var\\/www\\/oc2\\/lib\\/base.php(689): oc_app::loadapps()\\n#9 \\/var\\/www\\/oc2\\/index.php(30): oc::handlerequest()\\n#10 {main})\",\"level\":4,\"time\":\"2013-12-10t12:44:36+00:00\"}\r\n{\"app\":\"index\",\"message\":\"exception: failed to upgrade \\\"search_lucene\\\".\",\"level\":4,\"time\":\"2013-12-10t12:44:36+00:00\"}\r\n","closed_by":null}