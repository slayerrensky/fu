{"url":"https://api.github.com/repos/owncloud/core/issues/921","labels_url":"https://api.github.com/repos/owncloud/core/issues/921/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/921/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/921/events","html_url":"https://github.com/owncloud/core/issues/921","id":9313427,"number":921,"title":"oc-1581  -  csrf protection issue","user":{"login":"msrex","id":2625328,"avatar_url":"https://gravatar.com/avatar/24738c0908dad69b83af9cc534bcca80?d=https%3a%2f%2fidenticons.github.com%2ff02814cb1648a9552774c0f932619e91.png&r=x","gravatar_id":"24738c0908dad69b83af9cc534bcca80","url":"https://api.github.com/users/msrex","html_url":"https://github.com/msrex","followers_url":"https://api.github.com/users/msrex/followers","following_url":"https://api.github.com/users/msrex/following{/other_user}","gists_url":"https://api.github.com/users/msrex/gists{/gist_id}","starred_url":"https://api.github.com/users/msrex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/msrex/subscriptions","organizations_url":"https://api.github.com/users/msrex/orgs","repos_url":"https://api.github.com/users/msrex/repos","events_url":"https://api.github.com/users/msrex/events{/privacy}","received_events_url":"https://api.github.com/users/msrex/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"closed","assignee":null,"milestone":null,"comments":1,"created_at":"2012-12-16t04:02:39z","updated_at":"2012-12-16t11:01:24z","closed_at":"2012-12-16t11:01:24z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"from http://bugs.owncloud.org/thebuggenie/owncloud/issues/oc-1581\r\n\r\nunable to reproduce without access to vulture. but maybe @lukasreschke or somebody else knows something.\r\n\r\ndescription:\r\ni use owncloud 4.0.7 behind a reverse proxy called vulture. it acts has a reverse proxy, a waf and and authentication forwarder. i currently face a strange issue with the csrf protection mechanism wihtin owncloud (4.0.7). i am not a php programmer so i hope you could fix it in a next release or explain me why i have this bug\r\n\r\ni have a modified the code a little so i can trace where the bug is.\r\n\r\n          \r\n\r\n    // csrf protection\r\n    if(isset($_server['http_referer'])) $referer=$_server['http_referer']; else $referer='';\r\n    $refererhost=parse_url($referer);\r\n    if(isset($refererhost['host'])) $refererhost=$refererhost['host']; else $refererhost='';\r\n    $server=oc_helper::serverhost();\r\n    $serverhost=explode(':',$server);\r\n    $serverhost=$serverhost['0'];\r\n    echo \"serverhost : \", $serverhost, \"<br />\";\r\n    echo \"referer : \", $refererhost, \"<br />\";\r\n    if(($_server['request_method']=='post') and ($refererhost<>$serverhost)) {\r\n    echo \"fail 1 <br />\";\r\n    $url = oc_helper::serverprotocol().'://'.$server.oc::$webroot.'/index.php';\r\n    header(\"location: $url\");\r\n    echo \"fail2 <br />\";\r\n    exit();\r\n    }\r\n    else {\r\n    echo \"yes!<br />\";\r\n    }\r\n\r\n\r\n\r\n\r\nmy system looks like this:\r\n\r\ninternet --> vulture --> web serveur with owncloud --> mysql server backend\r\n\r\nwhen i connect to the url for owncloud, the reverse proxy acces the web page and populate the fields user and password with the user information i gave earlier in a web form (ldap user name and password) and then perform a post so i can access owncloud. it currently does not work with the csrf code. if i comment all the lines below, it works fine and i can go into owncloud\r\n\r\n    if(($_server['request_method']=='post') and ($refererhost<>$serverhost)) {\r\n    echo \"fail 1 <br />\";\r\n    $url = oc_helper::serverprotocol().'://'.$server.oc::$webroot.'/index.php';\r\n    header(\"location: $url\");\r\n    echo \"fail2 <br />\";\r\n    exit();\r\n    }\r\n\r\n\r\n\r\nwith the code modified code, i see that: - echo \"serverhost is displayed and is the same as referer - \"yes!\" is displayed\r\n\r\nso it could mean that the csrf test is ok. but in fact, i face the login screen again and again whatever i enter a valid username and password and the debug log keep saying \"{\"app\":\"core\",\"message\":\"redirecttodefaultpage\",\"level\":0,\"time\":1342115228}\"\r\n\r\nand now, if i comment the ligne\r\n\r\n    exit();\r\n\r\nthe \"yes\" test is displayed but this time, i do not have the issue and connect automatically to owncloud. i do not understand at all.. if commenting the \"exit\" line fix the issue it means that the \"if..\" test is true and the \"fail' should be displayed? but \"fail\" is never displayed, still commenting the \"exit\" line fix the issue.\r\n\r\ncan you help? thanks\r\n\r\nreproduction steps:\r\n- use a reverse proxy called vulture with web sso enable - install owncloud 4.0.7\r\n\r\n#1 comment posted by romain sep 10, 13:49\r\nhi, i haven't see an update on the ticket yet, maybe because of the hard work you all do on the next release. can someone just take it and add a comment? just to be sure that it will be investigated. thanks\r\n\r\n#2 comment posted by mtrichards dec 14, 15:58\r\nis this still an issue in 4.5.4? curious, and want to see if you are still having trouble.\r\n","closed_by":{"login":"lukasreschke","id":878997,"avatar_url":"https://gravatar.com/avatar/f080e75d370a4d8e550983a4898bcf3b?d=https%3a%2f%2fidenticons.github.com%2ff12e47d5bb5359a9f58e8217413be790.png&r=x","gravatar_id":"f080e75d370a4d8e550983a4898bcf3b","url":"https://api.github.com/users/lukasreschke","html_url":"https://github.com/lukasreschke","followers_url":"https://api.github.com/users/lukasreschke/followers","following_url":"https://api.github.com/users/lukasreschke/following{/other_user}","gists_url":"https://api.github.com/users/lukasreschke/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasreschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasreschke/subscriptions","organizations_url":"https://api.github.com/users/lukasreschke/orgs","repos_url":"https://api.github.com/users/lukasreschke/repos","events_url":"https://api.github.com/users/lukasreschke/events{/privacy}","received_events_url":"https://api.github.com/users/lukasreschke/received_events","type":"user","site_admin":false}}