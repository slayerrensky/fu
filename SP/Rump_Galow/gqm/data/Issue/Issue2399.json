{"url":"https://api.github.com/repos/owncloud/core/issues/2399","labels_url":"https://api.github.com/repos/owncloud/core/issues/2399/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/2399/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/2399/events","html_url":"https://github.com/owncloud/core/issues/2399","id":12112393,"number":2399,"title":"[5.0] endless db-queries from oc_users","user":{"login":"ad2012","id":2690733,"avatar_url":"https://gravatar.com/avatar/9a6e29bc987d8ed33905c43c46f608ed?d=https%3a%2f%2fidenticons.github.com%2f9bca8a4f26830ea15f6dadd600bea3a4.png&r=x","gravatar_id":"9a6e29bc987d8ed33905c43c46f608ed","url":"https://api.github.com/users/ad2012","html_url":"https://github.com/ad2012","followers_url":"https://api.github.com/users/ad2012/followers","following_url":"https://api.github.com/users/ad2012/following{/other_user}","gists_url":"https://api.github.com/users/ad2012/gists{/gist_id}","starred_url":"https://api.github.com/users/ad2012/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ad2012/subscriptions","organizations_url":"https://api.github.com/users/ad2012/orgs","repos_url":"https://api.github.com/users/ad2012/repos","events_url":"https://api.github.com/users/ad2012/events{/privacy}","received_events_url":"https://api.github.com/users/ad2012/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"},{"url":"https://api.github.com/repos/owncloud/core/labels/windows+server","name":"windows server","color":"0b02e1"}],"state":"closed","assignee":null,"milestone":null,"comments":14,"created_at":"2013-03-17t18:27:56z","updated_at":"2013-03-27t10:30:37z","closed_at":"2013-03-26t21:19:58z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\nonly a couple of queries\r\n\r\n### actual behaviour\r\na lot of queries (log files is >32mib in less then five minutes)\r\ncpu time of mysql is ~15% for >30sec\r\n\r\n### steps to reproduce\r\n1. do anything on owncloud\r\n2. \r\n3. \r\n\r\n### server configuration\r\noperating system: windows 2012 server\r\n\r\nweb server: apache 2.4\r\n\r\ndatabase: mysql 5.6\r\n\r\nphp version: 5.4.13\r\n\r\nowncloud version: 5.0\r\n\r\n### client configuration\r\nbrowser: firefox, ie10\r\n\r\noperating system: win7, win2012\r\n\r\n### logs\r\n#### mysql server log\r\n```\r\n\t\t   15 query\tselect count(*) from `oc_users` where lower(`uid`) = lower('testuser') limit 3\r\n\t\t   15 query\tselect * from `oc_users` where lower(`uid`) = lower('testuser')\r\n```\r\nrepeated a thousand times :/\r\n\r\n#### owncloud log (data/owncloud.log)\r\n```\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363448283}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541764}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541767}\r\n{\"app\":\"php\",\"message\":\"file_put_contents(upload\\/owncloud-5144918f59a3f\\/core.js-a196f0ec92412ef9d19f9c0fe6c378e1.gz): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#35\",\"level\":2,\"time\":1363541767}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541800}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541924}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541924}\r\n{\"app\":\"php\",\"message\":\"file_put_contents(upload\\/owncloud-5144918f59a3f\\/core.css-1310a86468f82ef5bec4e43d544ebd73.gz): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#35\",\"level\":2,\"time\":1363541924}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541924}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541927}\r\n{\"app\":\"php\",\"message\":\"file_put_contents(upload\\/owncloud-5144918f59a3f\\/core.js-a196f0ec92412ef9d19f9c0fe6c378e1.gz): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#35\",\"level\":2,\"time\":1363541927}\r\n{\"app\":\"php\",\"message\":\"opendir(d:\\/owncloud\\/testuser\\\\cache,d:\\/owncloud\\/testuser\\\\cache): das system kann den angegebenen pfad nicht finden. (code: 3) at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\files\\\\storage\\\\mappedlocal.php#47\",\"level\":2,\"time\":1363541959}\r\n{\"app\":\"php\",\"message\":\"opendir(d:\\/owncloud\\/testuser\\\\cache): failed to open dir: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\files\\\\storage\\\\mappedlocal.php#47\",\"level\":2,\"time\":1363541959}\r\n{\"app\":\"php\",\"message\":\"readdir() expects parameter 1 to be resource, boolean given at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\files\\\\storage\\\\mappedlocal.php#48\",\"level\":2,\"time\":1363541959}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541960}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541960}\r\n{\"app\":\"php\",\"message\":\"file_put_contents(upload\\/owncloud-5144918f59a3f\\/_owncloud_apps_files_css_files.css-6e786d2a660d871c03d0e8ef955dc49f.gz): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#35\",\"level\":2,\"time\":1363541960}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541960}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363541963}\r\n{\"app\":\"php\",\"message\":\"file_put_contents(upload\\/owncloud-5144918f59a3f\\/core.js-8c11bb88ee5f1fbacda23fc4d5c1d2b1.gz): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#35\",\"level\":2,\"time\":1363541963}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363542144}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363542144}\r\n{\"app\":\"php\",\"message\":\"file_put_contents(upload\\/owncloud-5144918f59a3f\\/core.css-1310a86468f82ef5bec4e43d544ebd73.gz): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#35\",\"level\":2,\"time\":1363542144}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363542144}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363542146}\r\n{\"app\":\"php\",\"message\":\"file_put_contents(upload\\/owncloud-5144918f59a3f\\/core.js-a196f0ec92412ef9d19f9c0fe6c378e1.gz): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#35\",\"level\":2,\"time\":1363542146}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363542167}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363542172}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363542172}\r\n{\"app\":\"php\",\"message\":\"file_put_contents(upload\\/owncloud-5144918f59a3f\\/_owncloud_apps_files_css_files.css-6e786d2a660d871c03d0e8ef955dc49f.gz): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#35\",\"level\":2,\"time\":1363542172}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for d:\\/owncloud\\/testuser\\/files\\\\2012-03-23-headhair-l-oreal-fix-max-gel-tecni-art-pdf at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\files\\\\storage\\\\mappedlocal.php#113\",\"level\":2,\"time\":1363542178}\r\n{\"app\":\"php\",\"message\":\"mkdir(): no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\cache\\\\fileglobal.php#14\",\"level\":2,\"time\":1363542483}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for d:\\/owncloud\\/testuser\\/files\\\\2012-03-23-headhair-l-oreal-fix-max-gel-tecni-art-pdf at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\files\\\\storage\\\\mappedlocal.php#113\",\"level\":2,\"time\":1363542486}\r\n{\"app\":\"php\",\"message\":\"allowed memory size of 134217728 bytes exhausted (tried to allocate 65488 bytes) at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\db.php#367\",\"level\":4,\"time\":1363542594}\r\n{\"app\":\"core\",\"message\":\"unable to rename, file is not writable : files\\/2012-03-23 headhair l_oreal fix max gel tecni art (2).pdf\",\"level\":3,\"time\":1363543340}\r\n{\"app\":\"php\",\"message\":\"filemtime(): stat failed for d:\\/owncloud\\/testuser\\/files\\\\2012-03-23-headhair-l-oreal-fix-max-gel-tecni-art-pdf at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\files\\\\storage\\\\mappedlocal.php#113\",\"level\":2,\"time\":1363543353}\r\n{\"app\":\"php\",\"message\":\"allowed memory size of 134217728 bytes exhausted (tried to allocate 65488 bytes) at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\db.php#367\",\"level\":4,\"time\":1363543479}\r\n{\"app\":\"php\",\"message\":\"fopen(d:\\/owncloud\\/testuser\\/files\\\\2012-03-23-headhair-l-oreal-fix-max-gel-tecni-art-pdf): failed to open stream: no such file or directory at c:\\\\inetpuba\\\\wwwroot\\\\owncloud\\\\lib\\\\files\\\\storage\\\\mappedlocal.php#173\",\"level\":2,\"time\":1363544231} \r\n```\r\n#### php error log\r\n```\r\n[17-mar-2013 17:46:42 utc] php fatal error:  allowed memory size of 134217728 bytes exhausted (tried to allocate 65488 bytes) in c:\\inetpuba\\wwwroot\\owncloud\\lib\\db.php on line 698\r\n\r\n[17-mar-2013 17:49:54 utc] php fatal error:  allowed memory size of 134217728 bytes exhausted (tried to allocate 65488 bytes) in c:\\inetpuba\\wwwroot\\owncloud\\lib\\db.php on line 367\r\n\r\n[17-mar-2013 18:01:57 utc] php fatal error:  allowed memory size of 134217728 bytes exhausted (tried to allocate 65488 bytes) in c:\\inetpuba\\wwwroot\\owncloud\\lib\\db.php on line 698\r\n\r\n[17-mar-2013 18:04:39 utc] php fatal error:  allowed memory size of 134217728 bytes exhausted (tried to allocate 65488 bytes) in c:\\inetpuba\\wwwroot\\owncloud\\lib\\db.php on line 367\r\n\r\n\r\n```\r\n","closed_by":{"login":"mtgap","id":1097106,"avatar_url":"https://gravatar.com/avatar/454a73ee5feeb428d0c163a48903332c?d=https%3a%2f%2fidenticons.github.com%2f52d29a66f285a1d61125dd69ac0766b2.png&r=x","gravatar_id":"454a73ee5feeb428d0c163a48903332c","url":"https://api.github.com/users/mtgap","html_url":"https://github.com/mtgap","followers_url":"https://api.github.com/users/mtgap/followers","following_url":"https://api.github.com/users/mtgap/following{/other_user}","gists_url":"https://api.github.com/users/mtgap/gists{/gist_id}","starred_url":"https://api.github.com/users/mtgap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mtgap/subscriptions","organizations_url":"https://api.github.com/users/mtgap/orgs","repos_url":"https://api.github.com/users/mtgap/repos","events_url":"https://api.github.com/users/mtgap/events{/privacy}","received_events_url":"https://api.github.com/users/mtgap/received_events","type":"user","site_admin":false}}