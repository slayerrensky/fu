{"url":"https://api.github.com/repos/owncloud/core/issues/5913","labels_url":"https://api.github.com/repos/owncloud/core/issues/5913/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5913/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5913/events","html_url":"https://github.com/owncloud/core/issues/5913","id":22823053,"number":5913,"title":"univention integration: errors in postinstall script, no database created etc.","user":{"login":"mbunkus","id":414282,"avatar_url":"https://gravatar.com/avatar/b009648d18d58ddd4c69351689f5c7ec?d=https%3a%2f%2fidenticons.github.com%2f4f540311753eea54e57545752d4f7239.png&r=x","gravatar_id":"b009648d18d58ddd4c69351689f5c7ec","url":"https://api.github.com/users/mbunkus","html_url":"https://github.com/mbunkus","followers_url":"https://api.github.com/users/mbunkus/followers","following_url":"https://api.github.com/users/mbunkus/following{/other_user}","gists_url":"https://api.github.com/users/mbunkus/gists{/gist_id}","starred_url":"https://api.github.com/users/mbunkus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mbunkus/subscriptions","organizations_url":"https://api.github.com/users/mbunkus/orgs","repos_url":"https://api.github.com/users/mbunkus/repos","events_url":"https://api.github.com/users/mbunkus/events{/privacy}","received_events_url":"https://api.github.com/users/mbunkus/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"closed","assignee":null,"milestone":null,"comments":10,"created_at":"2013-11-18t09:28:40z","updated_at":"2013-12-09t12:37:21z","closed_at":"2013-12-09t12:37:21z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"hey,\r\n\r\nfirst of all i apologize for filing this against the core package, but i haven't found where one could report serious errors in the [univention integration package](http://owncloud.org/support/ucs-integration/).\r\n\r\ni already know owncloud from personal use. now i'm trying to install it for a customer on a ucs 3.1 system (role: domaincontroller backup). when you install the `owncloud` package there are a tons of errors that result in the database not being initialized at all and therefore the owncloud installation itself being unusable. examples:\r\n\r\n```\r\n…\r\nsetting owncloud/group/enabledomainusers\r\nmodule: owncloud-cfg\r\nmodule: owncloud-cfg\r\ngrep: /var/www/owncloud/config/config.php: no such file or directory\r\ngrep: /var/www/owncloud/config/config.php: no such file or directory\r\ngrep: /var/www/owncloud/config/config.php: no such file or directory\r\nobject created: uid=owncloudsystemuser,cn=sysusers,cn=owncloud,dc=schneider,dc=ucs\r\n…\r\nobject modified: uid=linet2,ou=users,ou=stb,dc=customer,dc=ucs\r\nmysql: option '-d' requires an argument\r\n/usr/lib/univention-install/80owncloud.inst: line 166: [: : integer expression expected\r\nowncloud config: value for ldap_host is already set, skipping.\r\nmysql: option '-d' requires an argument\r\n…\r\n```\r\n\r\nthis is true, `/var/www/owncloud/config/config.php` does not exist. however, `autoconfig.php` does in the same directory as the `owncloud.postinst` script uses that name instead of `config.php`. the second set of error messages is due to mysql not being executed properly as the installation script could not extract the login information from the aforementioned `config.php`.\r\n\r\nso i've uninstalled the package and faked the existence by symlinking `config.php` to `autoconfig.php` before the installation. re-installed. now i get different error messages but similar to the second set mentioned above, again from wrong usage of the mysql client. debugging showed that extracting the parameters from the now-symlinked `config.php` fails. lines in this file look actually like this:\r\n\r\n```\r\n…\r\n    \"dbhost\" => 'localhost',\r\n    \"directory\" => \"/var/lib/owncloud\",\r\n    \"adminlogin\" => \"owncloudadmin\",\r\n…\r\n```\r\n\r\nthe parameter extraction in `/usr/lib/univention-installer/80owncloud.inst` tries to be clever but uses `cut` with the wrong parameters:\r\n\r\n```\r\nocmysqlus=$(grep dbuser /var/www/owncloud/config/config.php  | cut -d\"'\" -f4)\r\n…\r\n```\r\n\r\nthe problem is that the quote character used for the entries `dbuser`, `dbpassword`, `dbname` is `\"` and not `'`. note, though, that the file actually uses both types of quotes, so you should consider not using `cut` at all but other means.\r\n\r\nfor my experiments i've replaced those three lines with:\r\n\r\n```\r\nocmysqlus=$(awk '/dbuser/ { gsub(\"[\\\"'\\'']|,$\", \"\", $3); print $3 }' /var/www/owncloud/config/config.php)\r\nocmysqlpw=$(awk '/dbpass/ { gsub(\"[\\\"'\\'']|,$\", \"\", $3); print $3 }' /var/www/owncloud/config/config.php)\r\nocmysqldb=$(awk '/dbname/ { gsub(\"[\\\"'\\'']|,$\", \"\", $3); print $3 }' /var/www/owncloud/config/config.php)\r\n```\r\n\r\nthis has the advantage of being agnostic regarding the quotes used.\r\n\r\nafter replacing the aforementioned commands with my version i now get the error message that the database itself does not exist in the first place. that's quite correct, though i have no idea why. the `80owncloud.inst` script itself doesn't contain any `mysqladmin` commands, nor a `create database…` statement. so no big surprise there. neither is there such a command in `owncloud.postinst`! a mysql user is set up, yes, but not the database itself. but the database must be created either by the postinst script or the `80owncloud.inst` script, otherwise pre-seeding will obviously never work. you cannot rely on the web frontend itself creating it – that's too late.\r\n\r\nat this point i've given up. the package is in serious need of some love.","closed_by":{"login":"blizzz","id":2184312,"avatar_url":"https://gravatar.com/avatar/1898b25a9cb3aa1a0f0febd1359910b9?d=https%3a%2f%2fidenticons.github.com%2fca03acec6deadf508b75eb0cf9ba036c.png&r=x","gravatar_id":"1898b25a9cb3aa1a0f0febd1359910b9","url":"https://api.github.com/users/blizzz","html_url":"https://github.com/blizzz","followers_url":"https://api.github.com/users/blizzz/followers","following_url":"https://api.github.com/users/blizzz/following{/other_user}","gists_url":"https://api.github.com/users/blizzz/gists{/gist_id}","starred_url":"https://api.github.com/users/blizzz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blizzz/subscriptions","organizations_url":"https://api.github.com/users/blizzz/orgs","repos_url":"https://api.github.com/users/blizzz/repos","events_url":"https://api.github.com/users/blizzz/events{/privacy}","received_events_url":"https://api.github.com/users/blizzz/received_events","type":"user","site_admin":false}}