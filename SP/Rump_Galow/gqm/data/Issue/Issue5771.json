{"url":"https://api.github.com/repos/owncloud/core/issues/5771","labels_url":"https://api.github.com/repos/owncloud/core/issues/5771/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5771/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5771/events","html_url":"https://github.com/owncloud/core/issues/5771","id":22334705,"number":5771,"title":"external storage (owncloud / webdav): added file on client upload error","user":{"login":"derherrc","id":762994,"avatar_url":"https://gravatar.com/avatar/16343fb4d7c4653511ba56d7af90986c?d=https%3a%2f%2fidenticons.github.com%2fac50dcf8c5f2e373b7146432c091cc48.png&r=x","gravatar_id":"16343fb4d7c4653511ba56d7af90986c","url":"https://api.github.com/users/derherrc","html_url":"https://github.com/derherrc","followers_url":"https://api.github.com/users/derherrc/followers","following_url":"https://api.github.com/users/derherrc/following{/other_user}","gists_url":"https://api.github.com/users/derherrc/gists{/gist_id}","starred_url":"https://api.github.com/users/derherrc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/derherrc/subscriptions","organizations_url":"https://api.github.com/users/derherrc/orgs","repos_url":"https://api.github.com/users/derherrc/repos","events_url":"https://api.github.com/users/derherrc/events{/privacy}","received_events_url":"https://api.github.com/users/derherrc/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/app%3afiles_external","name":"app:files_external","color":"02d7e1"},{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"open","assignee":null,"milestone":null,"comments":7,"created_at":"2013-11-08t12:44:37z","updated_at":"2013-11-27t16:48:30z","closed_at":null,"pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\nclient application (desktop, mobile) syncs and pushes locally added file to server. \r\n\r\nin this case the path is included by making use of the internal app \"external storage support (version 0.2)\".\r\n\r\n### actual behaviour\r\nlocally added file is uploaded to server and generates an error \"bad request\" during the first attempt. during the following attempts error \"the server did not provide an etag\" is shown.\r\n\r\n### steps to reproduce\r\nremark: steps below reproduce issue on both: productive and blank-installation environments. both servers mentioned below are using owncloud 5.0.13.\r\n\r\n1. usera / servera: add new external storage: name \"shared\", type \"owncloud / webdav\", pointing to \"/\" (root) on serverb using userb using \"secure https://\".\r\n2. content of serverb, that existed before adding external storage folder on servera, is now shown on servera for usera. content is synced via client app to pc to folder \"shared\" correctly (using usera / servera settings).\r\n3. added file via web-interface, whether on servera or serverb, is synced on both servers and pc as well.\r\n4. added file to folder \"shared\" via pc (same as mentioned in step 2)  generates error during sync. by the way: adding and syncing files to owncloud outside \"shared\" folder works perfectly.\r\n\r\n### server configuration\r\nremark: configuration described below are equal for both servers (servera, serverb).\r\n\r\noperating system: centos 6\r\n\r\nweb server: apache/2.2.15 (centos)\r\n\r\ndatabase: mysql\r\n\r\nphp version: 5.5.1\r\n\r\nowncloud version: 5.0.13\r\n\r\n### client configuration\r\nbrowser: chrome (30), firefox (25)\r\n\r\noperating system: windows 7 (x86), ios 6.1.3\r\n\r\nclient app: owncloud desktop application for windows (1.4.2), owncloud 2013 ios 3.0.0\r\n\r\n### logs\r\n#### web server error log\r\n```\r\n[warn] [client 82.198.*******] mod_fcgid: stderr: resource not found.\r\n```\r\n\r\n#### owncloud log\r\n```\r\n{\"app\":\"webdav client\",\"message\":\"resource not found.\",\"level\":3,\"time\":\"2013-11-08t11:59:47+00:00\"}\r\n```\r\nremark: log shown above from servera. serverb does not report anything related to added file on pc.\r\n\r\n#### client log\r\n```\r\n11-08 13:32:26:812 >===================================== sync started for  \"owncloud\" \r\n11-08 13:32:26:823 void mirall::csyncthread::startsync() sync started \r\n11-08 13:32:26:823 starting to sync  qthread(0x2c69c30) qthread(0x966b9a8) \r\n11-08 13:32:26:823 #### update start #################################################### >> \r\n11-08 13:32:26:823 csync_update: journal: c:\\d***********o\\owncloud/.csync_journal.db\r\n11-08 13:32:26:826 csync_ftw:   => starting to ftw c:\\d***********o\\owncloud, read_from_db-flag for: 0\r\n11-08 13:32:26:827 csync_vio_stat: win32: stat-inode for c:\\d***********o\\owncloud/shared: 126896\r\n11-08 13:32:26:827 csync_ftw: uniq id from database: shared -> 527cd863cc5e2\r\n11-08 13:32:26:827 csync_walker: directory: c:\\d***********o\\owncloud/shared\r\n11-08 13:32:26:827 _csync_detect_update: ==> file: shared - hash 7772379496350463016, mtime: 1383913945\r\n11-08 13:32:26:827 _csync_detect_update: database entry found, compare: 1383913945 <-> 1383913553, md5: 527cd863cc5e2 <-> 527cd863cc5e2, inode: 126896 <-> 126896\r\n11-08 13:32:26:827 _csync_detect_update: file: shared, instruction: instruction_eval <<=\r\n11-08 13:32:26:827 csync_ftw:   => starting to ftw c:\\d***********o\\owncloud/shared, read_from_db-flag for: 0\r\n11-08 13:32:26:828 csync_vio_stat: win32: stat-inode for c:\\d***********o\\owncloud/shared/jellyfish.jpg: 119897\r\n11-08 13:32:26:828 csync_ftw: uniq id from database: shared/jellyfish.jpg -> <null>\r\n11-08 13:32:26:828 csync_walker: file: c:\\d***********o\\owncloud/shared/jellyfish.jpg\r\n11-08 13:32:26:828 _csync_detect_update: ==> file: shared/jellyfish.jpg - hash 17747217832291188055, mtime: 1247549551\r\n11-08 13:32:26:828 csync_statedb_get_stat_by_hash: no result record found for phash = 17747217832291188055\r\n11-08 13:32:26:829 _csync_detect_update: file: shared/jellyfish.jpg, instruction: instruction_new <<=\r\n11-08 13:32:26:829 csync_ftw:  <= closing walk for c:\\d***********o\\owncloud/shared with read_from_db 0\r\n11-08 13:32:26:829 csync_ftw:  <= closing walk for c:\\d***********o\\owncloud with read_from_db 0\r\n11-08 13:32:26:829 csync_update: update detection for local replica took 0.00 seconds walking 2 files.\r\n11-08 13:32:26:829 csync_ftw:   => starting to ftw ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav, read_from_db-flag for: 0\r\n11-08 13:32:26:829 csync_ftw: checking for read from db for ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav: 0\r\n11-08 13:32:26:829 oc_module: opendir method called on ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav\r\n11-08 13:32:26:829 oc_module: * scheme ownclouds\r\n11-08 13:32:26:829 oc_module: * host d**********o.uberspace.de\r\n11-08 13:32:26:829 oc_module: * port 0\r\n11-08 13:32:26:829 oc_module: * path /owncloud/remote.php/webdav\r\n11-08 13:32:26:829 oc_module: * user \r\n11-08 13:32:26:832 oc_module: ne_sock_init: 0\r\n11-08 13:32:26:833 oc_module: no proxy configured.\r\n11-08 13:32:26:920 oc_module: call the csync callback for ssl problems\r\n11-08 13:32:26:920 ssl fingerprint from neon:  \"16:87:56:9b:ed:a0:6b:25:f6:2b:04:30:99:f7:44:66:54:06:bb:a0\"  compared to verified:  \"16:87:56:9b:ed:a0:6b:25:f6:2b:04:30:99:f7:44:66:54:06:bb:a0\" \r\n11-08 13:32:26:920 oc_module: ## verify_ssl cert: 0\r\n11-08 13:32:26:961 status.php returns:  \"{\"installed\":\"true\",\"version\":\"5.0.25\",\"versionstring\":\"5.0.13\",\"edition\":\"\"}\"   0  reply:  qnetworkreplyimpl(0x966b538) \r\n11-08 13:32:26:962 #-------# oc found on  \"https://d**********o.uberspace.de/owncloud\" \r\n11-08 13:32:27:123 oc_module: simple propfind result code 207.\r\n11-08 13:32:27:123 oc_module: opendir returning handle 072fccc8\r\n11-08 13:32:27:123 oc_module: owncloud_stat ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared called\r\n11-08 13:32:27:123 csync_walker: directory: ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared\r\n11-08 13:32:27:124 _csync_detect_update: ==> file: shared - hash 7772379496350463016, mtime: 1383913553\r\n11-08 13:32:27:124 _csync_detect_update: database entry found, compare: 1383913553 <-> 1383913553, md5: 527cd863cc5e2 <-> 527cd863cc5e2, inode: 0 <-> 126896\r\n11-08 13:32:27:124 _csync_detect_update: file: shared, instruction: instruction_none <<=\r\n11-08 13:32:27:124 csync_ftw:   => starting to ftw ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared, read_from_db-flag for: 0\r\n11-08 13:32:27:125 oc_module: owncloud_stat ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared called\r\n11-08 13:32:27:125 oc_module: get file id for ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared: 527cd863cc5e2\r\n11-08 13:32:27:125 _check_read_from_db: compare directory ids for shared: 527cd863cc5e2 -> 527cd863cc5e2\r\n11-08 13:32:27:125 csync_ftw: checking for read from db for ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared: 1\r\n11-08 13:32:27:125 csync_vio_opendir: reading directory ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared from database\r\n11-08 13:32:27:125 csync_statedb_get_below_path: sql: select phash, path, inode, uid, gid, mode, modtime, type, md5 from metadata where path like('shared/%')\r\n11-08 13:32:27:126 csync_ftw:  <= closing walk for ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared with read_from_db 0\r\n11-08 13:32:27:126 oc_module: closedir method called 072fccc8!\r\n11-08 13:32:27:126 csync_ftw:  <= closing walk for ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav with read_from_db 0\r\n11-08 13:32:27:126 csync_update: update detection for remote replica took 0.30 seconds walking 1 files.\r\n11-08 13:32:27:126 <<#### update end ########################################################### \r\n11-08 13:32:27:126 _csync_merge_algorithm_visitor: instruction_sync      dir: shared\r\n11-08 13:32:27:126 _csync_merge_algorithm_visitor: instruction_new      file: shared/jellyfish.jpg\r\n11-08 13:32:27:126 csync_reconcile: reconciliation for local replica took 0.00 seconds visiting 2 files.\r\n11-08 13:32:27:127 _csync_merge_algorithm_visitor: instruction_none      dir: shared\r\n11-08 13:32:27:127 csync_reconcile: reconciliation for remote replica took 0.00 seconds visiting 1 files.\r\n11-08 13:32:27:155     * csync thread started \r\n11-08 13:32:27:156 check status.php from statusdialog. \r\n11-08 13:32:27:156 get request to   qurl( \"https://d**********o.uberspace.de/owncloud/status.php\" )  \r\n11-08 13:32:27:157 setting up host header:  \"d**********o.uberspace.de\" \r\n11-08 13:32:27:158 folder in overallstatus message:  mirall::folder(0x4f15ad8)  with name  \"owncloud\" \r\n11-08 13:32:27:160 sync state changed for folder  \"owncloud\" :  \"sync running\" \r\n11-08 13:32:27:128 csync_vio_stat: win32: stat-inode for c:\\d***********o\\owncloud/shared/jellyfish.jpg: 119897\r\n11-08 13:32:27:128 _csync_push_file: remote repository atomar push enabled for ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared/jellyfish.jpg (0).\r\n11-08 13:32:27:128 oc_module: => open called for ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared/jellyfish.jpg\r\n11-08 13:32:27:128 oc_module: stating directory ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared\r\n11-08 13:32:27:128 oc_module: owncloud_stat ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared called\r\n11-08 13:32:27:128 oc_module: directory of file to open exists.\r\n11-08 13:32:27:128 oc_module: put request on /owncloud/remote.php/webdav/shared/jellyfish.jpg!\r\n11-08 13:32:27:128 oc_module: sendfile handling request type put. fd 3\r\n11-08 13:32:27:129 hbf_splitlist: hbf_splitlist: block_size: 10485760 threshold: 10485760 st_size: 775702\r\n11-08 13:32:27:129 hbf_splitlist: hbf_splitlist: num_blocks: 1 rmainder: 775702 blk_size: 10485760\r\n11-08 13:32:27:129 hbf_splitlist: hbf_splitlist: created block 0   (start: 0  size: 775702)\r\n11-08 13:32:27:129 oc_module: about to send 1 block\r\n11-08 13:32:27:129 _hbf_dav_request: hbf: block: 0 , start: 0 and size: 775702\r\n11-08 13:32:27:298 status.php returns:  \"{\"installed\":\"true\",\"version\":\"5.0.25\",\"versionstring\":\"5.0.13\",\"edition\":\"\"}\"   0  reply:  qnetworkreplyimpl(0x966b8f8) \r\n11-08 13:32:27:299 #-------# oc found on  \"https://d**********o.uberspace.de/owncloud\" \r\n11-08 13:32:27:321 oc_module: chunk upload completed for 'ownclouds://d**********o.uberspace.de/owncloud/remote.php/webdav/shared/jellyfish.jpg' (775702 bytes out of 775702)\r\n11-08 13:32:31:898 _csync_push_file: file: c:\\d***********o\\owncloud/shared/jellyfish.jpg, command: sendfile, error: no error from errno 0\r\n11-08 13:32:31:898 _csync_push_file: remember chunk: 0  (transfer id -845174240 )\r\n11-08 13:32:31:898 _csync_report_parent_error: mark parent directoy `shared` as an error\r\n11-08 13:32:31:898 csync_propagate: propagation for local replica took 4.77 seconds visiting 2 files.\r\n11-08 13:32:31:898 csync_propagate: propagation for remote replica took 0.00 seconds visiting 1 files.\r\n11-08 13:32:31:902 [progress] progressed  775702  bytes in  1  files  in msec  4740 \r\n11-08 13:32:31:898 void mirall::csyncthread::startsync() sync finished \r\n11-08 13:32:31:899 csync_statedb_get_stat_by_hash: no result record found for phash = 17747217832291188055\r\n11-08 13:32:32:543 csync_statedb_write_progressinfo: insert into progress (phash, modtime, md5, chunk, transferid, error_count, tmpfile, error_string) values(17747217832291188055, 1247549551, '(null)', 0, -845174240, 1, '(null)', 'the server did not provide an etag.');\r\n11-08 13:32:32:631 _merge_and_write_statedb: writing the statedb of 2 files to disk took 0.73 seconds\r\n11-08 13:32:32:643 csync_statedb_close: successfully moved tmp db to original db.\r\n11-08 13:32:32:644 csync run took  5821  milliseconds \r\n11-08 13:32:32:646 -> csync finished slot for \"owncloud\" with error false \r\n11-08 13:32:32:647 sync is enabled - starting the polltimer again. \r\n11-08 13:32:32:649 starting event logging again in  2000  milliseconds \r\n11-08 13:32:32:709 oo folder slotsyncfinished: result:  3 \r\n11-08 13:32:32:710   ** error strings:  (\"datei shared: error within the directory\", \"datei shared/jellyfish.jpg: the server did not provide an etag.\") \r\n11-08 13:32:32:711     * owncloud csync thread finished with error \r\n11-08 13:32:32:713 check status.php from statusdialog. \r\n11-08 13:32:32:714 get request to   qurl( \"https://d**********o.uberspace.de/owncloud/status.php\" )  \r\n11-08 13:32:32:715 setting up host header:  \"d**********o.uberspace.de\" \r\n11-08 13:32:32:716 folder in overallstatus message:  mirall::folder(0x4f15ad8)  with name  \"owncloud\" \r\n11-08 13:32:32:718 sync state changed for folder  \"owncloud\" :  \"error\" \r\n11-08 13:32:32:719 setting up host header:  \"d**********o.uberspace.de\" \r\n11-08 13:32:32:720 <===================================== sync finished for  \"owncloud\" \r\n11-08 13:32:32:766 status.php returns:  \"{\"installed\":\"true\",\"version\":\"5.0.25\",\"versionstring\":\"5.0.13\",\"edition\":\"\"}\"   0  reply:  qnetworkreplyimpl(0x96685d8) \r\n11-08 13:32:32:768 #-------# oc found on  \"https://d**********o.uberspace.de/owncloud\" \r\n11-08 13:32:32:909 xx slotschedulefoldersync: folderqueue size:  0 \r\n11-08 13:32:34:656     * event notification  enabled \r\n```\r\nremark: log shown above from pc (owncloud.exe --logwindow) after adding file on pc.","closed_by":null}