{"url":"https://api.github.com/repos/owncloud/core/issues/5782","labels_url":"https://api.github.com/repos/owncloud/core/issues/5782/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5782/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5782/events","html_url":"https://github.com/owncloud/core/issues/5782","id":22381367,"number":5782,"title":"can't log in as administrator after upgrade: automatic login rejected","user":{"login":"jimc-leones","id":5742035,"avatar_url":"https://gravatar.com/avatar/bd585d6e48aea444cdc517003e57388a?d=https%3a%2f%2fidenticons.github.com%2f9f7f12be6887ba110ce4e14578ec6c76.png&r=x","gravatar_id":"bd585d6e48aea444cdc517003e57388a","url":"https://api.github.com/users/jimc-leones","html_url":"https://github.com/jimc-leones","followers_url":"https://api.github.com/users/jimc-leones/followers","following_url":"https://api.github.com/users/jimc-leones/following{/other_user}","gists_url":"https://api.github.com/users/jimc-leones/gists{/gist_id}","starred_url":"https://api.github.com/users/jimc-leones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimc-leones/subscriptions","organizations_url":"https://api.github.com/users/jimc-leones/orgs","repos_url":"https://api.github.com/users/jimc-leones/repos","events_url":"https://api.github.com/users/jimc-leones/events{/privacy}","received_events_url":"https://api.github.com/users/jimc-leones/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"closed","assignee":null,"milestone":null,"comments":5,"created_at":"2013-11-09t06:51:30z","updated_at":"2013-11-12t06:08:52z","closed_at":"2013-11-12t06:08:52z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"this is a continuation of https://github.com/owncloud/core/issues/854\r\nas @lukasreschke suggested.  \r\n\r\npreliminary steps:  this is exactly what i did.  i wish i could present\r\na 100% fatal procedure but what's shown here is really too much to \r\nreproduce and i can't guarantee that it will provoke the failure \r\nfor every developer. \r\n\r\n1.  at some time in the past i logged in to the owncloud web interface \r\nas myself and forgot to un-check the \"remember\" button.  i had these \r\ncookies: oc_username, oc_token, oc_remember_login.  \r\n\r\n2.  i upgraded from owncloud-5.0.12_20131017 to owncloud-5.0.13\r\n\r\n3.  i navigated to https://server.example.com/owncloud/ .  it did the \r\ndatabase schema upgrade (successfully), then i waited for it to \r\nauto-reload the page.  it showed my content without asking for a \r\npassword.  \r\n\r\n4.  i logged out (dropdown from user name, pick logout), then\r\ntried to login as the administrator (loginid and password).  \r\n\r\nwhat should have happened:  it logs me in.  \r\n\r\nwhat actually happened:  it expended some cpu time, then redisplayed\r\nthe login page saying (in red) \"automatic\r\nlogon rejected! if you did not change your password recently, your \r\naccount may be compromised! please change your password to secure your \r\naccount again.\"\r\n\r\ni then tried to log in as myself and got the same message.  each several\r\ntimes with careful checking of the password.  i suspect, but have no \r\nassurance, that the key action was to voluntarily log out as the \r\nremembered user and then try to log in as someone else.  at this point\r\ni still had the above listed cookies.  \r\n\r\nworkaround: as suggested by @tanghua in issue 854, i cleared these \r\nthree cookies, and it let me on.  i un-checked the \"remember\" box, and \r\nthe cookies were not replanted. \r\n\r\nserver configuration and versions:\r\n\r\nos: opensuse 12.3 linux\r\n\r\nwebserver: apache2-2.2.22-10.8.1.x86_64\r\n\r\ndatabase: sqlite3-3.7.14.1-2.1.1.x86_64\r\n\r\nphp: php5-5.3.17-3.4.1.x86_64 via apache2-mod_php5-5.3.17-3.4.1.x86_64\r\n\r\nowncloud: owncloud-5.0.13-12.1.noarch\r\n\r\nstorage: local files (ext4) (not a nas box or cloud server)\r\n\r\nweb browser: mozillafirefox-24.0-1.33.1.x86_64 for desktop linux, same os\r\n\r\nfor what it's worth, the server log says:\r\n\r\nwarning core authentication cookie rejected for user jimc [time]\r\n\r\nwarning php  non-static method oc_user::unsetmagicincookie() should not be called statically at /srv/www/htdocs/owncloud/lib/base.php#782 [time]\r\n\r\napproximately (not exactly) alternating, always rejecting jimc's cookie\r\neven when i logged in as administrator.  \r\n\r\ndiscussion: this problem badly needs to go away, as it detracts from \r\nowncloud's reputation for reliability, and makes owncloud unusable for\r\na number of users posting in issue 854, for example @mehturt who had been\r\nlocked out for a week.  reading that bug report i get a sense that \r\nbecause the error message invokes security there is a reluctance to fix\r\nthe bug without fully going over the original reasoning that led to\r\nincluding the security warning.  of course i don't have access to that\r\nreasoning.  \r\n\r\nwhy might a oc_remember_login cookie be rejected?  it expires (does it\r\nreally ever expire?); the server gets out of sync; the cookie is \r\nfraudulently altered and this is botched.  of these, i think that botched\r\nfraud is very unlikely (and non-botched fraudulent alteration is even \r\nmore unlikely; theft of the unaltered cookie is a credible threat).  \r\nin any case i agree with @jancborchardt and @lukasreschke in lukas'\r\npost dated \"11 months ago\" that the warning to the user should be \r\nremoved (but the log message should stay).  \r\n\r\nmy suggestion is, when the oc_remember_login cookie is rejected it\r\nshould unconditionally be cleared, so the situation is \r\nself-healing and users don't get locked out permanently, no matter\r\nhow wacko is the server's idea of valid cookies, as after a schema\r\nupgrade.  similarly there should be an obvious way to voluntarily no\r\nlonger be remembered, for example, log out from a remembered login\r\nand log in again as the remembered user but with the \"remember\"\r\ncheckbox cleared.  and if the checkbox is checked a new, non-corrupt\r\ncookie should be sent back.  \r\n\r\nwhat should really be the policy if a remembered cookie exists but \r\nyou log out and log in as someone else, like administrator?  i would\r\nsay that if the \"remember\" checkbox is checked, plant administrator's\r\ncookie (not a wise choice; should this be sabotaged specifically for\r\nadministrator?)  if unchecked you should neither look at nor rewrite\r\nthe cookie, unless it matches the logging-in user, in which case you\r\nclear it.\r\n\r\nanother suggestion: the three cookies seem to be present or absent as\r\na set, and a single bigger cookie is easier on the client and the \r\nserver.\r\n\r\nfor the users who don't know how to clear cookies by hand, see \r\nhttps://support.mozilla.org/en-us/kb/delete-cookies-remove-info-websites-stored\r\n\r\nfor the search string, which they refer to as the \"name of the site\", \r\nspecify \"oc_\".  toss the three cookies oc_username, oc_token, \r\noc_remember_login.  you can multiple-select all of them at once.  \r\n\r\n","closed_by":{"login":"jimc-leones","id":5742035,"avatar_url":"https://gravatar.com/avatar/bd585d6e48aea444cdc517003e57388a?d=https%3a%2f%2fidenticons.github.com%2f9f7f12be6887ba110ce4e14578ec6c76.png&r=x","gravatar_id":"bd585d6e48aea444cdc517003e57388a","url":"https://api.github.com/users/jimc-leones","html_url":"https://github.com/jimc-leones","followers_url":"https://api.github.com/users/jimc-leones/followers","following_url":"https://api.github.com/users/jimc-leones/following{/other_user}","gists_url":"https://api.github.com/users/jimc-leones/gists{/gist_id}","starred_url":"https://api.github.com/users/jimc-leones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimc-leones/subscriptions","organizations_url":"https://api.github.com/users/jimc-leones/orgs","repos_url":"https://api.github.com/users/jimc-leones/repos","events_url":"https://api.github.com/users/jimc-leones/events{/privacy}","received_events_url":"https://api.github.com/users/jimc-leones/received_events","type":"user","site_admin":false}}