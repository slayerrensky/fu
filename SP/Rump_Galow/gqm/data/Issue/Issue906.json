{"url":"https://api.github.com/repos/owncloud/core/issues/906","labels_url":"https://api.github.com/repos/owncloud/core/issues/906/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/906/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/906/events","html_url":"https://github.com/owncloud/core/issues/906","id":9299915,"number":906,"title":"oc-1883  -  fail to login when deployed behind 2 cascading reverse proxies. ","user":{"login":"msrex","id":2625328,"avatar_url":"https://gravatar.com/avatar/24738c0908dad69b83af9cc534bcca80?d=https%3a%2f%2fidenticons.github.com%2ff02814cb1648a9552774c0f932619e91.png&r=x","gravatar_id":"24738c0908dad69b83af9cc534bcca80","url":"https://api.github.com/users/msrex","html_url":"https://github.com/msrex","followers_url":"https://api.github.com/users/msrex/followers","following_url":"https://api.github.com/users/msrex/following{/other_user}","gists_url":"https://api.github.com/users/msrex/gists{/gist_id}","starred_url":"https://api.github.com/users/msrex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/msrex/subscriptions","organizations_url":"https://api.github.com/users/msrex/orgs","repos_url":"https://api.github.com/users/msrex/repos","events_url":"https://api.github.com/users/msrex/events{/privacy}","received_events_url":"https://api.github.com/users/msrex/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"closed","assignee":null,"milestone":null,"comments":1,"created_at":"2012-12-14t22:40:53z","updated_at":"2012-12-14t22:47:09z","closed_at":"2012-12-14t22:47:09z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"from http://bugs.owncloud.org/thebuggenie/owncloud/issues/oc-1883\r\n\r\nunable to reproduce as i lack 2 chained reverse proxies. but the code (which seems to have moved into request.php) does not have the proposed fix.\r\n\r\ndescription:\r\nowncloud, version 4.0.7 i deployed the service behind 2 reverse proxies as follows:\r\n\r\nbastion-host-reverse-proxy -> in-lan-reverse-proxy -> owncloud-server.\r\n\r\nthe issue is caused by a \"wrong\" handling of the http_x_forwarded_host header.\r\n\r\nowncloud uses the array_pop() to get the last value of the header, but it should pick the first one using array_shift(), cause the first one is the name of the host seen by the client and it is the one that should be used in order to manage the new session.\r\n\r\ni also noticed a \"strict warning\" each time that the explode() method is called with multiple reverse proxies.\r\n\r\ni attached to this report (into the \"reproduction steps\") a small patch that fixes both the issues.\r\n\r\n\r\nreproduction steps:\r\njust deploy owncloud behind a chain of 2 reverse proxies.\r\n\r\nnote: since i'm not able to upload the patch as attachment, im copy/pasting it here:\r\n\r\n    --- lib/helper.php 2012-08-14 20:11:17.000000000 +0200\r\n    +++ lib/helper.php 2012-09-28 11:50:12.000000000 +0200\r\n    @@ -77,7 +77,12 @@\r\n    public static function serverhost() {\r\n    if (isset($_server['http_x_forwarded_host'])) {\r\n    if (strpos($_server['http_x_forwarded_host'], \",\") !== false) {\r\n    -\t$host = trim(array_pop(explode(\",\", $_server['http_x_forwarded_host'])));\r\n    +\t/* mcm: fix for multiple reverse proxies.\r\n    + the user always sees only the first\r\n    + proxy, so we need to ger first element\r\n    + of this header */\r\n    +\t$tmp = explode(\",\", $_server['http_x_forwarded_host']);\r\n    +\t$host = trim(array_shift($tmp));\r\n    }\r\n    else{\r\n    $host=$_server['http_x_forwarded_host'];\r\n\r\n","closed_by":{"login":"karlitschek","id":867445,"avatar_url":"https://gravatar.com/avatar/87ce2b4531ee1a0c32b50e0d8f049224?d=https%3a%2f%2fidenticons.github.com%2f06e7098636caebfc9c30c9f52eb905df.png&r=x","gravatar_id":"87ce2b4531ee1a0c32b50e0d8f049224","url":"https://api.github.com/users/karlitschek","html_url":"https://github.com/karlitschek","followers_url":"https://api.github.com/users/karlitschek/followers","following_url":"https://api.github.com/users/karlitschek/following{/other_user}","gists_url":"https://api.github.com/users/karlitschek/gists{/gist_id}","starred_url":"https://api.github.com/users/karlitschek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/karlitschek/subscriptions","organizations_url":"https://api.github.com/users/karlitschek/orgs","repos_url":"https://api.github.com/users/karlitschek/repos","events_url":"https://api.github.com/users/karlitschek/events{/privacy}","received_events_url":"https://api.github.com/users/karlitschek/received_events","type":"user","site_admin":false}}