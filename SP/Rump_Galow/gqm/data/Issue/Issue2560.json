{"url":"https://api.github.com/repos/owncloud/core/issues/2560","labels_url":"https://api.github.com/repos/owncloud/core/issues/2560/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/2560/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/2560/events","html_url":"https://github.com/owncloud/core/issues/2560","id":12402395,"number":2560,"title":"enhancement: file hash creation and file scanning","user":{"login":"mmattel","id":3321281,"avatar_url":"https://gravatar.com/avatar/2d576241f3ac901ec52f1ec4a9c3b77b?d=https%3a%2f%2fidenticons.github.com%2f62fba4fe6711d41fdbfc7ccc04efb8f4.png&r=x","gravatar_id":"2d576241f3ac901ec52f1ec4a9c3b77b","url":"https://api.github.com/users/mmattel","html_url":"https://github.com/mmattel","followers_url":"https://api.github.com/users/mmattel/followers","following_url":"https://api.github.com/users/mmattel/following{/other_user}","gists_url":"https://api.github.com/users/mmattel/gists{/gist_id}","starred_url":"https://api.github.com/users/mmattel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mmattel/subscriptions","organizations_url":"https://api.github.com/users/mmattel/orgs","repos_url":"https://api.github.com/users/mmattel/repos","events_url":"https://api.github.com/users/mmattel/events{/privacy}","received_events_url":"https://api.github.com/users/mmattel/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/app%3afiles","name":"app:files","color":"02d7e1"},{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"closed","assignee":null,"milestone":null,"comments":3,"created_at":"2013-03-25t14:30:31z","updated_at":"2013-08-07t14:20:32z","closed_at":"2013-08-07t14:20:32z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"ubuntu 12.04 lts, oc from github master (core, apps, 3rdparty) from 23.03 ~16:00\r\noc installed from scratch with mysql, oc and mysql is on a nfs mount point\r\ni deleted the current oc install, cleared the db and db oc_user and down/uploaded the files.\r\nclient: w7/opera\r\ntwo folders mounted from ubuntu via smb:\r\n  one music   folder containing ~12.500 files\r\n  one picture folder containing ~17.000 files\r\nthose two folders are added via the external local storage app as local drives\r\nmysql, nfs and cifs have been tuned\r\nto tune php, i installed and configured fcgid and apc\r\n\r\ni have multiple terminal sessions open to monitor owncloud.log, apache-error.log, mysql.log, htop ect\r\n\r\n# problem 1\r\nwhen you add the drive via the app, sql statements are set to prepare oc. but nothing more happens. you have to leave the administration screen and click eg to files to initiate the next action in oc, which is creating hashes for files found in the drive mapped. if you have many files to process, this takes much time to create the hashes, but there is no disk access reading the files, only db queries. you can watch and often read the sql statements coming in.\r\nduring this time, you can click into the directory and you can see files, but clicking in eg gallery shows no folder containing pictures. if hashing is done for the drive mapped, gallery shows first time possible some content â€“ if you do a browser refresh. as said, before it stays empty. this leads to the idea during hashing, gallery is broken. also memory and cpu usage is low, no swapping. cpu is peak 25% for php (on a 4 core machine) and memory in total is less than 310mb used (see screenshot). what happens in addition, when you logoff during hashing runs, hashing stops. this is in the current implementation by nature as the user is part of the db entry. the consequence is, that hashing does not get finished and has to restart / continue on next user logon.\r\n\r\n# problem 2:\r\nsimilar to problem 1, but now when hashing is done and you click on music, music starts to create db-entries for music files found. this is not music app related but oc backend related. the first bad thing is, that when you log off, scanning stops. not immediate, but after a while. also pressing â€œpauseâ€? has no or sometimes a action with big delay. this means that you have to be logged on up to the point everything is scanned and do nothing. i did several tries with fresh blank installs and it was not done even over night and i have a well performing environment (see below)â€¦ second, during scanning, files are downloaded to get analyzed and db-data is written. a.) here i see a huge performance problem. my backend is able to read and write in high values, but only a fraction is used. music is on ubuntu mounted smb and can be read with +60mbytes/s. monitoring the backend i see maximum 1/10 of the possible thruput. and third, scanning <never> got finished and stopped without any error or complaint. no music data was shown, and ever if i rescan, i end up getting nothing. i also have seen in the mysql log rollbacks, especially when i logged off. maybe this all is because of many music files to be processed and with only a view files this does not come up.\r\n\r\n# io test to local disk / storage:\r\nsudo time sh -c \"dd if=/dev/zero of=testfile bs=19k count=5k && sync\"\r\nsmb: \twrite: bs=19k=15mb/s, bs=109k=35mb/s\tread: bs:19k=62mb/s, bs:109k=70mb/s\r\nnfs: \twrite 59mb/s very little difference between read and write\r\nlocal: \twrite 109mb/s\r\n(note: with this data, i can do close to full smb reads and full nfs writes concurrently to saturate my gbe wireâ€¦ which i have tested !)\r\n\r\nmysql test (sysbench, oltp r/w):\r\n    transactions:\t\t\t100001\t\t(809.56 per sec.)\r\n    deadlocks:\t\t\t0\t\t(0.00 per sec.)\r\n    read/write requests:\t\t1900019\t(15381.62 per sec.)\r\n    other operations:\t\t200002\t\t(1619.12 per sec.)\r\n\r\n\r\n# suggestions:\r\n-\thashing and scanning should be disconnected from user logoff, started yes, but afterwards running independent.\r\nmaybe to be monitored by the oc admin\r\n-\ta hint should show up (eg in foles) that oc is hashing and therefore other apps may not have the full view\r\n(different colored folder, marker ect)\r\n-\tthere should be (beside a progess bar) a ticker running telling how many files are done versus to be done.\r\nthe progress bar is not very helpful, because with many files, the progressbar is restarting many times from zero and you do not know where you are\r\n-\ttriggering of hashing and scanning should not be initiated by pressing a app, but at least when adding the drive\r\n\r\nquestion: how is rescanning in case of a source file/folder change (deletion, added, update) made/initiated?\r\n\r\n![htop 2](https://f.cloud.github.com/assets/3321281/298214/f7475212-9556-11e2-979e-e74a8ffbd1b3.jpg)\r\n","closed_by":{"login":"jancborchardt","id":925062,"avatar_url":"https://gravatar.com/avatar/2fd3f4d5d762955e5b603794a888fa97?d=https%3a%2f%2fidenticons.github.com%2f84ec51f9ceed468217d4e13abf78da9c.png&r=x","gravatar_id":"2fd3f4d5d762955e5b603794a888fa97","url":"https://api.github.com/users/jancborchardt","html_url":"https://github.com/jancborchardt","followers_url":"https://api.github.com/users/jancborchardt/followers","following_url":"https://api.github.com/users/jancborchardt/following{/other_user}","gists_url":"https://api.github.com/users/jancborchardt/gists{/gist_id}","starred_url":"https://api.github.com/users/jancborchardt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jancborchardt/subscriptions","organizations_url":"https://api.github.com/users/jancborchardt/orgs","repos_url":"https://api.github.com/users/jancborchardt/repos","events_url":"https://api.github.com/users/jancborchardt/events{/privacy}","received_events_url":"https://api.github.com/users/jancborchardt/received_events","type":"user","site_admin":false}}