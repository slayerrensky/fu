{"url":"https://api.github.com/repos/owncloud/core/issues/4574","labels_url":"https://api.github.com/repos/owncloud/core/issues/4574/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/4574/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/4574/events","html_url":"https://github.com/owncloud/core/issues/4574","id":18532232,"number":4574,"title":"http basic auth + csrf protection => failed xhr requests","user":{"login":"houbaastef","id":3155613,"avatar_url":"https://gravatar.com/avatar/32823b0a274cda91f08748ce7fb7d256?d=https%3a%2f%2fidenticons.github.com%2f9ddec8c1c6282a080e6d865379fcb49a.png&r=x","gravatar_id":"32823b0a274cda91f08748ce7fb7d256","url":"https://api.github.com/users/houbaastef","html_url":"https://github.com/houbaastef","followers_url":"https://api.github.com/users/houbaastef/followers","following_url":"https://api.github.com/users/houbaastef/following{/other_user}","gists_url":"https://api.github.com/users/houbaastef/gists{/gist_id}","starred_url":"https://api.github.com/users/houbaastef/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/houbaastef/subscriptions","organizations_url":"https://api.github.com/users/houbaastef/orgs","repos_url":"https://api.github.com/users/houbaastef/repos","events_url":"https://api.github.com/users/houbaastef/events{/privacy}","received_events_url":"https://api.github.com/users/houbaastef/received_events","type":"user","site_admin":false},"labels":[],"state":"open","assignee":null,"milestone":null,"comments":7,"created_at":"2013-08-26t03:20:22z","updated_at":"2013-09-05t22:46:29z","closed_at":null,"pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"hi, i just spent my night tracking down this one...\r\nowncloud : 5.0.10\r\nhttp basic authentication (with apache 2.4, and ldap as backend)\r\nbrowser : not important\r\nos : not important\r\n\r\nsymptoms : when i try to upload file with web interface in \"file app\", or when i try to submit a new bookmark in \"bookmark app\", action fails with this message : \"session has expired, reload the page\".\r\n\r\ni figured out that a new session is regenerated each time i request a page in owncloud, with a different session id. thus requesttoken is not maintained through different requests.\r\n\r\nafter a few hours of digging, i figured that oc::trybasicauthlogin calls oc_user::isloggedin. and oc_user calls session_regenerate_id...\r\n\r\nthis behaviour is ok for usual form login : we want session to be reinitialized after form login. but not with http basic auth !\r\n\r\nfix is quite trivial when you know the problem: just add two lines to trybasicauthlogin in lib/base.php\r\n\r\nprotected static function trybasicauthlogin() {\r\n                if (!isset($_server[\"php_auth_user\"])\r\n                        || !isset($_server[\"php_auth_pw\"])\r\n                ) {\r\n                        return false;\r\n                }\r\n                oc_app::loadapps(array('authentication'));\r\n                if (!oc_user::isloggedin()) {   <----- here !!!!\r\n                        if (oc_user::login($_server[\"php_auth_user\"], $_server[\"php_auth_pw\"])) {\r\n                             //oc_log::write('core',\"logged in with http authentication\", oc_log::debug);\r\n                             oc_user::unsetmagicincookie();\r\n                             $_server['http_requesttoken'] = oc_util::callregister();\r\n                        }\r\n                }\r\n                return true;\r\n        }\r\n\r\nregards,\r\nstephane\r\n\r\n","closed_by":{"login":"houbaastef","id":3155613,"avatar_url":"https://gravatar.com/avatar/32823b0a274cda91f08748ce7fb7d256?d=https%3a%2f%2fidenticons.github.com%2f9ddec8c1c6282a080e6d865379fcb49a.png&r=x","gravatar_id":"32823b0a274cda91f08748ce7fb7d256","url":"https://api.github.com/users/houbaastef","html_url":"https://github.com/houbaastef","followers_url":"https://api.github.com/users/houbaastef/followers","following_url":"https://api.github.com/users/houbaastef/following{/other_user}","gists_url":"https://api.github.com/users/houbaastef/gists{/gist_id}","starred_url":"https://api.github.com/users/houbaastef/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/houbaastef/subscriptions","organizations_url":"https://api.github.com/users/houbaastef/orgs","repos_url":"https://api.github.com/users/houbaastef/repos","events_url":"https://api.github.com/users/houbaastef/events{/privacy}","received_events_url":"https://api.github.com/users/houbaastef/received_events","type":"user","site_admin":false}}