{"url":"https://api.github.com/repos/owncloud/core/issues/5557","labels_url":"https://api.github.com/repos/owncloud/core/issues/5557/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5557/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5557/events","html_url":"https://github.com/owncloud/core/issues/5557","id":21601329,"number":5557,"title":"504 gateway time-out when download huge directory or files","user":{"login":"kippix","id":5775952,"avatar_url":"https://gravatar.com/avatar/827241394c5eebf0a57067bf918f90d0?d=https%3a%2f%2fidenticons.github.com%2fa46ea034562efcc75b3e1f022c509b5d.png&r=x","gravatar_id":"827241394c5eebf0a57067bf918f90d0","url":"https://api.github.com/users/kippix","html_url":"https://github.com/kippix","followers_url":"https://api.github.com/users/kippix/followers","following_url":"https://api.github.com/users/kippix/following{/other_user}","gists_url":"https://api.github.com/users/kippix/gists{/gist_id}","starred_url":"https://api.github.com/users/kippix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kippix/subscriptions","organizations_url":"https://api.github.com/users/kippix/orgs","repos_url":"https://api.github.com/users/kippix/repos","events_url":"https://api.github.com/users/kippix/events{/privacy}","received_events_url":"https://api.github.com/users/kippix/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"open","assignee":null,"milestone":null,"comments":2,"created_at":"2013-10-25t16:32:14z","updated_at":"2013-12-14t17:24:45z","closed_at":null,"pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"hi, \r\n\r\ni self hosted owncloud server behind a nginx proxy.  and owncloud is provided by another nginx webserver and php-fpm. \r\n\r\nmy environment is like this \r\nsurfers ] ----- [ nginx proxy] ----- [nginx webserver] --[php-fpm processing]\r\n\r\nowncloud version: 5.0.11\r\nwebserver: nginx\r\ndatabase: sqlite\r\nos: linux /debian\r\nphp version: 5.4\r\n\r\nthe issue appear when i want to download huge directory or files. php-fpm launch a zip prossessing task. so it's takes a high load, but it's not the problem.\r\nat this time, php-fpm process may take a lot of time, like 3 ~5 minutes or more, and i think that's the problem.\r\nthe browser close the connexion because http response is too long. see my logs : \r\n\r\n```\r\n2013/10/24 19:40:24 [error] 1044116#0: *24213 upstream timed out (110: connection timed out) while reading response header from upstream, cli\r\nent: 82.235.23.34, server: public.foobar.fr, request: \"get /index.php/apps/files/ajax/download.php?files=flo&dir=%2fevg%20olivier http/1.1\r\n\", upstream: \"http://10.0.0.4:80/index.php/apps/files/ajax/download.php?files=flo&dir=%2fevg%20olivier\", host: \"public.foobar.fr\", referrer\r\n: \"https://public.foobar.fr/index.php/apps/files?dir=//evg%20olivier\r\n```\r\n\r\nto avoid the problem a have modify my proxy nginx and nginx webserver like this\r\n```\r\n        client_max_body_size   5g;\r\n        client_body_timeout     600s;\r\n        client_header_timeout   600s;\r\n```\r\nand php-fpm pool like this \r\n```\r\n[public-owncloud]\r\nlisten = 127.0.0.1:9001\r\nuser = www-data\r\ngroup = www-data\r\n#request_slowlog_timeout = 5s\r\n#slowlog = /var/log/php-fpm.slowlog-public.log\r\nlisten.allowed_clients = 127.0.0.1\r\npm = dynamic\r\npm.max_children = 100\r\npm.start_servers = 10\r\npm.min_spare_servers = 10\r\npm.max_spare_servers = 60\r\npm.max_requests = 2000\r\nlisten.backlog = -1\r\npm.status_path = /status\r\nrequest_terminate_timeout = 600s\r\nrlimit_files = 131072\r\nrlimit_core = unlimited\r\ncatch_workers_output = yes\r\nenv[hostname] = $hostname\r\nenv[tmp] = /tmp\r\nenv[tmpdir] = /tmp\r\nenv[temp] = /tmp\r\n\r\n\r\n;php_admin_flag[log_errors]=on\r\nphp_admin_value[memory_limit] = 5g\r\nphp_admin_value[post_max_size] = 5g\r\nphp_admin_value[upload_max_filesize] = 5g\r\nphp_admin_value[max_file_uploads] = 1000\r\nphp_admin_value[max_execution_time] = 86400\r\nphp_admin_value[max_input_time] = 3600\r\n\r\n```\r\n\r\nbut it's not a solution and it don't work any time. i think the best is to implement some sort of heartbeat to the server to prevent such timeouts.\r\n\r\n\r\n\r\n","closed_by":null}