{"url":"https://api.github.com/repos/owncloud/core/issues/2796","labels_url":"https://api.github.com/repos/owncloud/core/issues/2796/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/2796/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/2796/events","html_url":"https://github.com/owncloud/core/issues/2796","id":12937879,"number":2796,"title":"shared files filesize subtracted from quota + fix/patch","user":{"login":"tron65","id":3971881,"avatar_url":"https://gravatar.com/avatar/6c2c99aff01878dc9e593d0dd2e1b80b?d=https%3a%2f%2fidenticons.github.com%2fb29464856f6cdee4025e291ae644baba.png&r=x","gravatar_id":"6c2c99aff01878dc9e593d0dd2e1b80b","url":"https://api.github.com/users/tron65","html_url":"https://github.com/tron65","followers_url":"https://api.github.com/users/tron65/followers","following_url":"https://api.github.com/users/tron65/following{/other_user}","gists_url":"https://api.github.com/users/tron65/gists{/gist_id}","starred_url":"https://api.github.com/users/tron65/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tron65/subscriptions","organizations_url":"https://api.github.com/users/tron65/orgs","repos_url":"https://api.github.com/users/tron65/repos","events_url":"https://api.github.com/users/tron65/events{/privacy}","received_events_url":"https://api.github.com/users/tron65/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/app%3afiles","name":"app:files","color":"02d7e1"},{"url":"https://api.github.com/repos/owncloud/core/labels/bug","name":"bug","color":"fc2929"}],"state":"closed","assignee":null,"milestone":null,"comments":26,"created_at":"2013-04-08t18:43:37z","updated_at":"2013-11-25t22:59:04z","closed_at":"2013-11-25t22:59:04z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"### expected behaviour\r\nuser a has quota of 5gb\r\nuser b has quota of 5gb\r\n\r\nuser a owns files of summary size 2gb\r\nuser b owns files of summary size 4gb\r\n\r\nuser b shares 3gb with user a\r\n\r\nuser a has still 3gb free space\r\n\r\n\r\n### actual behaviour\r\n\r\nuser a has no free space left, his 2gb + shared 3gb fill up his quota\r\n\r\n### steps to reproduce\r\n\r\nshould be obvious from the above\r\n\r\n### server configuration\r\noperating system:\r\ndebian wheezy\r\n\r\nweb server: \r\napache 2.2.22-13\r\n\r\ndatabase:\r\nmysql 5.5.30+dfsg-1\r\n\r\nphp version:\r\nphp5 5.4.4-14\r\n\r\nowncloud version:\r\n5.0.3-0\r\n\r\n\r\n\r\nfix:\r\n\r\nfor file lib/helper.php\r\n```\r\n--- helper.php.orig     2013-04-08 20:15:12.071656928 +0200\r\n+++ helper.php  2013-04-08 20:15:51.506027881 +0200\r\n@@ -801,7 +801,8 @@\r\n         */\r\n        public static function getstorageinfo() {\r\n                $rootinfo = \\oc\\files\\filesystem::getfileinfo('/');\r\n-               $used = $rootinfo['size'];\r\n+               $sharedinfo = \\oc\\files\\filesystem::getfileinfo('/shared');\r\n+               $used = $rootinfo['size'] - $sharedinfo['size'];\r\n                if ($used < 0) {\r\n                        $used = 0;\r\n                }\r\n\r\n```\r\n\r\nfor file lib/fileproxy/quota.php\r\n\r\n```\r\n\r\n--- quota.php.orig      2013-04-08 20:08:48.663494593 +0200\r\n+++ quota.php   2013-04-08 20:12:26.102512891 +0200\r\n@@ -75,7 +75,13 @@\r\n                $view = new \\oc\\files\\view(\"/\".$owner.\"/files\");\r\n \r\n                $rootinfo = $view->getfileinfo('/');\r\n+               $sharedinfo = $view->getfileinfo('/shared');\r\n+\r\n                $usedspace = isset($rootinfo['size'])?$rootinfo['size']:0;\r\n+               $sharedspace = isset($sharedinfo['size'])?$sharedinfo['size']:0;\r\n+\r\n+               $usedspace = $usedspace - $sharedspace;\r\n+\r\n                return $totalspace - $usedspace;\r\n        }\r\n \r\n```","closed_by":{"login":"pvince81","id":277525,"avatar_url":"https://gravatar.com/avatar/e446b529679416eb70eafb4ca4da5bbe?d=https%3a%2f%2fidenticons.github.com%2f89d7c394e6dcdf87a91c75ac3b2ccbe8.png&r=x","gravatar_id":"e446b529679416eb70eafb4ca4da5bbe","url":"https://api.github.com/users/pvince81","html_url":"https://github.com/pvince81","followers_url":"https://api.github.com/users/pvince81/followers","following_url":"https://api.github.com/users/pvince81/following{/other_user}","gists_url":"https://api.github.com/users/pvince81/gists{/gist_id}","starred_url":"https://api.github.com/users/pvince81/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pvince81/subscriptions","organizations_url":"https://api.github.com/users/pvince81/orgs","repos_url":"https://api.github.com/users/pvince81/repos","events_url":"https://api.github.com/users/pvince81/events{/privacy}","received_events_url":"https://api.github.com/users/pvince81/received_events","type":"user","site_admin":false}}