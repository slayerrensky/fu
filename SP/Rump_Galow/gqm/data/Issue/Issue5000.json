{"url":"https://api.github.com/repos/owncloud/core/issues/5000","labels_url":"https://api.github.com/repos/owncloud/core/issues/5000/labels{/name}","comments_url":"https://api.github.com/repos/owncloud/core/issues/5000/comments","events_url":"https://api.github.com/repos/owncloud/core/issues/5000/events","html_url":"https://github.com/owncloud/core/issues/5000","id":20101332,"number":5000,"title":"severe performance issues with 5.0.11 maybe infinite loop","user":{"login":"roha4000","id":3509963,"avatar_url":"https://gravatar.com/avatar/95b8e2447ddfb0836c2c4ad8489b9ab2?d=https%3a%2f%2fidenticons.github.com%2f8c94cd35b69d168f0351fdb3c2eae3d7.png&r=x","gravatar_id":"95b8e2447ddfb0836c2c4ad8489b9ab2","url":"https://api.github.com/users/roha4000","html_url":"https://github.com/roha4000","followers_url":"https://api.github.com/users/roha4000/followers","following_url":"https://api.github.com/users/roha4000/following{/other_user}","gists_url":"https://api.github.com/users/roha4000/gists{/gist_id}","starred_url":"https://api.github.com/users/roha4000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roha4000/subscriptions","organizations_url":"https://api.github.com/users/roha4000/orgs","repos_url":"https://api.github.com/users/roha4000/repos","events_url":"https://api.github.com/users/roha4000/events{/privacy}","received_events_url":"https://api.github.com/users/roha4000/received_events","type":"user","site_admin":false},"labels":[{"url":"https://api.github.com/repos/owncloud/core/labels/v5.x","name":"v5.x","color":"ededed"}],"state":"closed","assignee":{"login":"schiesbn","id":1589737,"avatar_url":"https://gravatar.com/avatar/8912b598c7b32dd25b87fd168e0b06b2?d=https%3a%2f%2fidenticons.github.com%2f0a323047dbe8329db30eae8dbe96e55e.png&r=x","gravatar_id":"8912b598c7b32dd25b87fd168e0b06b2","url":"https://api.github.com/users/schiesbn","html_url":"https://github.com/schiesbn","followers_url":"https://api.github.com/users/schiesbn/followers","following_url":"https://api.github.com/users/schiesbn/following{/other_user}","gists_url":"https://api.github.com/users/schiesbn/gists{/gist_id}","starred_url":"https://api.github.com/users/schiesbn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/schiesbn/subscriptions","organizations_url":"https://api.github.com/users/schiesbn/orgs","repos_url":"https://api.github.com/users/schiesbn/repos","events_url":"https://api.github.com/users/schiesbn/events{/privacy}","received_events_url":"https://api.github.com/users/schiesbn/received_events","type":"user","site_admin":false},"milestone":{"url":"https://api.github.com/repos/owncloud/core/milestones/3","labels_url":"https://api.github.com/repos/owncloud/core/milestones/3/labels","id":199679,"number":3,"title":"owncloud 6","description":"","creator":{"login":"lukasreschke","id":878997,"avatar_url":"https://gravatar.com/avatar/f080e75d370a4d8e550983a4898bcf3b?d=https%3a%2f%2fidenticons.github.com%2ff12e47d5bb5359a9f58e8217413be790.png&r=x","gravatar_id":"f080e75d370a4d8e550983a4898bcf3b","url":"https://api.github.com/users/lukasreschke","html_url":"https://github.com/lukasreschke","followers_url":"https://api.github.com/users/lukasreschke/followers","following_url":"https://api.github.com/users/lukasreschke/following{/other_user}","gists_url":"https://api.github.com/users/lukasreschke/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasreschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasreschke/subscriptions","organizations_url":"https://api.github.com/users/lukasreschke/orgs","repos_url":"https://api.github.com/users/lukasreschke/repos","events_url":"https://api.github.com/users/lukasreschke/events{/privacy}","received_events_url":"https://api.github.com/users/lukasreschke/received_events","type":"user","site_admin":false},"open_issues":19,"closed_issues":645,"state":"open","created_at":"2012-10-22t21:38:51z","updated_at":"2013-12-18t11:11:18z","due_on":null},"comments":31,"created_at":"2013-09-26t10:25:41z","updated_at":"2013-11-04t10:03:24z","closed_at":"2013-10-21t15:53:27z","pull_request":{"html_url":null,"diff_url":null,"patch_url":null},"body":"\r\nwe recently updated from 5.010 to 5.0.11 and experienced severe performance issues since then. after some investigations it looks like some kind of bug but i could not locate the reason(s) so i finally downgraded to 5.0.10 after a week and everything works fine again.\r\n\r\n**webservers:**  10x redhat based apache webservers\r\nwe are running php 5.3 as mod_php so there are no separate php processes. everything is processed within the httpd processes.\r\nwe are using ldap as authentication backend.\r\n\r\n**database:** mysql galera cluster\r\n\r\n## symptoms\r\n * httpd processes consumed a lot of cpu\r\n * httpd processes had eaten up memory up to memory_limit an finally php crashed with \"allowed memory size exhausted\"\r\n * since ram get rare the webservers started to swap resulting in high iowait\r\n * not all webservers where affected all the time. sometimes just one or two got stressed but sometimes also all servers.\r\n\r\n## investigating the issue\r\nin the owncloud log i found hundreds of entries like this:\r\n```\r\nowncloud[6355]: {php} allowed memory size of [...] bytes exhausted (tried to allocate 8208 bytes) at [...]/apps/user_ldap/lib/connection.php#177\r\nowncloud[29723]: php fatal error:  allowed memory size of [...] bytes exhausted (tried to allocate 523800 bytes) in [...]/lib/db.php on line 365\r\n```\r\nboth locations are handling  database connections.\r\ni straced a httpd process on an affected server. the process seemed to be in a loop and send over and over again the same sql-query with the same user name:\r\n```\r\nselect * from  oc_users where lower(`uid`) = lower('<user1>');\r\nselect count(*) from  oc_users where lower(`uid`) = lower('<user1>') limit 3;\r\n```\r\ni greped the oc code for those queries but only found a match for the first one in lib/user/database.php:240 within the userexists($uid) function.\r\n\r\n## conclusions so far\r\nit seems to me that with 5.0.11 in some situations and / or for some users a loop is not exiting where \"userexists()\" is called. the loop runs until the memory_limit is reached and than crashes. this is not happening all the time but i cannot say if it is bound to some specific users or actions. it mainly occurs on those server dealing with sync client requests. (we have separate webserver for browser and sync client requests)\r\n\r\n\r\n**does anybody has some ideas why and / or where such a loop could be started?**\r\n\r\nthanks\r\nroland hager","closed_by":{"login":"schiesbn","id":1589737,"avatar_url":"https://gravatar.com/avatar/8912b598c7b32dd25b87fd168e0b06b2?d=https%3a%2f%2fidenticons.github.com%2f0a323047dbe8329db30eae8dbe96e55e.png&r=x","gravatar_id":"8912b598c7b32dd25b87fd168e0b06b2","url":"https://api.github.com/users/schiesbn","html_url":"https://github.com/schiesbn","followers_url":"https://api.github.com/users/schiesbn/followers","following_url":"https://api.github.com/users/schiesbn/following{/other_user}","gists_url":"https://api.github.com/users/schiesbn/gists{/gist_id}","starred_url":"https://api.github.com/users/schiesbn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/schiesbn/subscriptions","organizations_url":"https://api.github.com/users/schiesbn/orgs","repos_url":"https://api.github.com/users/schiesbn/repos","events_url":"https://api.github.com/users/schiesbn/events{/privacy}","received_events_url":"https://api.github.com/users/schiesbn/received_events","type":"user","site_admin":false}}